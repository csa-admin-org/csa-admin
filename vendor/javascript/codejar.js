// codejar@4.3.0 downloaded from https://ga.jspm.io/npm:codejar@4.3.0/dist/codejar.js

const t=window;function e(e,n,o={}){const r={tab:"\t",indentOn:/[({\[]$/,moveToNewLine:/^[)}\]]/,spellcheck:false,catchTab:true,preserveIdent:true,addClosing:true,history:true,window:t,autoclose:{open:"([{'\"",close:")]}'\""},...o};const s=r.window;const i=s.document;const c=[];const a=[];let l=-1;let d=false;let f=()=>{};let u;e.setAttribute("contenteditable","plaintext-only");e.setAttribute("spellcheck",r.spellcheck?"true":"false");e.style.outline="none";e.style.overflowWrap="break-word";e.style.overflowY="auto";e.style.whiteSpace="pre-wrap";const p=(t,e)=>{n(t,e)};const h=s.navigator.userAgent.match(/Firefox\/([0-9]+)\./);const g=h?parseInt(h[1]):0;let y=false;(e.contentEditable!=="plaintext-only"||g>=136)&&(y=true);y&&e.setAttribute("contenteditable","true");const N=U((()=>{const t=b();p(e,t);x(t)}),30);let m=false;const C=t=>!R(t)&&!_(t)&&t.key!=="Meta"&&t.key!=="Control"&&t.key!=="Alt"&&!t.key.startsWith("Arrow");const T=U((t=>{if(C(t)){D();m=false}}),300);const E=(t,n)=>{c.push([t,n]);e.addEventListener(t,n)};E("keydown",(t=>{if(!t.defaultPrevented){u=X();r.preserveIdent?O(t):M(t);r.catchTab&&S(t);r.addClosing&&L(t);if(r.history){A(t);if(C(t)&&!m){D();m=true}}y&&!I(t)&&x(b())}}));E("keyup",(t=>{if(!t.defaultPrevented&&!t.isComposing){u!==X()&&N();T(t);f(X())}}));E("focus",(t=>{d=true}));E("blur",(t=>{d=false}));E("paste",(t=>{D();B(t);D();f(X())}));E("cut",(t=>{D();H(t);D();f(X())}));function b(){const t=j();const n={start:0,end:0,dir:void 0};let{anchorNode:o,anchorOffset:r,focusNode:s,focusOffset:c}=t;if(!o||!s)throw"error1";if(o===e&&s===e){n.start=r>0&&e.textContent?e.textContent.length:0;n.end=c>0&&e.textContent?e.textContent.length:0;n.dir=c>=r?"->":"<-";return n}if(o.nodeType===Node.ELEMENT_NODE){const t=i.createTextNode("");o.insertBefore(t,o.childNodes[r]);o=t;r=0}if(s.nodeType===Node.ELEMENT_NODE){const t=i.createTextNode("");s.insertBefore(t,s.childNodes[c]);s=t;c=0}K(e,(t=>{if(t===o&&t===s){n.start+=r;n.end+=c;n.dir=r<=c?"->":"<-";return"stop"}if(t===o){n.start+=r;if(n.dir)return"stop";n.dir="->"}else if(t===s){n.end+=c;if(n.dir)return"stop";n.dir="<-"}if(t.nodeType===Node.TEXT_NODE){n.dir!="->"&&(n.start+=t.nodeValue.length);n.dir!="<-"&&(n.end+=t.nodeValue.length)}}));e.normalize();return n}function x(t){const n=j();let o,r=0;let s,c=0;t.dir||(t.dir="->");t.start<0&&(t.start=0);t.end<0&&(t.end=0);if(t.dir=="<-"){const{start:e,end:n}=t;t.start=n;t.end=e}let a=0;K(e,(e=>{if(e.nodeType!==Node.TEXT_NODE)return;const n=(e.nodeValue||"").length;if(a+n>t.start){if(!o){o=e;r=t.start-a}if(a+n>t.end){s=e;c=t.end-a;return"stop"}}a+=n}));o||(o=e,r=e.childNodes.length);s||(s=e,c=e.childNodes.length);t.dir=="<-"&&([o,r,s,c]=[s,c,o,r]);{const t=w(o);if(t){const e=i.createTextNode("");t.parentNode?.insertBefore(e,t);o=e;r=0}const e=w(s);if(e){const t=i.createTextNode("");e.parentNode?.insertBefore(t,e);s=t;c=0}}n.setBaseAndExtent(o,r,s,c);e.normalize()}function w(t){while(t&&t!==e){if(t.nodeType===Node.ELEMENT_NODE){const e=t;if(e.getAttribute("contenteditable")=="false")return e}t=t.parentNode}}function k(){const t=j();const n=t.getRangeAt(0);const o=i.createRange();o.selectNodeContents(e);o.setEnd(n.startContainer,n.startOffset);return o.toString()}function v(){const t=j();const n=t.getRangeAt(0);const o=i.createRange();o.selectNodeContents(e);o.setStart(n.endContainer,n.endOffset);return o.toString()}function O(t){if(t.key==="Enter"){const e=k();const n=v();let[o]=W(e);let s=o;r.indentOn.test(e)&&(s+=r.tab);if(s.length>0){Z(t);t.stopPropagation();z("\n"+s)}else M(t);if(s!==o&&r.moveToNewLine.test(n)){const t=b();z("\n"+o);x(t)}}}function M(t){if(y&&t.key==="Enter"){Z(t);t.stopPropagation();if(v()==""){z("\n ");const t=b();t.start=--t.end;x(t)}else z("\n")}}function L(t){const e=r.autoclose.open;const n=r.autoclose.close;if(e.includes(t.key)){Z(t);const o=b();const r=o.start==o.end?"":j().toString();const s=t.key+r+(n[e.indexOf(t.key)]??"");z(s);o.start++;o.end++;x(o)}}function S(t){if(t.key==="Tab"){Z(t);if(t.shiftKey){const t=k();let[e,n]=W(t);if(e.length>0){const t=b();const o=Math.min(r.tab.length,e.length);x({start:n,end:n+o});i.execCommand("delete");t.start-=o;t.end-=o;x(t)}}else z(r.tab)}}function A(t){if(R(t)){Z(t);l--;const n=a[l];if(n){e.innerHTML=n.html;x(n.pos)}l<0&&(l=0)}if(_(t)){Z(t);l++;const n=a[l];if(n){e.innerHTML=n.html;x(n.pos)}l>=a.length&&l--}}function D(){if(!d)return;const t=e.innerHTML;const n=b();const o=a[l];if(o&&o.html===t&&o.pos.start===n.start&&o.pos.end===n.end)return;l++;a[l]={html:t,pos:n};a.splice(l+1);const r=300;if(l>r){l=r;a.splice(0,1)}}function B(t){if(t.defaultPrevented)return;Z(t);const n=t.originalEvent??t;const o=n.clipboardData.getData("text/plain").replace(/\r\n?/g,"\n");const r=b();z(o);p(e);x({start:Math.min(r.start,r.end)+o.length,end:Math.min(r.start,r.end)+o.length,dir:"<-"})}function H(t){const n=b();const o=j();const r=t.originalEvent??t;r.clipboardData.setData("text/plain",o.toString());i.execCommand("delete");p(e);x({start:Math.min(n.start,n.end),end:Math.min(n.start,n.end),dir:"<-"});Z(t)}function K(t,e){const n=[];t.firstChild&&n.push(t.firstChild);let o=n.pop();while(o){if(e(o)==="stop")break;o.nextSibling&&n.push(o.nextSibling);o.firstChild&&n.push(o.firstChild);o=n.pop()}}function P(t){return t.metaKey||t.ctrlKey}function R(t){return P(t)&&!t.shiftKey&&V(t)==="Z"}function _(t){return P(t)&&t.shiftKey&&V(t)==="Z"}function I(t){return P(t)&&V(t)==="C"}function V(t){let e=t.key||t.keyCode||t.which;if(e)return(typeof e==="string"?e:String.fromCharCode(e)).toUpperCase()}function z(t){t=t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");i.execCommand("insertHTML",false,t)}function U(t,e){let n=0;return(...o)=>{clearTimeout(n);n=s.setTimeout((()=>t(...o)),e)}}function W(t){let e=t.length-1;while(e>=0&&t[e]!=="\n")e--;e++;let n=e;while(n<t.length&&/[ \t]/.test(t[n]))n++;return[t.substring(e,n)||"",e,n]}function X(){return e.textContent||""}function Z(t){t.preventDefault()}function j(){return e.getRootNode().getSelection()}return{updateOptions(t){Object.assign(r,t)},updateCode(t,n=true){e.textContent=t;p(e);n&&f(t)},onUpdate(t){f=t},toString:X,save:b,restore:x,recordHistory:D,destroy(){for(let[t,n]of c)e.removeEventListener(t,n)}}}export{e as CodeJar};

