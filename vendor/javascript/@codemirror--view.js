// @codemirror/view@6.35.0 downloaded from https://ga.jspm.io/npm:@codemirror/view@6.35.0/dist/index.js

import{Text as t,RangeValue as e,RangeSet as i,MapMode as s,findClusterBreak as o,EditorSelection as n,Facet as r,StateEffect as l,ChangeSet as a,findColumn as h,CharCategory as c,EditorState as d,Annotation as u,Transaction as f,Prec as p,codePointAt as g,codePointSize as m,combineConfig as w,StateField as v,RangeSetBuilder as b,countColumn as y}from"@codemirror/state";import{StyleModule as x}from"style-mod";import{keyName as S,base as M,shift as C}from"w3c-keyname";function getSelection(t){let e;e=t.nodeType==11?t.getSelection?t:t.ownerDocument:t;return e.getSelection()}function contains(t,e){return!!e&&(t==e||t.contains(e.nodeType!=1?e.parentNode:e))}function hasSelection(t,e){if(!e.anchorNode)return false;try{return contains(t,e.anchorNode)}catch(t){return false}}function clientRectsFor(t){return t.nodeType==3?textRange(t,0,t.nodeValue.length).getClientRects():t.nodeType==1?t.getClientRects():[]}function isEquivalentPosition(t,e,i,s){return!!i&&(scanFor(t,e,i,s,-1)||scanFor(t,e,i,s,1))}function domIndex(t){for(var e=0;;e++){t=t.previousSibling;if(!t)return e}}function isBlockElement(t){return t.nodeType==1&&/^(DIV|P|LI|UL|OL|BLOCKQUOTE|DD|DT|H\d|SECTION|PRE)$/.test(t.nodeName)}function scanFor(t,e,i,s,o){for(;;){if(t==i&&e==s)return true;if(e==(o<0?0:maxOffset(t))){if(t.nodeName=="DIV")return false;let i=t.parentNode;if(!i||i.nodeType!=1)return false;e=domIndex(t)+(o<0?0:1);t=i}else{if(t.nodeType!=1)return false;t=t.childNodes[e+(o<0?-1:0)];if(t.nodeType==1&&t.contentEditable=="false")return false;e=o<0?maxOffset(t):0}}}function maxOffset(t){return t.nodeType==3?t.nodeValue.length:t.childNodes.length}function flattenRect(t,e){let i=e?t.left:t.right;return{left:i,right:i,top:t.top,bottom:t.bottom}}function windowRect(t){let e=t.visualViewport;return e?{left:0,right:e.width,top:0,bottom:e.height}:{left:0,right:t.innerWidth,top:0,bottom:t.innerHeight}}function getScale(t,e){let i=e.width/t.offsetWidth;let s=e.height/t.offsetHeight;(i>.995&&i<1.005||!isFinite(i)||Math.abs(e.width-t.offsetWidth)<1)&&(i=1);(s>.995&&s<1.005||!isFinite(s)||Math.abs(e.height-t.offsetHeight)<1)&&(s=1);return{scaleX:i,scaleY:s}}function scrollRectIntoView(t,e,i,s,o,n,r,l){let a=t.ownerDocument,h=a.defaultView||window;for(let c=t,d=false;c&&!d;)if(c.nodeType==1){let t,u=c==a.body;let f=1,p=1;if(u)t=windowRect(h);else{/^(fixed|sticky)$/.test(getComputedStyle(c).position)&&(d=true);if(c.scrollHeight<=c.clientHeight&&c.scrollWidth<=c.clientWidth){c=c.assignedSlot||c.parentNode;continue}let e=c.getBoundingClientRect();({scaleX:f,scaleY:p}=getScale(c,e));t={left:e.left,right:e.left+c.clientWidth*f,top:e.top,bottom:e.top+c.clientHeight*p}}let g=0,m=0;if(o=="nearest"){if(e.top<t.top){m=-(t.top-e.top+r);i>0&&e.bottom>t.bottom+m&&(m=e.bottom-t.bottom+m+r)}else if(e.bottom>t.bottom){m=e.bottom-t.bottom+r;i<0&&e.top-m<t.top&&(m=-(t.top+m-e.top+r))}}else{let s=e.bottom-e.top,n=t.bottom-t.top;let l=o=="center"&&s<=n?e.top+s/2-n/2:o=="start"||o=="center"&&i<0?e.top-r:e.bottom-n+r;m=l-t.top}if(s=="nearest"){if(e.left<t.left){g=-(t.left-e.left+n);i>0&&e.right>t.right+g&&(g=e.right-t.right+g+n)}else if(e.right>t.right){g=e.right-t.right+n;i<0&&e.left<t.left+g&&(g=-(t.left+g-e.left+n))}}else{let i=s=="center"?e.left+(e.right-e.left)/2-(t.right-t.left)/2:s=="start"==l?e.left-n:e.right-(t.right-t.left)+n;g=i-t.left}if(g||m)if(u)h.scrollBy(g,m);else{let t=0,i=0;if(m){let t=c.scrollTop;c.scrollTop+=m/p;i=(c.scrollTop-t)*p}if(g){let e=c.scrollLeft;c.scrollLeft+=g/f;t=(c.scrollLeft-e)*f}e={left:e.left-t,top:e.top-i,right:e.right-t,bottom:e.bottom-i};t&&Math.abs(t-g)<1&&(s="nearest");i&&Math.abs(i-m)<1&&(o="nearest")}if(u)break;c=c.assignedSlot||c.parentNode}else{if(c.nodeType!=11)break;c=c.host}}function scrollableParents(t){let e,i,s=t.ownerDocument;for(let o=t.parentNode;o;){if(o==s.body||e&&i)break;if(o.nodeType==1){!i&&o.scrollHeight>o.clientHeight&&(i=o);!e&&o.scrollWidth>o.clientWidth&&(e=o);o=o.assignedSlot||o.parentNode}else{if(o.nodeType!=11)break;o=o.host}}return{x:e,y:i}}class DOMSelectionState{constructor(){this.anchorNode=null;this.anchorOffset=0;this.focusNode=null;this.focusOffset=0}eq(t){return this.anchorNode==t.anchorNode&&this.anchorOffset==t.anchorOffset&&this.focusNode==t.focusNode&&this.focusOffset==t.focusOffset}setRange(t){let{anchorNode:e,focusNode:i}=t;this.set(e,Math.min(t.anchorOffset,e?maxOffset(e):0),i,Math.min(t.focusOffset,i?maxOffset(i):0))}set(t,e,i,s){this.anchorNode=t;this.anchorOffset=e;this.focusNode=i;this.focusOffset=s}}let k=null;function focusPreventScroll(t){if(t.setActive)return t.setActive();if(k)return t.focus(k);let e=[];for(let i=t;i;i=i.parentNode){e.push(i,i.scrollTop,i.scrollLeft);if(i==i.ownerDocument)break}t.focus(k==null?{get preventScroll(){k={preventScroll:true};return true}}:void 0);if(!k){k=false;for(let t=0;t<e.length;){let i=e[t++],s=e[t++],o=e[t++];i.scrollTop!=s&&(i.scrollTop=s);i.scrollLeft!=o&&(i.scrollLeft=o)}}}let A;function textRange(t,e,i=e){let s=A||(A=document.createRange());s.setEnd(t,i);s.setStart(t,e);return s}function dispatchKey(t,e,i,s){let o={key:e,code:e,keyCode:i,which:i,cancelable:true};s&&({altKey:o.altKey,ctrlKey:o.ctrlKey,shiftKey:o.shiftKey,metaKey:o.metaKey}=s);let n=new KeyboardEvent("keydown",o);n.synthetic=true;t.dispatchEvent(n);let r=new KeyboardEvent("keyup",o);r.synthetic=true;t.dispatchEvent(r);return n.defaultPrevented||r.defaultPrevented}function getRoot(t){while(t){if(t&&(t.nodeType==9||t.nodeType==11&&t.host))return t;t=t.assignedSlot||t.parentNode}return null}function clearAttributes(t){while(t.attributes.length)t.removeAttributeNode(t.attributes[0])}function atElementStart(t,e){let i=e.focusNode,s=e.focusOffset;if(!i||e.anchorNode!=i||e.anchorOffset!=s)return false;s=Math.min(s,maxOffset(i));for(;;)if(s){if(i.nodeType!=1)return false;let t=i.childNodes[s-1];if(t.contentEditable=="false")s--;else{i=t;s=maxOffset(i)}}else{if(i==t)return true;s=domIndex(i);i=i.parentNode}}function isScrolledToBottom(t){return t.scrollTop>Math.max(1,t.scrollHeight-t.clientHeight-4)}function textNodeBefore(t,e){for(let i=t,s=e;;){if(i.nodeType==3&&s>0)return{node:i,offset:s};if(i.nodeType==1&&s>0){if(i.contentEditable=="false")return null;i=i.childNodes[s-1];s=maxOffset(i)}else{if(!i.parentNode||isBlockElement(i))return null;s=domIndex(i);i=i.parentNode}}}function textNodeAfter(t,e){for(let i=t,s=e;;){if(i.nodeType==3&&s<i.nodeValue.length)return{node:i,offset:s};if(i.nodeType==1&&s<i.childNodes.length){if(i.contentEditable=="false")return null;i=i.childNodes[s];s=0}else{if(!i.parentNode||isBlockElement(i))return null;s=domIndex(i)+1;i=i.parentNode}}}class DOMPos{constructor(t,e,i=true){this.node=t;this.offset=e;this.precise=i}static before(t,e){return new DOMPos(t.parentNode,domIndex(t),e)}static after(t,e){return new DOMPos(t.parentNode,domIndex(t)+1,e)}}const D=[];class ContentView{constructor(){this.parent=null;this.dom=null;this.flags=2}get overrideDOMText(){return null}get posAtStart(){return this.parent?this.parent.posBefore(this):0}get posAtEnd(){return this.posAtStart+this.length}posBefore(t){let e=this.posAtStart;for(let i of this.children){if(i==t)return e;e+=i.length+i.breakAfter}throw new RangeError("Invalid child in posBefore")}posAfter(t){return this.posBefore(t)+t.length}sync(t,e){if(this.flags&2){let i=this.dom;let s,o=null;for(let n of this.children){if(n.flags&7){if(!n.dom&&(s=o?o.nextSibling:i.firstChild)){let t=ContentView.get(s);(!t||!t.parent&&t.canReuseDOM(n))&&n.reuseDOM(s)}n.sync(t,e);n.flags&=-8}s=o?o.nextSibling:i.firstChild;e&&!e.written&&e.node==i&&s!=n.dom&&(e.written=true);if(n.dom.parentNode==i)while(s&&s!=n.dom)s=rm$1(s);else i.insertBefore(n.dom,s);o=n.dom}s=o?o.nextSibling:i.firstChild;s&&e&&e.node==i&&(e.written=true);while(s)s=rm$1(s)}else if(this.flags&1)for(let i of this.children)if(i.flags&7){i.sync(t,e);i.flags&=-8}}reuseDOM(t){}localPosFromDOM(t,e){let i;if(t==this.dom)i=this.dom.childNodes[e];else{let s=maxOffset(t)==0?0:e==0?-1:1;for(;;){let e=t.parentNode;if(e==this.dom)break;s==0&&e.firstChild!=e.lastChild&&(s=t==e.firstChild?-1:1);t=e}i=s<0?t:t.nextSibling}if(i==this.dom.firstChild)return 0;while(i&&!ContentView.get(i))i=i.nextSibling;if(!i)return this.length;for(let t=0,e=0;;t++){let s=this.children[t];if(s.dom==i)return e;e+=s.length+s.breakAfter}}domBoundsAround(t,e,i=0){let s=-1,o=-1,n=-1,r=-1;for(let l=0,a=i,h=i;l<this.children.length;l++){let i=this.children[l],c=a+i.length;if(a<t&&c>e)return i.domBoundsAround(t,e,a);if(c>=t&&s==-1){s=l;o=a}if(a>e&&i.dom.parentNode==this.dom){n=l;r=h;break}h=c;a=c+i.breakAfter}return{from:o,to:r<0?i+this.length:r,startDOM:(s?this.children[s-1].dom.nextSibling:null)||this.dom.firstChild,endDOM:n<this.children.length&&n>=0?this.children[n].dom:null}}markDirty(t=false){this.flags|=2;this.markParentsDirty(t)}markParentsDirty(t){for(let e=this.parent;e;e=e.parent){t&&(e.flags|=2);if(e.flags&1)return;e.flags|=1;t=false}}setParent(t){if(this.parent!=t){this.parent=t;this.flags&7&&this.markParentsDirty(true)}}setDOM(t){if(this.dom!=t){this.dom&&(this.dom.cmView=null);this.dom=t;t.cmView=this}}get rootView(){for(let t=this;;){let e=t.parent;if(!e)return t;t=e}}replaceChildren(t,e,i=D){this.markDirty();for(let s=t;s<e;s++){let t=this.children[s];t.parent==this&&i.indexOf(t)<0&&t.destroy()}i.length<250?this.children.splice(t,e-t,...i):this.children=[].concat(this.children.slice(0,t),i,this.children.slice(e));for(let t=0;t<i.length;t++)i[t].setParent(this)}ignoreMutation(t){return false}ignoreEvent(t){return false}childCursor(t=this.length){return new ChildCursor(this.children,t,this.children.length)}childPos(t,e=1){return this.childCursor().findPos(t,e)}toString(){let t=this.constructor.name.replace("View","");return t+(this.children.length?"("+this.children.join()+")":this.length?"["+(t=="Text"?this.text:this.length)+"]":"")+(this.breakAfter?"#":"")}static get(t){return t.cmView}get isEditable(){return true}get isWidget(){return false}get isHidden(){return false}merge(t,e,i,s,o,n){return false}become(t){return false}canReuseDOM(t){return t.constructor==this.constructor&&!(8&(this.flags|t.flags))}getSide(){return 0}destroy(){for(let t of this.children)t.parent==this&&t.destroy();this.parent=null}}ContentView.prototype.breakAfter=0;function rm$1(t){let e=t.nextSibling;t.parentNode.removeChild(t);return e}class ChildCursor{constructor(t,e,i){this.children=t;this.pos=e;this.i=i;this.off=0}findPos(t,e=1){for(;;){if(t>this.pos||t==this.pos&&(e>0||this.i==0||this.children[this.i-1].breakAfter)){this.off=t-this.pos;return this}let i=this.children[--this.i];this.pos-=i.length+i.breakAfter}}}function replaceRange(t,e,i,s,o,n,r,l,a){let{children:h}=t;let c=h.length?h[e]:null;let d=n.length?n[n.length-1]:null;let u=d?d.breakAfter:r;if(!(e==s&&c&&!r&&!u&&n.length<2&&c.merge(i,o,n.length?d:null,i==0,l,a))){if(s<h.length){let t=h[s];if(t&&(o<t.length||t.breakAfter&&(d===null||d===void 0?void 0:d.breakAfter))){if(e==s){t=t.split(o);o=0}if(!u&&d&&t.merge(0,o,d,true,0,a))n[n.length-1]=t;else{(o||t.children.length&&!t.children[0].length)&&t.merge(0,o,null,false,0,a);n.push(t)}}else(t===null||t===void 0?void 0:t.breakAfter)&&(d?d.breakAfter=1:r=1);s++}if(c){c.breakAfter=r;if(i>0){!r&&n.length&&c.merge(i,c.length,n[0],false,l,0)?c.breakAfter=n.shift().breakAfter:(i<c.length||c.children.length&&c.children[c.children.length-1].length==0)&&c.merge(i,c.length,null,false,l,0);e++}}while(e<s&&n.length)if(h[s-1].become(n[n.length-1])){s--;n.pop();a=n.length?0:l}else{if(!h[e].become(n[0]))break;e++;n.shift();l=n.length?0:a}!n.length&&e&&s<h.length&&!h[e-1].breakAfter&&h[s].merge(0,0,h[e-1],false,l,a)&&e--;(e<s||n.length)&&t.replaceChildren(e,s,n)}}function mergeChildrenInto(t,e,i,s,o,n){let r=t.childCursor();let{i:l,off:a}=r.findPos(i,1);let{i:h,off:c}=r.findPos(e,-1);let d=e-i;for(let t of s)d+=t.length;t.length+=d;replaceRange(t,h,c,l,a,s,0,o,n)}let O=typeof navigator!="undefined"?navigator:{userAgent:"",vendor:"",platform:""};let T=typeof document!="undefined"?document:{documentElement:{style:{}}};const R=/Edge\/(\d+)/.exec(O.userAgent);const E=/MSIE \d/.test(O.userAgent);const V=/Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(O.userAgent);const B=!!(E||V||R);const P=!B&&/gecko\/(\d+)/i.test(O.userAgent);const L=!B&&/Chrome\/(\d+)/.exec(O.userAgent);const H="webkitFontSmoothing"in T.documentElement.style;const N=!B&&/Apple Computer/.test(O.vendor);const W=N&&(/Mobile\/\w+/.test(O.userAgent)||O.maxTouchPoints>2);var F={mac:W||/Mac/.test(O.platform),windows:/Win/.test(O.platform),linux:/Linux|X11/.test(O.platform),ie:B,ie_version:E?T.documentMode||6:V?+V[1]:R?+R[1]:0,gecko:P,gecko_version:P?+(/Firefox\/(\d+)/.exec(O.userAgent)||[0,0])[1]:0,chrome:!!L,chrome_version:L?+L[1]:0,ios:W,android:/Android\b/.test(O.userAgent),webkit:H,safari:N,webkit_version:H?+(/\bAppleWebKit\/(\d+)/.exec(O.userAgent)||[0,0])[1]:0,tabSize:T.documentElement.style.tabSize!=null?"tab-size":"-moz-tab-size"};const I=256;class TextView extends ContentView{constructor(t){super();this.text=t}get length(){return this.text.length}createDOM(t){this.setDOM(t||document.createTextNode(this.text))}sync(t,e){this.dom||this.createDOM();if(this.dom.nodeValue!=this.text){e&&e.node==this.dom&&(e.written=true);this.dom.nodeValue=this.text}}reuseDOM(t){t.nodeType==3&&this.createDOM(t)}merge(t,e,i){if(this.flags&8||i&&(!(i instanceof TextView)||this.length-(e-t)+i.length>I||i.flags&8))return false;this.text=this.text.slice(0,t)+(i?i.text:"")+this.text.slice(e);this.markDirty();return true}split(t){let e=new TextView(this.text.slice(t));this.text=this.text.slice(0,t);this.markDirty();e.flags|=this.flags&8;return e}localPosFromDOM(t,e){return t==this.dom?e:e?this.text.length:0}domAtPos(t){return new DOMPos(this.dom,t)}domBoundsAround(t,e,i){return{from:i,to:i+this.length,startDOM:this.dom,endDOM:this.dom.nextSibling}}coordsAt(t,e){return textCoords(this.dom,t,e)}}class MarkView extends ContentView{constructor(t,e=[],i=0){super();this.mark=t;this.children=e;this.length=i;for(let t of e)t.setParent(this)}setAttrs(t){clearAttributes(t);this.mark.class&&(t.className=this.mark.class);if(this.mark.attrs)for(let e in this.mark.attrs)t.setAttribute(e,this.mark.attrs[e]);return t}canReuseDOM(t){return super.canReuseDOM(t)&&!(8&(this.flags|t.flags))}reuseDOM(t){if(t.nodeName==this.mark.tagName.toUpperCase()){this.setDOM(t);this.flags|=6}}sync(t,e){this.dom?this.flags&4&&this.setAttrs(this.dom):this.setDOM(this.setAttrs(document.createElement(this.mark.tagName)));super.sync(t,e)}merge(t,e,i,s,o,n){if(i&&(!(i instanceof MarkView&&i.mark.eq(this.mark))||t&&o<=0||e<this.length&&n<=0))return false;mergeChildrenInto(this,t,e,i?i.children.slice():[],o-1,n-1);this.markDirty();return true}split(t){let e=[],i=0,s=-1,o=0;for(let n of this.children){let r=i+n.length;r>t&&e.push(i<t?n.split(t-i):n);s<0&&i>=t&&(s=o);i=r;o++}let n=this.length-t;this.length=t;if(s>-1){this.children.length=s;this.markDirty()}return new MarkView(this.mark,e,n)}domAtPos(t){return inlineDOMAtPos(this,t)}coordsAt(t,e){return coordsInChildren(this,t,e)}}function textCoords(t,e,i){let s=t.nodeValue.length;e>s&&(e=s);let o=e,n=e,r=0;if(e==0&&i<0||e==s&&i>=0){if(!(F.chrome||F.gecko))if(e){o--;r=1}else if(n<s){n++;r=-1}}else i<0?o--:n<s&&n++;let l=textRange(t,o,n).getClientRects();if(!l.length)return null;let a=l[(r?r<0:i>=0)?0:l.length-1];F.safari&&!r&&a.width==0&&(a=Array.prototype.find.call(l,(t=>t.width))||a);return r?flattenRect(a,r<0):a||null}class WidgetView extends ContentView{static create(t,e,i){return new WidgetView(t,e,i)}constructor(t,e,i){super();this.widget=t;this.length=e;this.side=i;this.prevWidget=null}split(t){let e=WidgetView.create(this.widget,this.length-t,this.side);this.length-=t;return e}sync(t){if(!this.dom||!this.widget.updateDOM(this.dom,t)){this.dom&&this.prevWidget&&this.prevWidget.destroy(this.dom);this.prevWidget=null;this.setDOM(this.widget.toDOM(t));this.widget.editable||(this.dom.contentEditable="false")}}getSide(){return this.side}merge(t,e,i,s,o,n){if(i&&(!(i instanceof WidgetView)||!this.widget.compare(i.widget)||t>0&&o<=0||e<this.length&&n<=0))return false;this.length=t+(i?i.length:0)+(this.length-e);return true}become(t){if(t instanceof WidgetView&&t.side==this.side&&this.widget.constructor==t.widget.constructor){this.widget.compare(t.widget)||this.markDirty(true);this.dom&&!this.prevWidget&&(this.prevWidget=this.widget);this.widget=t.widget;this.length=t.length;return true}return false}ignoreMutation(){return true}ignoreEvent(t){return this.widget.ignoreEvent(t)}get overrideDOMText(){if(this.length==0)return t.empty;let e=this;while(e.parent)e=e.parent;let{view:i}=e,s=i&&i.state.doc,o=this.posAtStart;return s?s.slice(o,o+this.length):t.empty}domAtPos(t){return(this.length?t==0:this.side>0)?DOMPos.before(this.dom):DOMPos.after(this.dom,t==this.length)}domBoundsAround(){return null}coordsAt(t,e){let i=this.widget.coordsAt(this.dom,t,e);if(i)return i;let s=this.dom.getClientRects(),o=null;if(!s.length)return null;let n=this.side?this.side<0:t>0;for(let e=n?s.length-1:0;;e+=n?-1:1){o=s[e];if(t>0?e==0:e==s.length-1||o.top<o.bottom)break}return flattenRect(o,!n)}get isEditable(){return false}get isWidget(){return true}get isHidden(){return this.widget.isHidden}destroy(){super.destroy();this.dom&&this.widget.destroy(this.dom)}}class WidgetBufferView extends ContentView{constructor(t){super();this.side=t}get length(){return 0}merge(){return false}become(t){return t instanceof WidgetBufferView&&t.side==this.side}split(){return new WidgetBufferView(this.side)}sync(){if(!this.dom){let t=document.createElement("img");t.className="cm-widgetBuffer";t.setAttribute("aria-hidden","true");this.setDOM(t)}}getSide(){return this.side}domAtPos(t){return this.side>0?DOMPos.before(this.dom):DOMPos.after(this.dom)}localPosFromDOM(){return 0}domBoundsAround(){return null}coordsAt(t){return this.dom.getBoundingClientRect()}get overrideDOMText(){return t.empty}get isHidden(){return true}}TextView.prototype.children=WidgetView.prototype.children=WidgetBufferView.prototype.children=D;function inlineDOMAtPos(t,e){let i=t.dom,{children:s}=t,o=0;for(let t=0;o<s.length;o++){let n=s[o],r=t+n.length;if(!(r==t&&n.getSide()<=0)){if(e>t&&e<r&&n.dom.parentNode==i)return n.domAtPos(e-t);if(e<=t)break;t=r}}for(let t=o;t>0;t--){let e=s[t-1];if(e.dom.parentNode==i)return e.domAtPos(e.length)}for(let t=o;t<s.length;t++){let e=s[t];if(e.dom.parentNode==i)return e.domAtPos(0)}return new DOMPos(i,0)}function joinInlineInto(t,e,i){let s,{children:o}=t;if(i>0&&e instanceof MarkView&&o.length&&(s=o[o.length-1])instanceof MarkView&&s.mark.eq(e.mark))joinInlineInto(s,e.children[0],i-1);else{o.push(e);e.setParent(t)}t.length+=e.length}function coordsInChildren(t,e,i){let s=null,o=-1,n=null,r=-1;function scan(t,e){for(let l=0,a=0;l<t.children.length&&a<=e;l++){let h=t.children[l],c=a+h.length;if(c>=e)if(h.children.length)scan(h,e-a);else if((!n||n.isHidden&&i>0)&&(c>e||a==c&&h.getSide()>0)){n=h;r=e-a}else if(a<e||a==c&&h.getSide()<0&&!h.isHidden){s=h;o=e-a}a=c}}scan(t,e);let l=(i<0?s:n)||s||n;return l?l.coordsAt(Math.max(0,l==s?o:r),i):fallbackRect(t)}function fallbackRect(t){let e=t.dom.lastChild;if(!e)return t.dom.getBoundingClientRect();let i=clientRectsFor(e);return i[i.length-1]||null}function combineAttrs(t,e){for(let i in t)i=="class"&&e.class?e.class+=" "+t.class:i=="style"&&e.style?e.style+=";"+t.style:e[i]=t[i];return e}const z=Object.create(null);function attrsEq(t,e,i){if(t==e)return true;t||(t=z);e||(e=z);let s=Object.keys(t),o=Object.keys(e);if(s.length-(i&&s.indexOf(i)>-1?1:0)!=o.length-(i&&o.indexOf(i)>-1?1:0))return false;for(let n of s)if(n!=i&&(o.indexOf(n)==-1||t[n]!==e[n]))return false;return true}function updateAttrs(t,e,i){let s=false;if(e)for(let o in e)if(!(i&&o in i)){s=true;o=="style"?t.style.cssText="":t.removeAttribute(o)}if(i)for(let o in i)if(!(e&&e[o]==i[o])){s=true;o=="style"?t.style.cssText=i[o]:t.setAttribute(o,i[o])}return s}function getAttrs(t){let e=Object.create(null);for(let i=0;i<t.attributes.length;i++){let s=t.attributes[i];e[s.name]=s.value}return e}class WidgetType{eq(t){return false}updateDOM(t,e){return false}compare(t){return this==t||this.constructor==t.constructor&&this.eq(t)}get estimatedHeight(){return-1}get lineBreaks(){return 0}ignoreEvent(t){return true}coordsAt(t,e,i){return null}get isHidden(){return false}get editable(){return false}destroy(t){}}var q=function(t){t[t.Text=0]="Text";t[t.WidgetBefore=1]="WidgetBefore";t[t.WidgetAfter=2]="WidgetAfter";t[t.WidgetRange=3]="WidgetRange";return t}(q||(q={}));class Decoration extends e{constructor(t,e,i,s){super();this.startSide=t;this.endSide=e;this.widget=i;this.spec=s}get heightRelevant(){return false}static mark(t){return new MarkDecoration(t)}static widget(t){let e=Math.max(-1e4,Math.min(1e4,t.side||0)),i=!!t.block;e+=i&&!t.inlineOrder?e>0?3e8:-4e8:e>0?1e8:-1e8;return new PointDecoration(t,e,e,i,t.widget||null,false)}static replace(t){let e,i,s=!!t.block;if(t.isBlockGap){e=-5e8;i=4e8}else{let{start:o,end:n}=getInclusive(t,s);e=(o?s?-3e8:-1:5e8)-1;i=1+(n?s?2e8:1:-6e8)}return new PointDecoration(t,e,i,s,t.widget||null,true)}static line(t){return new LineDecoration(t)}static set(t,e=false){return i.of(t,e)}hasHeight(){return!!this.widget&&this.widget.estimatedHeight>-1}}Decoration.none=i.empty;class MarkDecoration extends Decoration{constructor(t){let{start:e,end:i}=getInclusive(t);super(e?-1:5e8,i?1:-6e8,null,t);this.tagName=t.tagName||"span";this.class=t.class||"";this.attrs=t.attributes||null}eq(t){var e,i;return this==t||t instanceof MarkDecoration&&this.tagName==t.tagName&&(this.class||((e=this.attrs)===null||e===void 0?void 0:e.class))==(t.class||((i=t.attrs)===null||i===void 0?void 0:i.class))&&attrsEq(this.attrs,t.attrs,"class")}range(t,e=t){if(t>=e)throw new RangeError("Mark decorations may not be empty");return super.range(t,e)}}MarkDecoration.prototype.point=false;class LineDecoration extends Decoration{constructor(t){super(-2e8,-2e8,null,t)}eq(t){return t instanceof LineDecoration&&this.spec.class==t.spec.class&&attrsEq(this.spec.attributes,t.spec.attributes)}range(t,e=t){if(e!=t)throw new RangeError("Line decoration ranges must be zero-length");return super.range(t,e)}}LineDecoration.prototype.mapMode=s.TrackBefore;LineDecoration.prototype.point=true;class PointDecoration extends Decoration{constructor(t,e,i,o,n,r){super(e,i,n,t);this.block=o;this.isReplace=r;this.mapMode=o?e<=0?s.TrackBefore:s.TrackAfter:s.TrackDel}get type(){return this.startSide!=this.endSide?q.WidgetRange:this.startSide<=0?q.WidgetBefore:q.WidgetAfter}get heightRelevant(){return this.block||!!this.widget&&(this.widget.estimatedHeight>=5||this.widget.lineBreaks>0)}eq(t){return t instanceof PointDecoration&&widgetsEq(this.widget,t.widget)&&this.block==t.block&&this.startSide==t.startSide&&this.endSide==t.endSide}range(t,e=t){if(this.isReplace&&(t>e||t==e&&this.startSide>0&&this.endSide<=0))throw new RangeError("Invalid range for replacement decoration");if(!this.isReplace&&e!=t)throw new RangeError("Widget decorations can only have zero-length ranges");return super.range(t,e)}}PointDecoration.prototype.point=true;function getInclusive(t,e=false){let{inclusiveStart:i,inclusiveEnd:s}=t;i==null&&(i=t.inclusive);s==null&&(s=t.inclusive);return{start:i!==null&&i!==void 0?i:e,end:s!==null&&s!==void 0?s:e}}function widgetsEq(t,e){return t==e||!!(t&&e&&t.compare(e))}function addRange(t,e,i,s=0){let o=i.length-1;o>=0&&i[o]+s>=t?i[o]=Math.max(i[o],e):i.push(t,e)}class LineView extends ContentView{constructor(){super(...arguments);this.children=[];this.length=0;this.prevAttrs=void 0;this.attrs=null;this.breakAfter=0}merge(t,e,i,s,o,n){if(i){if(!(i instanceof LineView))return false;this.dom||i.transferDOM(this)}s&&this.setDeco(i?i.attrs:null);mergeChildrenInto(this,t,e,i?i.children.slice():[],o,n);return true}split(t){let e=new LineView;e.breakAfter=this.breakAfter;if(this.length==0)return e;let{i:i,off:s}=this.childPos(t);if(s){e.append(this.children[i].split(s),0);this.children[i].merge(s,this.children[i].length,null,false,0,0);i++}for(let t=i;t<this.children.length;t++)e.append(this.children[t],0);while(i>0&&this.children[i-1].length==0)this.children[--i].destroy();this.children.length=i;this.markDirty();this.length=t;return e}transferDOM(t){if(this.dom){this.markDirty();t.setDOM(this.dom);t.prevAttrs=this.prevAttrs===void 0?this.attrs:this.prevAttrs;this.prevAttrs=void 0;this.dom=null}}setDeco(t){if(!attrsEq(this.attrs,t)){if(this.dom){this.prevAttrs=this.attrs;this.markDirty()}this.attrs=t}}append(t,e){joinInlineInto(this,t,e)}addLineDeco(t){let e=t.spec.attributes,i=t.spec.class;e&&(this.attrs=combineAttrs(e,this.attrs||{}));i&&(this.attrs=combineAttrs({class:i},this.attrs||{}))}domAtPos(t){return inlineDOMAtPos(this,t)}reuseDOM(t){if(t.nodeName=="DIV"){this.setDOM(t);this.flags|=6}}sync(t,e){var i;if(this.dom){if(this.flags&4){clearAttributes(this.dom);this.dom.className="cm-line";this.prevAttrs=this.attrs?null:void 0}}else{this.setDOM(document.createElement("div"));this.dom.className="cm-line";this.prevAttrs=this.attrs?null:void 0}if(this.prevAttrs!==void 0){updateAttrs(this.dom,this.prevAttrs,this.attrs);this.dom.classList.add("cm-line");this.prevAttrs=void 0}super.sync(t,e);let s=this.dom.lastChild;while(s&&ContentView.get(s)instanceof MarkView)s=s.lastChild;if(!s||!this.length||s.nodeName!="BR"&&((i=ContentView.get(s))===null||i===void 0?void 0:i.isEditable)==false&&(!F.ios||!this.children.some((t=>t instanceof TextView)))){let t=document.createElement("BR");t.cmIgnore=true;this.dom.appendChild(t)}}measureTextSize(){if(this.children.length==0||this.length>20)return null;let t,e=0;for(let i of this.children){if(!(i instanceof TextView)||/[^ -~]/.test(i.text))return null;let s=clientRectsFor(i.dom);if(s.length!=1)return null;e+=s[0].width;t=s[0].height}return e?{lineHeight:this.dom.getBoundingClientRect().height,charWidth:e/this.length,textHeight:t}:null}coordsAt(t,e){let i=coordsInChildren(this,t,e);if(!this.children.length&&i&&this.parent){let{heightOracle:t}=this.parent.view.viewState,e=i.bottom-i.top;if(Math.abs(e-t.lineHeight)<2&&t.textHeight<e){let s=(e-t.textHeight)/2;return{top:i.top+s,bottom:i.bottom-s,left:i.left,right:i.left}}}return i}become(t){return t instanceof LineView&&this.children.length==0&&t.children.length==0&&attrsEq(this.attrs,t.attrs)&&this.breakAfter==t.breakAfter}covers(){return true}static find(t,e){for(let i=0,s=0;i<t.children.length;i++){let o=t.children[i],n=s+o.length;if(n>=e){if(o instanceof LineView)return o;if(n>e)break}s=n+o.breakAfter}return null}}class BlockWidgetView extends ContentView{constructor(t,e,i){super();this.widget=t;this.length=e;this.deco=i;this.breakAfter=0;this.prevWidget=null}merge(t,e,i,s,o,n){if(i&&(!(i instanceof BlockWidgetView)||!this.widget.compare(i.widget)||t>0&&o<=0||e<this.length&&n<=0))return false;this.length=t+(i?i.length:0)+(this.length-e);return true}domAtPos(t){return t==0?DOMPos.before(this.dom):DOMPos.after(this.dom,t==this.length)}split(t){let e=this.length-t;this.length=t;let i=new BlockWidgetView(this.widget,e,this.deco);i.breakAfter=this.breakAfter;return i}get children(){return D}sync(t){if(!this.dom||!this.widget.updateDOM(this.dom,t)){this.dom&&this.prevWidget&&this.prevWidget.destroy(this.dom);this.prevWidget=null;this.setDOM(this.widget.toDOM(t));this.widget.editable||(this.dom.contentEditable="false")}}get overrideDOMText(){return this.parent?this.parent.view.state.doc.slice(this.posAtStart,this.posAtEnd):t.empty}domBoundsAround(){return null}become(t){if(t instanceof BlockWidgetView&&t.widget.constructor==this.widget.constructor){t.widget.compare(this.widget)||this.markDirty(true);this.dom&&!this.prevWidget&&(this.prevWidget=this.widget);this.widget=t.widget;this.length=t.length;this.deco=t.deco;this.breakAfter=t.breakAfter;return true}return false}ignoreMutation(){return true}ignoreEvent(t){return this.widget.ignoreEvent(t)}get isEditable(){return false}get isWidget(){return true}coordsAt(t,e){let i=this.widget.coordsAt(this.dom,t,e);return i||(this.widget instanceof BlockGapWidget?null:flattenRect(this.dom.getBoundingClientRect(),this.length?t==0:e<=0))}destroy(){super.destroy();this.dom&&this.widget.destroy(this.dom)}covers(t){let{startSide:e,endSide:i}=this.deco;return e!=i&&(t<0?e<0:i>0)}}class BlockGapWidget extends WidgetType{constructor(t){super();this.height=t}toDOM(){let t=document.createElement("div");t.className="cm-gap";this.updateDOM(t);return t}eq(t){return t.height==this.height}updateDOM(t){t.style.height=this.height+"px";return true}get editable(){return true}get estimatedHeight(){return this.height}ignoreEvent(){return false}}class ContentBuilder{constructor(t,e,i,s){this.doc=t;this.pos=e;this.end=i;this.disallowBlockEffectsFor=s;this.content=[];this.curLine=null;this.breakAtStart=0;this.pendingBuffer=0;this.bufferMarks=[];this.atCursorPos=true;this.openStart=-1;this.openEnd=-1;this.text="";this.textOff=0;this.cursor=t.iter();this.skip=e}posCovered(){if(this.content.length==0)return!this.breakAtStart&&this.doc.lineAt(this.pos).from!=this.pos;let t=this.content[this.content.length-1];return!(t.breakAfter||t instanceof BlockWidgetView&&t.deco.endSide<0)}getLine(){if(!this.curLine){this.content.push(this.curLine=new LineView);this.atCursorPos=true}return this.curLine}flushBuffer(t=this.bufferMarks){if(this.pendingBuffer){this.curLine.append(wrapMarks(new WidgetBufferView(-1),t),t.length);this.pendingBuffer=0}}addBlockWidget(t){this.flushBuffer();this.curLine=null;this.content.push(t)}finish(t){this.pendingBuffer&&t<=this.bufferMarks.length?this.flushBuffer():this.pendingBuffer=0;this.posCovered()||t&&this.content.length&&this.content[this.content.length-1]instanceof BlockWidgetView||this.getLine()}buildText(t,e,i){while(t>0){if(this.textOff==this.text.length){let{value:e,lineBreak:i,done:s}=this.cursor.next(this.skip);this.skip=0;if(s)throw new Error("Ran out of text content when drawing inline views");if(i){this.posCovered()||this.getLine();this.content.length?this.content[this.content.length-1].breakAfter=1:this.breakAtStart=1;this.flushBuffer();this.curLine=null;this.atCursorPos=true;t--;continue}this.text=e;this.textOff=0}let s=Math.min(this.text.length-this.textOff,t,512);this.flushBuffer(e.slice(e.length-i));this.getLine().append(wrapMarks(new TextView(this.text.slice(this.textOff,this.textOff+s)),e),i);this.atCursorPos=true;this.textOff+=s;t-=s;i=0}}span(t,e,i,s){this.buildText(e-t,i,s);this.pos=e;this.openStart<0&&(this.openStart=s)}point(t,e,i,s,o,n){if(this.disallowBlockEffectsFor[n]&&i instanceof PointDecoration){if(i.block)throw new RangeError("Block decorations may not be specified via plugins");if(e>this.doc.lineAt(this.pos).to)throw new RangeError("Decorations that replace line breaks may not be specified via plugins")}let r=e-t;if(i instanceof PointDecoration)if(i.block){i.startSide>0&&!this.posCovered()&&this.getLine();this.addBlockWidget(new BlockWidgetView(i.widget||NullWidget.block,r,i))}else{let n=WidgetView.create(i.widget||NullWidget.inline,r,r?0:i.startSide);let l=this.atCursorPos&&!n.isEditable&&o<=s.length&&(t<e||i.startSide>0);let a=!n.isEditable&&(t<e||o>s.length||i.startSide<=0);let h=this.getLine();this.pendingBuffer!=2||l||n.isEditable||(this.pendingBuffer=0);this.flushBuffer(s);if(l){h.append(wrapMarks(new WidgetBufferView(1),s),o);o=s.length+Math.max(0,o-s.length)}h.append(wrapMarks(n,s),o);this.atCursorPos=a;this.pendingBuffer=a?t<e||o>s.length?1:2:0;this.pendingBuffer&&(this.bufferMarks=s.slice())}else this.doc.lineAt(this.pos).from==this.pos&&this.getLine().addLineDeco(i);if(r){if(this.textOff+r<=this.text.length)this.textOff+=r;else{this.skip+=r-(this.text.length-this.textOff);this.text="";this.textOff=0}this.pos=e}this.openStart<0&&(this.openStart=o)}static build(t,e,s,o,n){let r=new ContentBuilder(t,e,s,n);r.openEnd=i.spans(o,e,s,r);r.openStart<0&&(r.openStart=r.openEnd);r.finish(r.openEnd);return r}}function wrapMarks(t,e){for(let i of e)t=new MarkView(i,[t],t.length);return t}class NullWidget extends WidgetType{constructor(t){super();this.tag=t}eq(t){return t.tag==this.tag}toDOM(){return document.createElement(this.tag)}updateDOM(t){return t.nodeName.toLowerCase()==this.tag}get isHidden(){return true}}NullWidget.inline=new NullWidget("span");NullWidget.block=new NullWidget("div");var K=function(t){t[t.LTR=0]="LTR";t[t.RTL=1]="RTL";return t}(K||(K={}));const G=K.LTR,Y=K.RTL;function dec(t){let e=[];for(let i=0;i<t.length;i++)e.push(1<<+t[i]);return e}const X=dec("88888888888888888888888888888888888666888888787833333333337888888000000000000000000000000008888880000000000000000000000000088888888888888888888888888888888888887866668888088888663380888308888800000000000000000000000800000000000000000000000000000008");const j=dec("4444448826627288999999999992222222222222222222222222222222222222222222222229999999999999999999994444444444644222822222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222999999949999999229989999223333333333");const U=Object.create(null),_=[];for(let t of["()","[]","{}"]){let e=t.charCodeAt(0),i=t.charCodeAt(1);U[e]=i;U[i]=-e}function charType(t){return t<=247?X[t]:1424<=t&&t<=1524?2:1536<=t&&t<=1785?j[t-1536]:1774<=t&&t<=2220?4:8192<=t&&t<=8204?256:64336<=t&&t<=65023?4:1}const $=/[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac\ufb50-\ufdff]/;class BidiSpan{get dir(){return this.level%2?Y:G}constructor(t,e,i){this.from=t;this.to=e;this.level=i}side(t,e){return this.dir==e==t?this.to:this.from}forward(t,e){return t==(this.dir==e)}static find(t,e,i,s){let o=-1;for(let n=0;n<t.length;n++){let r=t[n];if(r.from<=e&&r.to>=e){if(r.level==i)return n;(o<0||(s!=0?s<0?r.from<e:r.to>e:t[o].level>r.level))&&(o=n)}}if(o<0)throw new RangeError("Index out of range");return o}}function isolatesEq(t,e){if(t.length!=e.length)return false;for(let i=0;i<t.length;i++){let s=t[i],o=e[i];if(s.from!=o.from||s.to!=o.to||s.direction!=o.direction||!isolatesEq(s.inner,o.inner))return false}return true}const Q=[];function computeCharTypes(t,e,i,s,o){for(let n=0;n<=s.length;n++){let r=n?s[n-1].to:e,l=n<s.length?s[n].from:i;let a=n?256:o;for(let e=r,i=a,s=a;e<l;e++){let o=charType(t.charCodeAt(e));o==512?o=i:o==8&&s==4&&(o=16);Q[e]=o==4?2:o;o&7&&(s=o);i=o}for(let t=r,e=a,s=a;t<l;t++){let o=Q[t];if(o==128)t<l-1&&e==Q[t+1]&&e&24?o=Q[t]=e:Q[t]=256;else if(o==64){let o=t+1;while(o<l&&Q[o]==64)o++;let n=t&&e==8||o<i&&Q[o]==8?s==1?1:8:256;for(let e=t;e<o;e++)Q[e]=n;t=o-1}else o==8&&s==1&&(Q[t]=1);e=o;o&7&&(s=o)}}}function processBracketPairs(t,e,i,s,o){let n=o==1?2:1;for(let r=0,l=0,a=0;r<=s.length;r++){let h=r?s[r-1].to:e,c=r<s.length?s[r].from:i;for(let e,i,s,r=h;r<c;r++)if(i=U[e=t.charCodeAt(r)])if(i<0){for(let t=l-3;t>=0;t-=3)if(_[t+1]==-i){let e=_[t+2];let i=e&2?o:e&4?e&1?n:o:0;i&&(Q[r]=Q[_[t]]=i);l=t;break}}else{if(_.length==189)break;_[l++]=r;_[l++]=e;_[l++]=a}else if((s=Q[r])==2||s==1){let t=s==o;a=t?0:1;for(let e=l-3;e>=0;e-=3){let i=_[e+2];if(i&2)break;if(t)_[e+2]|=2;else{if(i&4)break;_[e+2]|=4}}}}}function processNeutrals(t,e,i,s){for(let o=0,n=s;o<=i.length;o++){let r=o?i[o-1].to:t,l=o<i.length?i[o].from:e;for(let a=r;a<l;){let r=Q[a];if(r==256){let r=a+1;for(;;)if(r==l){if(o==i.length)break;r=i[o++].to;l=o<i.length?i[o].from:e}else{if(Q[r]!=256)break;r++}let h=n==1;let c=(r<e?Q[r]:s)==1;let d=h==c?h?1:2:s;for(let e=r,s=o,n=s?i[s-1].to:t;e>a;){if(e==n){e=i[--s].from;n=s?i[s-1].to:t}Q[--e]=d}a=r}else{n=r;a++}}}}function emitSpans(t,e,i,s,o,n,r){let l=s%2?2:1;if(s%2==o%2)for(let a=e,h=0;a<i;){let e=true,c=false;if(h==n.length||a<n[h].from){let t=Q[a];if(t!=l){e=false;c=t==16}}let d=e||l!=1?null:[];let u=e?s:s+1;let f=a;t:for(;;)if(h<n.length&&f==n[h].from){if(c)break t;let p=n[h];if(!e)for(let t=p.to,e=h+1;;){if(t==i)break t;if(!(e<n.length&&n[e].from==t)){if(Q[t]==l)break t;break}t=n[e++].to}h++;if(d)d.push(p);else{p.from>a&&r.push(new BidiSpan(a,p.from,u));let e=p.direction==G!=!(u%2);computeSectionOrder(t,e?s+1:s,o,p.inner,p.from,p.to,r);a=p.to}f=p.to}else{if(f==i||(e?Q[f]!=l:Q[f]==l))break;f++}d?emitSpans(t,a,f,s+1,o,d,r):a<f&&r.push(new BidiSpan(a,f,u));a=f}else for(let a=i,h=n.length;a>e;){let i=true,c=false;if(!h||a>n[h-1].to){let t=Q[a-1];if(t!=l){i=false;c=t==16}}let d=i||l!=1?null:[];let u=i?s:s+1;let f=a;t:for(;;)if(h&&f==n[h-1].to){if(c)break t;let p=n[--h];if(!i)for(let t=p.from,i=h;;){if(t==e)break t;if(!i||n[i-1].to!=t){if(Q[t-1]==l)break t;break}t=n[--i].from}if(d)d.push(p);else{p.to<a&&r.push(new BidiSpan(p.to,a,u));let e=p.direction==G!=!(u%2);computeSectionOrder(t,e?s+1:s,o,p.inner,p.from,p.to,r);a=p.from}f=p.from}else{if(f==e||(i?Q[f-1]!=l:Q[f-1]==l))break;f--}d?emitSpans(t,f,a,s+1,o,d,r):f<a&&r.push(new BidiSpan(f,a,u));a=f}}function computeSectionOrder(t,e,i,s,o,n,r){let l=e%2?2:1;computeCharTypes(t,o,n,s,l);processBracketPairs(t,o,n,s,l);processNeutrals(o,n,s,l);emitSpans(t,o,n,e,i,s,r)}function computeOrder(t,e,i){if(!t)return[new BidiSpan(0,0,e==Y?1:0)];if(e==G&&!i.length&&!$.test(t))return trivialOrder(t.length);if(i.length)while(t.length>Q.length)Q[Q.length]=256;let s=[],o=e==G?0:1;computeSectionOrder(t,o,o,i,0,t.length,s);return s}function trivialOrder(t){return[new BidiSpan(0,t,0)]}let J="";function moveVisually(t,e,i,s,r){var l;let a=s.head-t.from;let h=BidiSpan.find(e,a,(l=s.bidiLevel)!==null&&l!==void 0?l:-1,s.assoc);let c=e[h],d=c.side(r,i);if(a==d){let t=h+=r?1:-1;if(t<0||t>=e.length)return null;c=e[h=t];a=c.side(!r,i);d=c.side(r,i)}let u=o(t.text,a,c.forward(r,i));(u<c.from||u>c.to)&&(u=d);J=t.text.slice(Math.min(a,u),Math.max(a,u));let f=h==(r?e.length-1:0)?null:e[h+(r?1:-1)];return f&&u==d&&f.level+(r?0:1)<c.level?n.cursor(f.side(!r,i)+t.from,f.forward(r,i)?1:-1,f.level):n.cursor(u+t.from,c.forward(r,i)?-1:1,c.level)}function autoDirection(t,e,i){for(let s=e;s<i;s++){let e=charType(t.charCodeAt(s));if(e==1)return G;if(e==2||e==4)return Y}return G}const Z=r.define();const tt=r.define();const et=r.define();const it=r.define();const st=r.define();const ot=r.define();const nt=r.define();const rt=r.define();const lt=r.define();const at=r.define({combine:t=>t.some((t=>t))});const ht=r.define({combine:t=>t.some((t=>t))});const ct=r.define();class ScrollTarget{constructor(t,e="nearest",i="nearest",s=5,o=5,n=false){this.range=t;this.y=e;this.x=i;this.yMargin=s;this.xMargin=o;this.isSnapshot=n}map(t){return t.empty?this:new ScrollTarget(this.range.map(t),this.y,this.x,this.yMargin,this.xMargin,this.isSnapshot)}clip(t){return this.range.to<=t.doc.length?this:new ScrollTarget(n.cursor(t.doc.length),this.y,this.x,this.yMargin,this.xMargin,this.isSnapshot)}}const dt=l.define({map:(t,e)=>t.map(e)});const ut=l.define();function logException(t,e,i){let s=t.facet(it);s.length?s[0](e):window.onerror?window.onerror(String(e),i,void 0,void 0,e):i?console.error(i+":",e):console.error(e)}const ft=r.define({combine:t=>!t.length||t[0]});let pt=0;const gt=r.define();class ViewPlugin{constructor(t,e,i,s,o){this.id=t;this.create=e;this.domEventHandlers=i;this.domEventObservers=s;this.extension=o(this)}static define(t,e){const{eventHandlers:i,eventObservers:s,provide:o,decorations:n}=e||{};return new ViewPlugin(pt++,t,i,s,(t=>{let e=[gt.of(t)];n&&e.push(vt.of((e=>{let i=e.plugin(t);return i?n(i):Decoration.none})));o&&e.push(o(t));return e}))}static fromClass(t,e){return ViewPlugin.define((e=>new t(e)),e)}}class PluginInstance{constructor(t){this.spec=t;this.mustUpdate=null;this.value=null}update(t){if(this.value){if(this.mustUpdate){let t=this.mustUpdate;this.mustUpdate=null;if(this.value.update)try{this.value.update(t)}catch(e){logException(t.state,e,"CodeMirror plugin crashed");if(this.value.destroy)try{this.value.destroy()}catch(t){}this.deactivate()}}}else if(this.spec)try{this.value=this.spec.create(t)}catch(e){logException(t.state,e,"CodeMirror plugin crashed");this.deactivate()}return this}destroy(t){var e;if((e=this.value)===null||e===void 0?void 0:e.destroy)try{this.value.destroy()}catch(e){logException(t.state,e,"CodeMirror plugin crashed")}}deactivate(){this.spec=this.value=null}}const mt=r.define();const wt=r.define();const vt=r.define();const bt=r.define();const yt=r.define();const xt=r.define();function getIsolatedRanges(t,e){let s=t.state.facet(xt);if(!s.length)return s;let o=s.map((e=>e instanceof Function?e(t):e));let n=[];i.spans(o,e.from,e.to,{point(){},span(t,i,s,o){let r=t-e.from,l=i-e.from;let a=n;for(let t=s.length-1;t>=0;t--,o--){let i,n=s[t].spec.bidiIsolate;n==null&&(n=autoDirection(e.text,r,l));if(o>0&&a.length&&(i=a[a.length-1]).to==r&&i.direction==n){i.to=l;a=i.inner}else{let t={from:r,to:l,direction:n,inner:[]};a.push(t);a=t.inner}}}});return n}const St=r.define();function getScrollMargins(t){let e=0,i=0,s=0,o=0;for(let n of t.state.facet(St)){let r=n(t);if(r){r.left!=null&&(e=Math.max(e,r.left));r.right!=null&&(i=Math.max(i,r.right));r.top!=null&&(s=Math.max(s,r.top));r.bottom!=null&&(o=Math.max(o,r.bottom))}}return{left:e,right:i,top:s,bottom:o}}const Mt=r.define();class ChangedRange{constructor(t,e,i,s){this.fromA=t;this.toA=e;this.fromB=i;this.toB=s}join(t){return new ChangedRange(Math.min(this.fromA,t.fromA),Math.max(this.toA,t.toA),Math.min(this.fromB,t.fromB),Math.max(this.toB,t.toB))}addToSet(t){let e=t.length,i=this;for(;e>0;e--){let s=t[e-1];if(!(s.fromA>i.toA)){if(s.toA<i.fromA)break;i=i.join(s);t.splice(e-1,1)}}t.splice(e,0,i);return t}static extendWithRanges(t,e){if(e.length==0)return t;let i=[];for(let s=0,o=0,n=0,r=0;;s++){let l=s==t.length?null:t[s],a=n-r;let h=l?l.fromB:1e9;while(o<e.length&&e[o]<h){let t=e[o],s=e[o+1];let n=Math.max(r,t),l=Math.min(h,s);n<=l&&new ChangedRange(n+a,l+a,n,l).addToSet(i);if(s>h)break;o+=2}if(!l)return i;new ChangedRange(l.fromA,l.toA,l.fromB,l.toB).addToSet(i);n=l.toA;r=l.toB}}}class ViewUpdate{constructor(t,e,i){this.view=t;this.state=e;this.transactions=i;this.flags=0;this.startState=t.state;this.changes=a.empty(this.startState.doc.length);for(let t of i)this.changes=this.changes.compose(t.changes);let s=[];this.changes.iterChangedRanges(((t,e,i,o)=>s.push(new ChangedRange(t,e,i,o))));this.changedRanges=s}static create(t,e,i){return new ViewUpdate(t,e,i)}get viewportChanged(){return(this.flags&4)>0}get heightChanged(){return(this.flags&2)>0}get geometryChanged(){return this.docChanged||(this.flags&10)>0}get focusChanged(){return(this.flags&1)>0}get docChanged(){return!this.changes.empty}get selectionSet(){return this.transactions.some((t=>t.selection))}get empty(){return this.flags==0&&this.transactions.length==0}}class DocView extends ContentView{get length(){return this.view.state.doc.length}constructor(t){super();this.view=t;this.decorations=[];this.dynamicDecorationMap=[false];this.domChanged=null;this.hasComposition=null;this.markedForComposition=new Set;this.editContextFormatting=Decoration.none;this.lastCompositionAfterCursor=false;this.minWidth=0;this.minWidthFrom=0;this.minWidthTo=0;this.impreciseAnchor=null;this.impreciseHead=null;this.forceSelection=false;this.lastUpdate=Date.now();this.setDOM(t.contentDOM);this.children=[new LineView];this.children[0].setParent(this);this.updateDeco();this.updateInner([new ChangedRange(0,0,0,t.state.doc.length)],0,null)}update(t){var e;let i=t.changedRanges;if(this.minWidth>0&&i.length)if(i.every((({fromA:t,toA:e})=>e<this.minWidthFrom||t>this.minWidthTo))){this.minWidthFrom=t.changes.mapPos(this.minWidthFrom,1);this.minWidthTo=t.changes.mapPos(this.minWidthTo,1)}else this.minWidth=this.minWidthFrom=this.minWidthTo=0;this.updateEditContextFormatting(t);let s=-1;this.view.inputState.composing>=0&&!this.view.observer.editContext&&(((e=this.domChanged)===null||e===void 0?void 0:e.newSel)?s=this.domChanged.newSel.head:touchesComposition(t.changes,this.hasComposition)||t.selectionSet||(s=t.state.selection.main.head));let o=s>-1?findCompositionRange(this.view,t.changes,s):null;this.domChanged=null;if(this.hasComposition){this.markedForComposition.clear();let{from:e,to:s}=this.hasComposition;i=new ChangedRange(e,s,t.changes.mapPos(e,-1),t.changes.mapPos(s,1)).addToSet(i.slice())}this.hasComposition=o?{from:o.range.fromB,to:o.range.toB}:null;(F.ie||F.chrome)&&!o&&t&&t.state.doc.lines!=t.startState.doc.lines&&(this.forceSelection=true);let n=this.decorations,r=this.updateDeco();let l=findChangedDeco(n,r,t.changes);i=ChangedRange.extendWithRanges(i,l);if(this.flags&7||i.length!=0){this.updateInner(i,t.startState.doc.length,o);t.transactions.length&&(this.lastUpdate=Date.now());return true}return false}updateInner(t,e,i){this.view.viewState.mustMeasureContent=true;this.updateChildren(t,e,i);let{observer:s}=this.view;s.ignore((()=>{this.dom.style.height=this.view.viewState.contentHeight/this.view.scaleY+"px";this.dom.style.flexBasis=this.minWidth?this.minWidth+"px":"";let t=F.chrome||F.ios?{node:s.selectionRange.focusNode,written:false}:void 0;this.sync(this.view,t);this.flags&=-8;t&&(t.written||s.selectionRange.focusNode!=t.node)&&(this.forceSelection=true);this.dom.style.height=""}));this.markedForComposition.forEach((t=>t.flags&=-9));let o=[];if(this.view.viewport.from||this.view.viewport.to<this.view.state.doc.length)for(let t of this.children)t instanceof BlockWidgetView&&t.widget instanceof BlockGapWidget&&o.push(t.dom);s.updateGaps(o)}updateChildren(t,e,i){let s=i?i.range.addToSet(t.slice()):t;let o=this.childCursor(e);for(let t=s.length-1;;t--){let e=t>=0?s[t]:null;if(!e)break;let n,r,l,a,{fromA:h,toA:c,fromB:d,toB:u}=e;if(i&&i.range.fromB<u&&i.range.toB>d){let t=ContentBuilder.build(this.view.state.doc,d,i.range.fromB,this.decorations,this.dynamicDecorationMap);let e=ContentBuilder.build(this.view.state.doc,i.range.toB,u,this.decorations,this.dynamicDecorationMap);r=t.breakAtStart;l=t.openStart;a=e.openEnd;let s=this.compositionView(i);if(e.breakAtStart)s.breakAfter=1;else if(e.content.length&&s.merge(s.length,s.length,e.content[0],false,e.openStart,0)){s.breakAfter=e.content[0].breakAfter;e.content.shift()}t.content.length&&s.merge(0,0,t.content[t.content.length-1],true,0,t.openEnd)&&t.content.pop();n=t.content.concat(s).concat(e.content)}else({content:n,breakAtStart:r,openStart:l,openEnd:a}=ContentBuilder.build(this.view.state.doc,d,u,this.decorations,this.dynamicDecorationMap));let{i:f,off:p}=o.findPos(c,1);let{i:g,off:m}=o.findPos(h,-1);replaceRange(this,g,m,f,p,n,r,l,a)}i&&this.fixCompositionDOM(i)}updateEditContextFormatting(t){this.editContextFormatting=this.editContextFormatting.map(t.changes);for(let e of t.transactions)for(let t of e.effects)t.is(ut)&&(this.editContextFormatting=t.value)}compositionView(t){let e=new TextView(t.text.nodeValue);e.flags|=8;for(let{deco:i}of t.marks)e=new MarkView(i,[e],e.length);let i=new LineView;i.append(e,0);return i}fixCompositionDOM(t){let fix=(t,e)=>{e.flags|=8|(e.children.some((t=>t.flags&7))?1:0);this.markedForComposition.add(e);let i=ContentView.get(t);i&&i!=e&&(i.dom=null);e.setDOM(t)};let e=this.childPos(t.range.fromB,1);let i=this.children[e.i];fix(t.line,i);for(let s=t.marks.length-1;s>=-1;s--){e=i.childPos(e.off,1);i=i.children[e.i];fix(s>=0?t.marks[s].node:t.text,i)}}updateSelection(t=false,e=false){!t&&this.view.observer.selectionRange.focusNode||this.view.observer.readSelectionRange();let i=this.view.root.activeElement,s=i==this.dom;let o=!s&&hasSelection(this.dom,this.view.observer.selectionRange)&&!(i&&this.dom.contains(i));if(!(s||e||o))return;let n=this.forceSelection;this.forceSelection=false;let r=this.view.state.selection.main;let l=this.moveToLine(this.domAtPos(r.anchor));let a=r.empty?l:this.moveToLine(this.domAtPos(r.head));if(F.gecko&&r.empty&&!this.hasComposition&&betweenUneditable(l)){let t=document.createTextNode("");this.view.observer.ignore((()=>l.node.insertBefore(t,l.node.childNodes[l.offset]||null)));l=a=new DOMPos(t,0);n=true}let h=this.view.observer.selectionRange;if(n||!h.focusNode||(!isEquivalentPosition(l.node,l.offset,h.anchorNode,h.anchorOffset)||!isEquivalentPosition(a.node,a.offset,h.focusNode,h.focusOffset))&&!this.suppressWidgetCursorChange(h,r)){this.view.observer.ignore((()=>{if(F.android&&F.chrome&&this.dom.contains(h.focusNode)&&inUneditable(h.focusNode,this.dom)){this.dom.blur();this.dom.focus({preventScroll:true})}let t=getSelection(this.view.root);if(t)if(r.empty){if(F.gecko){let t=nextToUneditable(l.node,l.offset);if(t&&t!=3){let e=(t==1?textNodeBefore:textNodeAfter)(l.node,l.offset);e&&(l=new DOMPos(e.node,e.offset))}}t.collapse(l.node,l.offset);r.bidiLevel!=null&&t.caretBidiLevel!==void 0&&(t.caretBidiLevel=r.bidiLevel)}else if(t.extend){t.collapse(l.node,l.offset);try{t.extend(a.node,a.offset)}catch(t){}}else{let e=document.createRange();r.anchor>r.head&&([l,a]=[a,l]);e.setEnd(a.node,a.offset);e.setStart(l.node,l.offset);t.removeAllRanges();t.addRange(e)}else;if(o&&this.view.root.activeElement==this.dom){this.dom.blur();i&&i.focus()}}));this.view.observer.setSelectionRange(l,a)}this.impreciseAnchor=l.precise?null:new DOMPos(h.anchorNode,h.anchorOffset);this.impreciseHead=a.precise?null:new DOMPos(h.focusNode,h.focusOffset)}suppressWidgetCursorChange(t,e){return this.hasComposition&&e.empty&&isEquivalentPosition(t.focusNode,t.focusOffset,t.anchorNode,t.anchorOffset)&&this.posFromDOM(t.focusNode,t.focusOffset)==e.head}enforceCursorAssoc(){if(this.hasComposition)return;let{view:t}=this,e=t.state.selection.main;let i=getSelection(t.root);let{anchorNode:s,anchorOffset:o}=t.observer.selectionRange;if(!i||!e.empty||!e.assoc||!i.modify)return;let n=LineView.find(this,e.head);if(!n)return;let r=n.posAtStart;if(e.head==r||e.head==r+n.length)return;let l=this.coordsAt(e.head,-1),a=this.coordsAt(e.head,1);if(!l||!a||l.bottom>a.top)return;let h=this.domAtPos(e.head+e.assoc);i.collapse(h.node,h.offset);i.modify("move",e.assoc<0?"forward":"backward","lineboundary");t.observer.readSelectionRange();let c=t.observer.selectionRange;t.docView.posFromDOM(c.anchorNode,c.anchorOffset)!=e.from&&i.collapse(s,o)}moveToLine(t){let e,i=this.dom;if(t.node!=i)return t;for(let s=t.offset;!e&&s<i.childNodes.length;s++){let t=ContentView.get(i.childNodes[s]);t instanceof LineView&&(e=t.domAtPos(0))}for(let s=t.offset-1;!e&&s>=0;s--){let t=ContentView.get(i.childNodes[s]);t instanceof LineView&&(e=t.domAtPos(t.length))}return e?new DOMPos(e.node,e.offset,true):t}nearest(t){for(let e=t;e;){let t=ContentView.get(e);if(t&&t.rootView==this)return t;e=e.parentNode}return null}posFromDOM(t,e){let i=this.nearest(t);if(!i)throw new RangeError("Trying to find position for a DOM position outside of the document");return i.localPosFromDOM(t,e)+i.posAtStart}domAtPos(t){let{i:e,off:i}=this.childCursor().findPos(t,-1);for(;e<this.children.length-1;){let t=this.children[e];if(i<t.length||t instanceof LineView)break;e++;i=0}return this.children[e].domAtPos(i)}coordsAt(t,e){let i=null,s=0;for(let o=this.length,n=this.children.length-1;n>=0;n--){let r=this.children[n],l=o-r.breakAfter,a=l-r.length;if(l<t)break;if(a<=t&&(a<t||r.covers(-1))&&(l>t||r.covers(1))&&(!i||r instanceof LineView&&!(i instanceof LineView&&e>=0))){i=r;s=a}else if(i&&a==t&&l==t&&r instanceof BlockWidgetView&&Math.abs(e)<2){if(r.deco.startSide<0)break;n&&(i=null)}o=a}return i?i.coordsAt(t-s,e):null}coordsForChar(t){let{i:e,off:i}=this.childPos(t,1),s=this.children[e];if(!(s instanceof LineView))return null;while(s.children.length){let{i:t,off:e}=s.childPos(i,1);for(;;t++){if(t==s.children.length)return null;if((s=s.children[t]).length)break}i=e}if(!(s instanceof TextView))return null;let n=o(s.text,i);if(n==i)return null;let r=textRange(s.dom,i,n).getClientRects();for(let t=0;t<r.length;t++){let e=r[t];if(t==r.length-1||e.top<e.bottom&&e.left<e.right)return e}return null}measureVisibleLineHeights(t){let e=[],{from:i,to:s}=t;let o=this.view.contentDOM.clientWidth;let n=o>Math.max(this.view.scrollDOM.clientWidth,this.minWidth)+1;let r=-1,l=this.view.textDirection==K.LTR;for(let t=0,a=0;a<this.children.length;a++){let h=this.children[a],c=t+h.length;if(c>s)break;if(t>=i){let i=h.dom.getBoundingClientRect();e.push(i.height);if(n){let e=h.dom.lastChild;let s=e?clientRectsFor(e):[];if(s.length){let e=s[s.length-1];let n=l?e.right-i.left:i.right-e.left;if(n>r){r=n;this.minWidth=o;this.minWidthFrom=t;this.minWidthTo=c}}}}t=c+h.breakAfter}return e}textDirectionAt(t){let{i:e}=this.childPos(t,1);return getComputedStyle(this.children[e].dom).direction=="rtl"?K.RTL:K.LTR}measureTextSize(){for(let t of this.children)if(t instanceof LineView){let e=t.measureTextSize();if(e)return e}let t,e,i,s=document.createElement("div");s.className="cm-line";s.style.width="99999px";s.style.position="absolute";s.textContent="abc def ghi jkl mno pqr stu";this.view.observer.ignore((()=>{this.dom.appendChild(s);let o=clientRectsFor(s.firstChild)[0];t=s.getBoundingClientRect().height;e=o?o.width/27:7;i=o?o.height:t;s.remove()}));return{lineHeight:t,charWidth:e,textHeight:i}}childCursor(t=this.length){let e=this.children.length;e&&(t-=this.children[--e].length);return new ChildCursor(this.children,t,e)}computeBlockGapDeco(){let t=[],e=this.view.viewState;for(let i=0,s=0;;s++){let o=s==e.viewports.length?null:e.viewports[s];let n=o?o.from-1:this.length;if(n>i){let s=(e.lineBlockAt(n).bottom-e.lineBlockAt(i).top)/this.view.scaleY;t.push(Decoration.replace({widget:new BlockGapWidget(s),block:true,inclusive:true,isBlockGap:true}).range(i,n))}if(!o)break;i=o.to+1}return Decoration.set(t)}updateDeco(){let t=1;let e=this.view.state.facet(vt).map((e=>{let i=this.dynamicDecorationMap[t++]=typeof e=="function";return i?e(this.view):e}));let s=false,o=this.view.state.facet(bt).map(((t,e)=>{let i=typeof t=="function";i&&(s=true);return i?t(this.view):t}));if(o.length){this.dynamicDecorationMap[t++]=s;e.push(i.join(o))}this.decorations=[this.editContextFormatting,...e,this.computeBlockGapDeco(),this.view.viewState.lineGapDeco];while(t<this.decorations.length)this.dynamicDecorationMap[t++]=false;return this.decorations}scrollIntoView(t){if(t.isSnapshot){let e=this.view.viewState.lineBlockAt(t.range.head);this.view.scrollDOM.scrollTop=e.top-t.yMargin;this.view.scrollDOM.scrollLeft=t.xMargin;return}for(let e of this.view.state.facet(ct))try{if(e(this.view,t.range,t))return true}catch(t){logException(this.view.state,t,"scroll handler")}let{range:e}=t;let i,s=this.coordsAt(e.head,e.empty?e.assoc:e.head>e.anchor?-1:1);if(!s)return;!e.empty&&(i=this.coordsAt(e.anchor,e.anchor>e.head?-1:1))&&(s={left:Math.min(s.left,i.left),top:Math.min(s.top,i.top),right:Math.max(s.right,i.right),bottom:Math.max(s.bottom,i.bottom)});let o=getScrollMargins(this.view);let n={left:s.left-o.left,top:s.top-o.top,right:s.right+o.right,bottom:s.bottom+o.bottom};let{offsetWidth:r,offsetHeight:l}=this.view.scrollDOM;scrollRectIntoView(this.view.scrollDOM,n,e.head<e.anchor?-1:1,t.x,t.y,Math.max(Math.min(t.xMargin,r),-r),Math.max(Math.min(t.yMargin,l),-l),this.view.textDirection==K.LTR)}}function betweenUneditable(t){return t.node.nodeType==1&&t.node.firstChild&&(t.offset==0||t.node.childNodes[t.offset-1].contentEditable=="false")&&(t.offset==t.node.childNodes.length||t.node.childNodes[t.offset].contentEditable=="false")}function findCompositionNode(t,e){let i=t.observer.selectionRange;if(!i.focusNode)return null;let s=textNodeBefore(i.focusNode,i.focusOffset);let o=textNodeAfter(i.focusNode,i.focusOffset);let n=s||o;if(o&&s&&o.node!=s.node){let e=ContentView.get(o.node);if(!e||e instanceof TextView&&e.text!=o.node.nodeValue)n=o;else if(t.docView.lastCompositionAfterCursor){let t=ContentView.get(s.node);!t||t instanceof TextView&&t.text!=s.node.nodeValue||(n=o)}}t.docView.lastCompositionAfterCursor=n!=s;if(!n)return null;let r=e-n.offset;return{from:r,to:r+n.node.nodeValue.length,node:n.node}}function findCompositionRange(t,e,i){let s=findCompositionNode(t,i);if(!s)return null;let{node:o,from:n,to:r}=s,l=o.nodeValue;if(/[\n\r]/.test(l))return null;if(t.state.doc.sliceString(s.from,s.to)!=l)return null;let a=e.invertedDesc;let h=new ChangedRange(a.mapPos(n),a.mapPos(r),n,r);let c=[];for(let e=o.parentNode;;e=e.parentNode){let i=ContentView.get(e);if(i instanceof MarkView)c.push({node:e,deco:i.mark});else{if(i instanceof LineView||e.nodeName=="DIV"&&e.parentNode==t.contentDOM)return{range:h,text:o,marks:c,line:e};if(e==t.contentDOM)return null;c.push({node:e,deco:new MarkDecoration({inclusive:true,attributes:getAttrs(e),tagName:e.tagName.toLowerCase()})})}}}function nextToUneditable(t,e){return t.nodeType!=1?0:(e&&t.childNodes[e-1].contentEditable=="false"?1:0)|(e<t.childNodes.length&&t.childNodes[e].contentEditable=="false"?2:0)}let Ct=class DecorationComparator{constructor(){this.changes=[]}compareRange(t,e){addRange(t,e,this.changes)}comparePoint(t,e){addRange(t,e,this.changes)}};function findChangedDeco(t,e,s){let o=new Ct;i.compare(t,e,s,o);return o.changes}function inUneditable(t,e){for(let i=t;i&&i!=e;i=i.assignedSlot||i.parentNode)if(i.nodeType==1&&i.contentEditable=="false")return true;return false}function touchesComposition(t,e){let i=false;e&&t.iterChangedRanges(((t,s)=>{t<e.to&&s>e.from&&(i=true)}));return i}function groupAt(t,e,i=1){let s=t.charCategorizer(e);let r=t.doc.lineAt(e),l=e-r.from;if(r.length==0)return n.cursor(e);l==0?i=1:l==r.length&&(i=-1);let a=l,h=l;i<0?a=o(r.text,l,false):h=o(r.text,l);let c=s(r.text.slice(a,h));while(a>0){let t=o(r.text,a,false);if(s(r.text.slice(t,a))!=c)break;a=t}while(h<r.length){let t=o(r.text,h);if(s(r.text.slice(h,t))!=c)break;h=t}return n.range(a+r.from,h+r.from)}function getdx(t,e){return e.left>t?e.left-t:Math.max(0,t-e.right)}function getdy(t,e){return e.top>t?e.top-t:Math.max(0,t-e.bottom)}function yOverlap(t,e){return t.top<e.bottom-1&&t.bottom>e.top+1}function upTop(t,e){return e<t.top?{top:e,left:t.left,right:t.right,bottom:t.bottom}:t}function upBot(t,e){return e>t.bottom?{top:t.top,left:t.left,right:t.right,bottom:e}:t}function domPosAtCoords(t,e,i){let s,o,n,r,l=false;let a,h,c,d;for(let u=t.firstChild;u;u=u.nextSibling){let t=clientRectsFor(u);for(let f=0;f<t.length;f++){let p=t[f];o&&yOverlap(o,p)&&(p=upTop(upBot(p,o.bottom),o.top));let g=getdx(e,p),m=getdy(i,p);if(g==0&&m==0)return u.nodeType==3?domPosInText(u,e,i):domPosAtCoords(u,e,i);if(!s||r>m||r==m&&n>g){s=u;o=p;n=g;r=m;let a=m?i<p.top?-1:1:g?e<p.left?-1:1:0;l=!a||(a>0?f<t.length-1:f>0)}if(g==0){if(i>p.bottom&&(!c||c.bottom<p.bottom)){a=u;c=p}else if(i<p.top&&(!d||d.top>p.top)){h=u;d=p}}else c&&yOverlap(c,p)?c=upBot(c,p.bottom):d&&yOverlap(d,p)&&(d=upTop(d,p.top))}}if(c&&c.bottom>=i){s=a;o=c}else if(d&&d.top<=i){s=h;o=d}if(!s)return{node:t,offset:0};let u=Math.max(o.left,Math.min(o.right,e));if(s.nodeType==3)return domPosInText(s,u,i);if(l&&s.contentEditable!="false")return domPosAtCoords(s,u,i);let f=Array.prototype.indexOf.call(t.childNodes,s)+(e>=(o.left+o.right)/2?1:0);return{node:t,offset:f}}function domPosInText(t,e,i){let s=t.nodeValue.length;let o=-1,n=1e9,r=0;for(let l=0;l<s;l++){let s=textRange(t,l,l+1).getClientRects();for(let a=0;a<s.length;a++){let h=s[a];if(h.top==h.bottom)continue;r||(r=e-h.left);let c=(h.top>i?h.top-i:i-h.bottom)-1;if(h.left-1<=e&&h.right+1>=e&&c<n){let i=e>=(h.left+h.right)/2,s=i;if(F.chrome||F.gecko){let e=textRange(t,l).getBoundingClientRect();e.left==h.right&&(s=!i)}if(c<=0)return{node:t,offset:l+(s?1:0)};o=l+(s?1:0);n=c}}}return{node:t,offset:o>-1?o:r>0?t.nodeValue.length:0}}function posAtCoords(t,e,i,s=-1){var o,n;let r=t.contentDOM.getBoundingClientRect(),l=r.top+t.viewState.paddingTop;let a,{docHeight:h}=t.viewState;let{x:c,y:d}=e,u=d-l;if(u<0)return 0;if(u>h)return t.state.doc.length;for(let e=t.viewState.heightOracle.textHeight/2,o=false;;){a=t.elementAtHeight(u);if(a.type==q.Text)break;for(;;){u=s>0?a.bottom+e:a.top-e;if(u>=0&&u<=h)break;if(o)return i?null:0;o=true;s=-s}}d=l+u;let f=a.from;if(f<t.viewport.from)return t.viewport.from==0?0:i?null:posAtCoordsImprecise(t,r,a,c,d);if(f>t.viewport.to)return t.viewport.to==t.state.doc.length?t.state.doc.length:i?null:posAtCoordsImprecise(t,r,a,c,d);let p=t.dom.ownerDocument;let g=t.root.elementFromPoint?t.root:p;let m=g.elementFromPoint(c,d);m&&!t.contentDOM.contains(m)&&(m=null);if(!m){c=Math.max(r.left+1,Math.min(r.right-1,c));m=g.elementFromPoint(c,d);m&&!t.contentDOM.contains(m)&&(m=null)}let w,v=-1;if(m&&((o=t.docView.nearest(m))===null||o===void 0?void 0:o.isEditable)!=false){if(p.caretPositionFromPoint){let t=p.caretPositionFromPoint(c,d);t&&({offsetNode:w,offset:v}=t)}else if(p.caretRangeFromPoint){let e=p.caretRangeFromPoint(c,d);if(e){({startContainer:w,startOffset:v}=e);(!t.contentDOM.contains(w)||F.safari&&isSuspiciousSafariCaretResult(w,v,c)||F.chrome&&isSuspiciousChromeCaretResult(w,v,c))&&(w=void 0)}}w&&(v=Math.min(maxOffset(w),v))}if(!w||!t.docView.dom.contains(w)){let e=LineView.find(t.docView,f);if(!e)return u>a.top+a.height/2?a.to:a.from;({node:w,offset:v}=domPosAtCoords(e.dom,c,d))}let b=t.docView.nearest(w);if(!b)return null;if(b.isWidget&&((n=b.dom)===null||n===void 0?void 0:n.nodeType)==1){let t=b.dom.getBoundingClientRect();return e.y<t.top||e.y<=t.bottom&&e.x<=(t.left+t.right)/2?b.posAtStart:b.posAtEnd}return b.localPosFromDOM(w,v)+b.posAtStart}function posAtCoordsImprecise(t,e,i,s,o){let n=Math.round((s-e.left)*t.defaultCharacterWidth);if(t.lineWrapping&&i.height>t.defaultLineHeight*1.5){let e=t.viewState.heightOracle.textHeight;let s=Math.floor((o-i.top-.5*(t.defaultLineHeight-e))/e);n+=s*t.viewState.heightOracle.lineLength}let r=t.state.sliceDoc(i.from,i.to);return i.from+h(r,n,t.state.tabSize)}function isSuspiciousSafariCaretResult(t,e,i){let s;if(t.nodeType!=3||e!=(s=t.nodeValue.length))return false;for(let e=t.nextSibling;e;e=e.nextSibling)if(e.nodeType!=1||e.nodeName!="BR")return false;return textRange(t,s-1,s).getBoundingClientRect().left>i}function isSuspiciousChromeCaretResult(t,e,i){if(e!=0)return false;for(let e=t;;){let t=e.parentNode;if(!t||t.nodeType!=1||t.firstChild!=e)return false;if(t.classList.contains("cm-line"))break;e=t}let s=t.nodeType==1?t.getBoundingClientRect():textRange(t,0,Math.max(t.nodeValue.length,1)).getBoundingClientRect();return i-s.left>5}function blockAt(t,e){let i=t.lineBlockAt(e);if(Array.isArray(i.type))for(let t of i.type)if(t.to>e||t.to==e&&(t.to==i.to||t.type==q.Text))return t;return i}function moveToLineBoundary(t,e,i,s){let o=blockAt(t,e.head);let r=s&&o.type==q.Text&&(t.lineWrapping||o.widgetLineBreaks)?t.coordsAtPos(e.assoc<0&&e.head>o.from?e.head-1:e.head):null;if(r){let e=t.dom.getBoundingClientRect();let s=t.textDirectionAt(o.from);let l=t.posAtCoords({x:i==(s==K.LTR)?e.right-1:e.left+1,y:(r.top+r.bottom)/2});if(l!=null)return n.cursor(l,i?-1:1)}return n.cursor(i?o.to:o.from,i?-1:1)}function moveByChar(t,e,i,s){let o=t.state.doc.lineAt(e.head),n=t.bidiSpans(o);let r=t.textDirectionAt(o.from);for(let l=e,a=null;;){let e=moveVisually(o,n,r,l,i),h=J;if(!e){if(o.number==(i?t.state.doc.lines:1))return l;h="\n";o=t.state.doc.line(o.number+(i?1:-1));n=t.bidiSpans(o);e=t.visualLineSide(o,!i)}if(a){if(!a(h))return l}else{if(!s)return e;a=s(h)}l=e}}function byGroup(t,e,i){let s=t.state.charCategorizer(e);let o=s(i);return t=>{let e=s(t);o==c.Space&&(o=e);return o==e}}function moveVertically(t,e,i,s){let o=e.head,r=i?1:-1;if(o==(i?t.state.doc.length:0))return n.cursor(o,e.assoc);let l,a=e.goalColumn;let h=t.contentDOM.getBoundingClientRect();let c=t.coordsAtPos(o,e.assoc||-1),d=t.documentTop;if(c){a==null&&(a=c.left-h.left);l=r<0?c.top:c.bottom}else{let e=t.viewState.lineBlockAt(o);a==null&&(a=Math.min(h.right-h.left,t.defaultCharacterWidth*(o-e.from)));l=(r<0?e.top:e.bottom)+d}let u=h.left+a;let f=s!==null&&s!==void 0?s:t.viewState.heightOracle.textHeight>>1;for(let e=0;;e+=10){let i=l+(f+e)*r;let s=posAtCoords(t,{x:u,y:i},false,r);if(i<h.top||i>h.bottom||(r<0?s<o:s>o)){let e=t.docView.coordsForChar(s);let o=!e||i<e.top?-1:1;return n.cursor(s,o,void 0,a)}}}function skipAtomicRanges(t,e,i){for(;;){let s=0;for(let o of t)o.between(e-1,e+1,((t,o,n)=>{if(e>t&&e<o){let n=s||i||(e-t<o-e?-1:1);e=n<0?t:o;s=n}}));if(!s)return e}}function skipAtoms(t,e,i){let s=skipAtomicRanges(t.state.facet(yt).map((e=>e(t))),i.from,e.head>i.from?-1:1);return s==i.from?i:n.cursor(s,s<i.from?1:-1)}const kt="";class DOMReader{constructor(t,e){this.points=t;this.text="";this.lineSeparator=e.facet(d.lineSeparator)}append(t){this.text+=t}lineBreak(){this.text+=kt}readRange(t,e){if(!t)return this;let i=t.parentNode;for(let s=t;;){this.findPointBefore(i,s);let t=this.text.length;this.readNode(s);let o=s.nextSibling;if(o==e)break;let n=ContentView.get(s),r=ContentView.get(o);(n&&r?n.breakAfter:(n?n.breakAfter:isBlockElement(s))||isBlockElement(o)&&(s.nodeName!="BR"||s.cmIgnore)&&this.text.length>t)&&this.lineBreak();s=o}this.findPointBefore(i,e);return this}readTextNode(t){let e=t.nodeValue;for(let i of this.points)i.node==t&&(i.pos=this.text.length+Math.min(i.offset,e.length));for(let i=0,s=this.lineSeparator?null:/\r\n?|\n/g;;){let o,n=-1,r=1;if(this.lineSeparator){n=e.indexOf(this.lineSeparator,i);r=this.lineSeparator.length}else if(o=s.exec(e)){n=o.index;r=o[0].length}this.append(e.slice(i,n<0?e.length:n));if(n<0)break;this.lineBreak();if(r>1)for(let e of this.points)e.node==t&&e.pos>this.text.length&&(e.pos-=r-1);i=n+r}}readNode(t){if(t.cmIgnore)return;let e=ContentView.get(t);let i=e&&e.overrideDOMText;if(i!=null){this.findPointInside(t,i.length);for(let t=i.iter();!t.next().done;)t.lineBreak?this.lineBreak():this.append(t.value)}else t.nodeType==3?this.readTextNode(t):t.nodeName=="BR"?t.nextSibling&&this.lineBreak():t.nodeType==1&&this.readRange(t.firstChild,null)}findPointBefore(t,e){for(let i of this.points)i.node==t&&t.childNodes[i.offset]==e&&(i.pos=this.text.length)}findPointInside(t,e){for(let i of this.points)(t.nodeType==3?i.node==t:t.contains(i.node))&&(i.pos=this.text.length+(isAtEnd(t,i.node,i.offset)?e:0))}}function isAtEnd(t,e,i){for(;;){if(!e||i<maxOffset(e))return false;if(e==t)return true;i=domIndex(e)+1;e=e.parentNode}}class DOMPoint{constructor(t,e){this.node=t;this.offset=e;this.pos=-1}}class DOMChange{constructor(t,e,i,s){this.typeOver=s;this.bounds=null;this.text="";this.domChanged=e>-1;let{impreciseHead:o,impreciseAnchor:r}=t.docView;if(t.state.readOnly&&e>-1)this.newSel=null;else if(e>-1&&(this.bounds=t.docView.domBoundsAround(e,i,0))){let e=o||r?[]:selectionPoints(t);let i=new DOMReader(e,t.state);i.readRange(this.bounds.startDOM,this.bounds.endDOM);this.text=i.text;this.newSel=selectionFromPoints(e,this.bounds.from)}else{let e=t.observer.selectionRange;let i=o&&o.node==e.focusNode&&o.offset==e.focusOffset||!contains(t.contentDOM,e.focusNode)?t.state.selection.main.head:t.docView.posFromDOM(e.focusNode,e.focusOffset);let s=r&&r.node==e.anchorNode&&r.offset==e.anchorOffset||!contains(t.contentDOM,e.anchorNode)?t.state.selection.main.anchor:t.docView.posFromDOM(e.anchorNode,e.anchorOffset);let l=t.viewport;if((F.ios||F.chrome)&&t.state.selection.main.empty&&i!=s&&(l.from>0||l.to<t.state.doc.length)){let e=Math.min(i,s),o=Math.max(i,s);let n=l.from-e,r=l.to-o;if((n==0||n==1||e==0)&&(r==0||r==-1||o==t.state.doc.length)){i=0;s=t.state.doc.length}}this.newSel=n.single(s,i)}}}function applyDOMChange(e,i){let s;let{newSel:o}=i,r=e.state.selection.main;let l=e.inputState.lastKeyTime>Date.now()-100?e.inputState.lastKeyCode:-1;if(i.bounds){let{from:o,to:n}=i.bounds;let a=r.from,h=null;if(l===8||F.android&&i.text.length<n-o){a=r.to;h="end"}let c=findDiff(e.state.doc.sliceString(o,n,kt),i.text,a-o,h);if(c){F.chrome&&l==13&&c.toB==c.from+2&&i.text.slice(c.from,c.toB)==kt+kt&&c.toB--;s={from:o+c.from,to:o+c.toA,insert:t.of(i.text.slice(c.from,c.toB).split(kt))}}}else o&&(!e.hasFocus&&e.state.facet(ft)||o.main.eq(r))&&(o=null);if(!s&&!o)return false;if(!s&&i.typeOver&&!r.empty&&o&&o.main.empty)s={from:r.from,to:r.to,insert:e.state.doc.slice(r.from,r.to)};else if(s&&s.from>=r.from&&s.to<=r.to&&(s.from!=r.from||s.to!=r.to)&&r.to-r.from-(s.to-s.from)<=4)s={from:r.from,to:r.to,insert:e.state.doc.slice(r.from,s.from).append(s.insert).append(e.state.doc.slice(s.to,r.to))};else if((F.mac||F.android)&&s&&s.from==s.to&&s.from==r.head-1&&/^\. ?$/.test(s.insert.toString())&&e.contentDOM.getAttribute("autocorrect")=="off"){o&&s.insert.length==2&&(o=n.single(o.main.anchor-1,o.main.head-1));s={from:r.from,to:r.to,insert:t.of([" "])}}else if(F.chrome&&s&&s.from==s.to&&s.from==r.head&&s.insert.toString()=="\n "&&e.lineWrapping){o&&(o=n.single(o.main.anchor-1,o.main.head-1));s={from:r.from,to:r.to,insert:t.of([" "])}}if(s)return applyDOMChangeInner(e,s,o,l);if(o&&!o.main.eq(r)){let t=false,i="select";if(e.inputState.lastSelectionTime>Date.now()-50){e.inputState.lastSelectionOrigin=="select"&&(t=true);i=e.inputState.lastSelectionOrigin}e.dispatch({selection:o,scrollIntoView:t,userEvent:i});return true}return false}function applyDOMChangeInner(t,e,i,s=-1){if(F.ios&&t.inputState.flushIOSKey(e))return true;let o=t.state.selection.main;if(F.android&&(e.to==o.to&&(e.from==o.from||e.from==o.from-1&&t.state.sliceDoc(e.from,o.from)==" ")&&e.insert.length==1&&e.insert.lines==2&&dispatchKey(t.contentDOM,"Enter",13)||(e.from==o.from-1&&e.to==o.to&&e.insert.length==0||s==8&&e.insert.length<e.to-e.from&&e.to>o.head)&&dispatchKey(t.contentDOM,"Backspace",8)||e.from==o.from&&e.to==o.to+1&&e.insert.length==0&&dispatchKey(t.contentDOM,"Delete",46)))return true;let n=e.insert.toString();t.inputState.composing>=0&&t.inputState.composing++;let r;let defaultInsert=()=>r||(r=applyDefaultInsert(t,e,i));t.state.facet(ot).some((i=>i(t,e.from,e.to,n,defaultInsert)))||t.dispatch(defaultInsert());return true}function applyDefaultInsert(t,e,i){let s,o=t.state,r=o.selection.main;if(e.from>=r.from&&e.to<=r.to&&e.to-e.from>=(r.to-r.from)/3&&(!i||i.main.empty&&i.main.from==e.from+e.insert.length)&&t.inputState.composing<0){let i=r.from<e.from?o.sliceDoc(r.from,e.from):"";let n=r.to>e.to?o.sliceDoc(e.to,r.to):"";s=o.replaceSelection(t.state.toText(i+e.insert.sliceString(0,void 0,t.state.lineBreak)+n))}else{let l=o.changes(e);let a=i&&i.main.to<=l.newLength?i.main:void 0;if(o.selection.ranges.length>1&&t.inputState.composing>=0&&e.to<=r.to&&e.to>=r.to-10){let h=t.state.sliceDoc(e.from,e.to);let c,d=i&&findCompositionNode(t,i.main.head);if(d){let t=e.insert.length-(e.to-e.from);c={from:d.from,to:d.to-t}}else c=t.state.doc.lineAt(r.head);let u=r.to-e.to,f=r.to-r.from;s=o.changeByRange((i=>{if(i.from==r.from&&i.to==r.to)return{changes:l,range:a||i.map(l)};let s=i.to-u,d=s-h.length;if(i.to-i.from!=f||t.state.sliceDoc(d,s)!=h||i.to>=c.from&&i.from<=c.to)return{range:i};let p=o.changes({from:d,to:s,insert:e.insert}),g=i.to-r.to;return{changes:p,range:a?n.range(Math.max(0,a.anchor+g),Math.max(0,a.head+g)):i.map(p)}}))}else s={changes:l,selection:a&&o.selection.replaceRange(a)}}let l="input.type";if(t.composing||t.inputState.compositionPendingChange&&t.inputState.compositionEndedAt>Date.now()-50){t.inputState.compositionPendingChange=false;l+=".compose";if(t.inputState.compositionFirstChange){l+=".start";t.inputState.compositionFirstChange=false}}return o.update(s,{userEvent:l,scrollIntoView:true})}function findDiff(t,e,i,s){let o=Math.min(t.length,e.length);let n=0;while(n<o&&t.charCodeAt(n)==e.charCodeAt(n))n++;if(n==o&&t.length==e.length)return null;let r=t.length,l=e.length;while(r>0&&l>0&&t.charCodeAt(r-1)==e.charCodeAt(l-1)){r--;l--}if(s=="end"){let t=Math.max(0,n-Math.min(r,l));i-=r+t-n}if(r<n&&t.length<e.length){let t=i<=n&&i>=r?n-i:0;n-=t;l=n+(l-r);r=n}else if(l<n){let t=i<=n&&i>=l?n-i:0;n-=t;r=n+(r-l);l=n}return{from:n,toA:r,toB:l}}function selectionPoints(t){let e=[];if(t.root.activeElement!=t.contentDOM)return e;let{anchorNode:i,anchorOffset:s,focusNode:o,focusOffset:n}=t.observer.selectionRange;if(i){e.push(new DOMPoint(i,s));o==i&&n==s||e.push(new DOMPoint(o,n))}return e}function selectionFromPoints(t,e){if(t.length==0)return null;let i=t[0].pos,s=t.length==2?t[1].pos:i;return i>-1&&s>-1?n.single(i+e,s+e):null}class InputState{setSelectionOrigin(t){this.lastSelectionOrigin=t;this.lastSelectionTime=Date.now()}constructor(t){this.view=t;this.lastKeyCode=0;this.lastKeyTime=0;this.lastTouchTime=0;this.lastFocusTime=0;this.lastScrollTop=0;this.lastScrollLeft=0;this.pendingIOSKey=void 0;this.tabFocusMode=-1;this.lastSelectionOrigin=null;this.lastSelectionTime=0;this.lastContextMenu=0;this.scrollHandlers=[];this.handlers=Object.create(null);this.composing=-1;this.compositionFirstChange=null;this.compositionEndedAt=0;this.compositionPendingKey=false;this.compositionPendingChange=false;this.mouseSelection=null;this.draggedContent=null;this.handleEvent=this.handleEvent.bind(this);this.notifiedFocused=t.hasFocus;F.safari&&t.contentDOM.addEventListener("input",(()=>null));F.gecko&&firefoxCopyCutHack(t.contentDOM.ownerDocument)}handleEvent(t){eventBelongsToEditor(this.view,t)&&!this.ignoreDuringComposition(t)&&(t.type=="keydown"&&this.keydown(t)||this.runHandlers(t.type,t))}runHandlers(t,e){let i=this.handlers[t];if(i){for(let t of i.observers)t(this.view,e);for(let t of i.handlers){if(e.defaultPrevented)break;if(t(this.view,e)){e.preventDefault();break}}}}ensureHandlers(t){let e=computeHandlers(t),i=this.handlers,s=this.view.contentDOM;for(let t in e)if(t!="scroll"){let o=!e[t].handlers.length;let n=i[t];if(n&&o!=!n.handlers.length){s.removeEventListener(t,this.handleEvent);n=null}n||s.addEventListener(t,this.handleEvent,{passive:o})}for(let t in i)t=="scroll"||e[t]||s.removeEventListener(t,this.handleEvent);this.handlers=e}keydown(t){this.lastKeyCode=t.keyCode;this.lastKeyTime=Date.now();if(t.keyCode==9&&this.tabFocusMode>-1&&(!this.tabFocusMode||Date.now()<=this.tabFocusMode))return true;this.tabFocusMode>0&&t.keyCode!=27&&Ot.indexOf(t.keyCode)<0&&(this.tabFocusMode=-1);if(F.android&&F.chrome&&!t.synthetic&&(t.keyCode==13||t.keyCode==8)){this.view.observer.delayAndroidKey(t.key,t.keyCode);return true}let e;if(F.ios&&!t.synthetic&&!t.altKey&&!t.metaKey&&((e=At.find((e=>e.keyCode==t.keyCode)))&&!t.ctrlKey||Dt.indexOf(t.key)>-1&&t.ctrlKey&&!t.shiftKey)){this.pendingIOSKey=e||t;setTimeout((()=>this.flushIOSKey()),250);return true}t.keyCode!=229&&this.view.observer.forceFlush();return false}flushIOSKey(t){let e=this.pendingIOSKey;if(!e)return false;if(e.key=="Enter"&&t&&t.from<t.to&&/^\S+$/.test(t.insert.toString()))return false;this.pendingIOSKey=void 0;return dispatchKey(this.view.contentDOM,e.key,e.keyCode,e instanceof KeyboardEvent?e:void 0)}ignoreDuringComposition(t){if(!/^key/.test(t.type))return false;if(this.composing>0)return true;if(F.safari&&!F.ios&&this.compositionPendingKey&&Date.now()-this.compositionEndedAt<100){this.compositionPendingKey=false;return true}return false}startMouseSelection(t){this.mouseSelection&&this.mouseSelection.destroy();this.mouseSelection=t}update(t){this.view.observer.update(t);this.mouseSelection&&this.mouseSelection.update(t);this.draggedContent&&t.docChanged&&(this.draggedContent=this.draggedContent.map(t.changes));t.transactions.length&&(this.lastKeyCode=this.lastSelectionTime=0)}destroy(){this.mouseSelection&&this.mouseSelection.destroy()}}function bindHandler(t,e){return(i,s)=>{try{return e.call(t,s,i)}catch(t){logException(i.state,t)}}}function computeHandlers(t){let e=Object.create(null);function record(t){return e[t]||(e[t]={observers:[],handlers:[]})}for(let e of t){let t=e.spec;if(t&&t.domEventHandlers)for(let i in t.domEventHandlers){let s=t.domEventHandlers[i];s&&record(i).handlers.push(bindHandler(e.value,s))}if(t&&t.domEventObservers)for(let i in t.domEventObservers){let s=t.domEventObservers[i];s&&record(i).observers.push(bindHandler(e.value,s))}}for(let t in Rt)record(t).handlers.push(Rt[t]);for(let t in Et)record(t).observers.push(Et[t]);return e}const At=[{key:"Backspace",keyCode:8,inputType:"deleteContentBackward"},{key:"Enter",keyCode:13,inputType:"insertParagraph"},{key:"Enter",keyCode:13,inputType:"insertLineBreak"},{key:"Delete",keyCode:46,inputType:"deleteContentForward"}];const Dt="dthko";const Ot=[16,17,18,20,91,92,224,225];const Tt=6;function dragScrollSpeed(t){return Math.max(0,t)*.7+8}function dist(t,e){return Math.max(Math.abs(t.clientX-e.clientX),Math.abs(t.clientY-e.clientY))}class MouseSelection{constructor(t,e,i,s){this.view=t;this.startEvent=e;this.style=i;this.mustSelect=s;this.scrollSpeed={x:0,y:0};this.scrolling=-1;this.lastEvent=e;this.scrollParents=scrollableParents(t.contentDOM);this.atoms=t.state.facet(yt).map((e=>e(t)));let o=t.contentDOM.ownerDocument;o.addEventListener("mousemove",this.move=this.move.bind(this));o.addEventListener("mouseup",this.up=this.up.bind(this));this.extend=e.shiftKey;this.multiple=t.state.facet(d.allowMultipleSelections)&&addsSelectionRange(t,e);this.dragging=!(!isInPrimarySelection(t,e)||getClickType(e)!=1)&&null}start(t){this.dragging===false&&this.select(t)}move(t){if(t.buttons==0)return this.destroy();if(this.dragging||this.dragging==null&&dist(this.startEvent,t)<10)return;this.select(this.lastEvent=t);let e=0,i=0;let s=0,o=0,n=this.view.win.innerWidth,r=this.view.win.innerHeight;this.scrollParents.x&&({left:s,right:n}=this.scrollParents.x.getBoundingClientRect());this.scrollParents.y&&({top:o,bottom:r}=this.scrollParents.y.getBoundingClientRect());let l=getScrollMargins(this.view);t.clientX-l.left<=s+Tt?e=-dragScrollSpeed(s-t.clientX):t.clientX+l.right>=n-Tt&&(e=dragScrollSpeed(t.clientX-n));t.clientY-l.top<=o+Tt?i=-dragScrollSpeed(o-t.clientY):t.clientY+l.bottom>=r-Tt&&(i=dragScrollSpeed(t.clientY-r));this.setScrollSpeed(e,i)}up(t){this.dragging==null&&this.select(this.lastEvent);this.dragging||t.preventDefault();this.destroy()}destroy(){this.setScrollSpeed(0,0);let t=this.view.contentDOM.ownerDocument;t.removeEventListener("mousemove",this.move);t.removeEventListener("mouseup",this.up);this.view.inputState.mouseSelection=this.view.inputState.draggedContent=null}setScrollSpeed(t,e){this.scrollSpeed={x:t,y:e};if(t||e)this.scrolling<0&&(this.scrolling=setInterval((()=>this.scroll()),50));else if(this.scrolling>-1){clearInterval(this.scrolling);this.scrolling=-1}}scroll(){let{x:t,y:e}=this.scrollSpeed;if(t&&this.scrollParents.x){this.scrollParents.x.scrollLeft+=t;t=0}if(e&&this.scrollParents.y){this.scrollParents.y.scrollTop+=e;e=0}(t||e)&&this.view.win.scrollBy(t,e);this.dragging===false&&this.select(this.lastEvent)}skipAtoms(t){let e=null;for(let i=0;i<t.ranges.length;i++){let s=t.ranges[i],o=null;if(s.empty){let t=skipAtomicRanges(this.atoms,s.from,0);t!=s.from&&(o=n.cursor(t,-1))}else{let t=skipAtomicRanges(this.atoms,s.from,-1);let e=skipAtomicRanges(this.atoms,s.to,1);t==s.from&&e==s.to||(o=n.range(s.from==s.anchor?t:e,s.from==s.head?t:e))}if(o){e||(e=t.ranges.slice());e[i]=o}}return e?n.create(e,t.mainIndex):t}select(t){let{view:e}=this,i=this.skipAtoms(this.style.get(t,this.extend,this.multiple));!this.mustSelect&&i.eq(e.state.selection,this.dragging===false)||this.view.dispatch({selection:i,userEvent:"select.pointer"});this.mustSelect=false}update(t){t.transactions.some((t=>t.isUserEvent("input.type")))?this.destroy():this.style.update(t)&&setTimeout((()=>this.select(this.lastEvent)),20)}}function addsSelectionRange(t,e){let i=t.state.facet(Z);return i.length?i[0](e):F.mac?e.metaKey:e.ctrlKey}function dragMovesSelection(t,e){let i=t.state.facet(tt);return i.length?i[0](e):F.mac?!e.altKey:!e.ctrlKey}function isInPrimarySelection(t,e){let{main:i}=t.state.selection;if(i.empty)return false;let s=getSelection(t.root);if(!s||s.rangeCount==0)return true;let o=s.getRangeAt(0).getClientRects();for(let t=0;t<o.length;t++){let i=o[t];if(i.left<=e.clientX&&i.right>=e.clientX&&i.top<=e.clientY&&i.bottom>=e.clientY)return true}return false}function eventBelongsToEditor(t,e){if(!e.bubbles)return true;if(e.defaultPrevented)return false;for(let i,s=e.target;s!=t.contentDOM;s=s.parentNode)if(!s||s.nodeType==11||(i=ContentView.get(s))&&i.ignoreEvent(e))return false;return true}const Rt=Object.create(null);const Et=Object.create(null);const Vt=F.ie&&F.ie_version<15||F.ios&&F.webkit_version<604;function capturePaste(t){let e=t.dom.parentNode;if(!e)return;let i=e.appendChild(document.createElement("textarea"));i.style.cssText="position: fixed; left: -10000px; top: 10px";i.focus();setTimeout((()=>{t.focus();i.remove();doPaste(t,i.value)}),50)}function textFilter(t,e,i){for(let s of t.facet(e))i=s(i,t);return i}function doPaste(t,e){e=textFilter(t.state,rt,e);let i,{state:s}=t,o=1,r=s.toText(e);let l=r.lines==s.selection.ranges.length;let a=Nt!=null&&s.selection.ranges.every((t=>t.empty))&&Nt==r.toString();if(a){let t=-1;i=s.changeByRange((i=>{let a=s.doc.lineAt(i.from);if(a.from==t)return{range:i};t=a.from;let h=s.toText((l?r.line(o++).text:e)+s.lineBreak);return{changes:{from:a.from,insert:h},range:n.cursor(i.from+h.length)}}))}else i=l?s.changeByRange((t=>{let e=r.line(o++);return{changes:{from:t.from,to:t.to,insert:e.text},range:n.cursor(t.from+e.length)}})):s.replaceSelection(r);t.dispatch(i,{userEvent:"input.paste",scrollIntoView:true})}Et.scroll=t=>{t.inputState.lastScrollTop=t.scrollDOM.scrollTop;t.inputState.lastScrollLeft=t.scrollDOM.scrollLeft};Rt.keydown=(t,e)=>{t.inputState.setSelectionOrigin("select");e.keyCode==27&&t.inputState.tabFocusMode!=0&&(t.inputState.tabFocusMode=Date.now()+2e3);return false};Et.touchstart=(t,e)=>{t.inputState.lastTouchTime=Date.now();t.inputState.setSelectionOrigin("select.pointer")};Et.touchmove=t=>{t.inputState.setSelectionOrigin("select.pointer")};Rt.mousedown=(t,e)=>{t.observer.flush();if(t.inputState.lastTouchTime>Date.now()-2e3)return false;let i=null;for(let s of t.state.facet(et)){i=s(t,e);if(i)break}i||e.button!=0||(i=basicMouseSelection(t,e));if(i){let s=!t.hasFocus;t.inputState.startMouseSelection(new MouseSelection(t,e,i,s));s&&t.observer.ignore((()=>{focusPreventScroll(t.contentDOM);let e=t.root.activeElement;e&&!e.contains(t.contentDOM)&&e.blur()}));let o=t.inputState.mouseSelection;if(o){o.start(e);return o.dragging===false}}return false};function rangeForClick(t,e,i,s){if(s==1)return n.cursor(e,i);if(s==2)return groupAt(t.state,e,i);{let i=LineView.find(t.docView,e),s=t.state.doc.lineAt(i?i.posAtEnd:e);let o=i?i.posAtStart:s.from,r=i?i.posAtEnd:s.to;r<t.state.doc.length&&r==s.to&&r++;return n.range(o,r)}}let inside=(t,e,i)=>e>=i.top&&e<=i.bottom&&t>=i.left&&t<=i.right;function findPositionSide(t,e,i,s){let o=LineView.find(t.docView,e);if(!o)return 1;let n=e-o.posAtStart;if(n==0)return 1;if(n==o.length)return-1;let r=o.coordsAt(n,-1);if(r&&inside(i,s,r))return-1;let l=o.coordsAt(n,1);return l&&inside(i,s,l)?1:r&&r.bottom>=s?-1:1}function queryPos(t,e){let i=t.posAtCoords({x:e.clientX,y:e.clientY},false);return{pos:i,bias:findPositionSide(t,i,e.clientX,e.clientY)}}const Bt=F.ie&&F.ie_version<=11;let Pt=null,Lt=0,Ht=0;function getClickType(t){if(!Bt)return t.detail;let e=Pt,i=Ht;Pt=t;Ht=Date.now();return Lt=!e||i>Date.now()-400&&Math.abs(e.clientX-t.clientX)<2&&Math.abs(e.clientY-t.clientY)<2?(Lt+1)%3:1}function basicMouseSelection(t,e){let i=queryPos(t,e),s=getClickType(e);let o=t.state.selection;return{update(t){if(t.docChanged){i.pos=t.changes.mapPos(i.pos);o=o.map(t.changes)}},get(e,r,l){let a,h=queryPos(t,e);let c=rangeForClick(t,h.pos,h.bias,s);if(i.pos!=h.pos&&!r){let e=rangeForClick(t,i.pos,i.bias,s);let o=Math.min(e.from,c.from),r=Math.max(e.to,c.to);c=o<c.from?n.range(o,r):n.range(r,o)}return r?o.replaceRange(o.main.extend(c.from,c.to)):l&&s==1&&o.ranges.length>1&&(a=removeRangeAround(o,h.pos))?a:l?o.addRange(c):n.create([c])}}}function removeRangeAround(t,e){for(let i=0;i<t.ranges.length;i++){let{from:s,to:o}=t.ranges[i];if(s<=e&&o>=e)return n.create(t.ranges.slice(0,i).concat(t.ranges.slice(i+1)),t.mainIndex==i?0:t.mainIndex-(t.mainIndex>i?1:0))}return null}Rt.dragstart=(t,e)=>{let{selection:{main:i}}=t.state;if(e.target.draggable){let s=t.docView.nearest(e.target);if(s&&s.isWidget){let t=s.posAtStart,e=t+s.length;(t>=i.to||e<=i.from)&&(i=n.range(t,e))}}let{inputState:s}=t;s.mouseSelection&&(s.mouseSelection.dragging=true);s.draggedContent=i;if(e.dataTransfer){e.dataTransfer.setData("Text",textFilter(t.state,lt,t.state.sliceDoc(i.from,i.to)));e.dataTransfer.effectAllowed="copyMove"}return false};Rt.dragend=t=>{t.inputState.draggedContent=null;return false};function dropText(t,e,i,s){i=textFilter(t.state,rt,i);if(!i)return;let o=t.posAtCoords({x:e.clientX,y:e.clientY},false);let{draggedContent:n}=t.inputState;let r=s&&n&&dragMovesSelection(t,e)?{from:n.from,to:n.to}:null;let l={from:o,insert:i};let a=t.state.changes(r?[r,l]:l);t.focus();t.dispatch({changes:a,selection:{anchor:a.mapPos(o,-1),head:a.mapPos(o,1)},userEvent:r?"move.drop":"input.drop"});t.inputState.draggedContent=null}Rt.drop=(t,e)=>{if(!e.dataTransfer)return false;if(t.state.readOnly)return true;let i=e.dataTransfer.files;if(i&&i.length){let s=Array(i.length),o=0;let finishFile=()=>{++o==i.length&&dropText(t,e,s.filter((t=>t!=null)).join(t.state.lineBreak),false)};for(let t=0;t<i.length;t++){let e=new FileReader;e.onerror=finishFile;e.onload=()=>{/[\x00-\x08\x0e-\x1f]{2}/.test(e.result)||(s[t]=e.result);finishFile()};e.readAsText(i[t])}return true}{let i=e.dataTransfer.getData("Text");if(i){dropText(t,e,i,true);return true}}return false};Rt.paste=(t,e)=>{if(t.state.readOnly)return true;t.observer.flush();let i=Vt?null:e.clipboardData;if(i){doPaste(t,i.getData("text/plain")||i.getData("text/uri-list"));return true}capturePaste(t);return false};function captureCopy(t,e){let i=t.dom.parentNode;if(!i)return;let s=i.appendChild(document.createElement("textarea"));s.style.cssText="position: fixed; left: -10000px; top: 10px";s.value=e;s.focus();s.selectionEnd=e.length;s.selectionStart=0;setTimeout((()=>{s.remove();t.focus()}),50)}function copiedRange(t){let e=[],i=[],s=false;for(let s of t.selection.ranges)if(!s.empty){e.push(t.sliceDoc(s.from,s.to));i.push(s)}if(!e.length){let o=-1;for(let{from:s}of t.selection.ranges){let n=t.doc.lineAt(s);if(n.number>o){e.push(n.text);i.push({from:n.from,to:Math.min(t.doc.length,n.to+1)})}o=n.number}s=true}return{text:textFilter(t,lt,e.join(t.lineBreak)),ranges:i,linewise:s}}let Nt=null;Rt.copy=Rt.cut=(t,e)=>{let{text:i,ranges:s,linewise:o}=copiedRange(t.state);if(!i&&!o)return false;Nt=o?i:null;e.type!="cut"||t.state.readOnly||t.dispatch({changes:s,scrollIntoView:true,userEvent:"delete.cut"});let n=Vt?null:e.clipboardData;if(n){n.clearData();n.setData("text/plain",i);return true}captureCopy(t,i);return false};const Wt=u.define();function focusChangeTransaction(t,e){let i=[];for(let s of t.facet(nt)){let o=s(t,e);o&&i.push(o)}return i?t.update({effects:i,annotations:Wt.of(true)}):null}function updateForFocusChange(t){setTimeout((()=>{let e=t.hasFocus;if(e!=t.inputState.notifiedFocused){let i=focusChangeTransaction(t.state,e);i?t.dispatch(i):t.update([])}}),10)}Et.focus=t=>{t.inputState.lastFocusTime=Date.now();if(!t.scrollDOM.scrollTop&&(t.inputState.lastScrollTop||t.inputState.lastScrollLeft)){t.scrollDOM.scrollTop=t.inputState.lastScrollTop;t.scrollDOM.scrollLeft=t.inputState.lastScrollLeft}updateForFocusChange(t)};Et.blur=t=>{t.observer.clearSelectionRange();updateForFocusChange(t)};Et.compositionstart=Et.compositionupdate=t=>{if(!t.observer.editContext){t.inputState.compositionFirstChange==null&&(t.inputState.compositionFirstChange=true);t.inputState.composing<0&&(t.inputState.composing=0)}};Et.compositionend=t=>{if(!t.observer.editContext){t.inputState.composing=-1;t.inputState.compositionEndedAt=Date.now();t.inputState.compositionPendingKey=true;t.inputState.compositionPendingChange=t.observer.pendingRecords().length>0;t.inputState.compositionFirstChange=null;F.chrome&&F.android?t.observer.flushSoon():t.inputState.compositionPendingChange?Promise.resolve().then((()=>t.observer.flush())):setTimeout((()=>{t.inputState.composing<0&&t.docView.hasComposition&&t.update([])}),50)}};Et.contextmenu=t=>{t.inputState.lastContextMenu=Date.now()};Rt.beforeinput=(t,e)=>{var i,s;if(e.inputType=="insertReplacementText"&&t.observer.editContext){let s=(i=e.dataTransfer)===null||i===void 0?void 0:i.getData("text/plain"),o=e.getTargetRanges();if(s&&o.length){let e=o[0];let i=t.posAtDOM(e.startContainer,e.startOffset),n=t.posAtDOM(e.endContainer,e.endOffset);applyDOMChangeInner(t,{from:i,to:n,insert:t.state.toText(s)},null);return true}}let o;if(F.chrome&&F.android&&(o=At.find((t=>t.inputType==e.inputType)))){t.observer.delayAndroidKey(o.key,o.keyCode);if(o.key=="Backspace"||o.key=="Delete"){let e=((s=window.visualViewport)===null||s===void 0?void 0:s.height)||0;setTimeout((()=>{var i;if((((i=window.visualViewport)===null||i===void 0?void 0:i.height)||0)>e+10&&t.hasFocus){t.contentDOM.blur();t.focus()}}),100)}}F.ios&&e.inputType=="deleteContentForward"&&t.observer.flushSoon();F.safari&&e.inputType=="insertText"&&t.inputState.composing>=0&&setTimeout((()=>Et.compositionend(t,e)),20);return false};const Ft=new Set;function firefoxCopyCutHack(t){if(!Ft.has(t)){Ft.add(t);t.addEventListener("copy",(()=>{}));t.addEventListener("cut",(()=>{}))}}const It=["pre-wrap","normal","pre-line","break-spaces"];let zt=false;function clearHeightChangeFlag(){zt=false}class HeightOracle{constructor(e){this.lineWrapping=e;this.doc=t.empty;this.heightSamples={};this.lineHeight=14;this.charWidth=7;this.textHeight=14;this.lineLength=30}heightForGap(t,e){let i=this.doc.lineAt(e).number-this.doc.lineAt(t).number+1;this.lineWrapping&&(i+=Math.max(0,Math.ceil((e-t-i*this.lineLength*.5)/this.lineLength)));return this.lineHeight*i}heightForLine(t){if(!this.lineWrapping)return this.lineHeight;let e=1+Math.max(0,Math.ceil((t-this.lineLength)/(this.lineLength-5)));return e*this.lineHeight}setDoc(t){this.doc=t;return this}mustRefreshForWrapping(t){return It.indexOf(t)>-1!=this.lineWrapping}mustRefreshForHeights(t){let e=false;for(let i=0;i<t.length;i++){let s=t[i];if(s<0)i++;else if(!this.heightSamples[Math.floor(s*10)]){e=true;this.heightSamples[Math.floor(s*10)]=true}}return e}refresh(t,e,i,s,o,n){let r=It.indexOf(t)>-1;let l=Math.round(e)!=Math.round(this.lineHeight)||this.lineWrapping!=r;this.lineWrapping=r;this.lineHeight=e;this.charWidth=i;this.textHeight=s;this.lineLength=o;if(l){this.heightSamples={};for(let t=0;t<n.length;t++){let e=n[t];e<0?t++:this.heightSamples[Math.floor(e*10)]=true}}return l}}class MeasuredHeights{constructor(t,e){this.from=t;this.heights=e;this.index=0}get more(){return this.index<this.heights.length}}class BlockInfo{constructor(t,e,i,s,o){this.from=t;this.length=e;this.top=i;this.height=s;this._content=o}get type(){return typeof this._content=="number"?q.Text:Array.isArray(this._content)?this._content:this._content.type}get to(){return this.from+this.length}get bottom(){return this.top+this.height}get widget(){return this._content instanceof PointDecoration?this._content.widget:null}get widgetLineBreaks(){return typeof this._content=="number"?this._content:0}join(t){let e=(Array.isArray(this._content)?this._content:[this]).concat(Array.isArray(t._content)?t._content:[t]);return new BlockInfo(this.from,this.length+t.length,this.top,this.height+t.height,e)}}var qt=function(t){t[t.ByPos=0]="ByPos";t[t.ByHeight=1]="ByHeight";t[t.ByPosNoHeight=2]="ByPosNoHeight";return t}(qt||(qt={}));const Kt=.001;class HeightMap{constructor(t,e,i=2){this.length=t;this.height=e;this.flags=i}get outdated(){return(this.flags&2)>0}set outdated(t){this.flags=(t?2:0)|this.flags&-3}setHeight(t){if(this.height!=t){Math.abs(this.height-t)>Kt&&(zt=true);this.height=t}}replace(t,e,i){return HeightMap.of(i)}decomposeLeft(t,e){e.push(this)}decomposeRight(t,e){e.push(this)}applyChanges(t,e,i,s){let o=this,n=i.doc;for(let r=s.length-1;r>=0;r--){let{fromA:l,toA:a,fromB:h,toB:c}=s[r];let d=o.lineAt(l,qt.ByPosNoHeight,i.setDoc(e),0,0);let u=d.to>=a?d:o.lineAt(a,qt.ByPosNoHeight,i,0,0);c+=u.to-a;a=u.to;while(r>0&&d.from<=s[r-1].toA){l=s[r-1].fromA;h=s[r-1].fromB;r--;l<d.from&&(d=o.lineAt(l,qt.ByPosNoHeight,i,0,0))}h+=d.from-l;l=d.from;let f=NodeBuilder.build(i.setDoc(n),t,h,c);o=replace(o,o.replace(l,a,f))}return o.updateHeight(i,0)}static empty(){return new HeightMapText(0,0)}static of(t){if(t.length==1)return t[0];let e=0,i=t.length,s=0,o=0;for(;;)if(e==i)if(s>o*2){let o=t[e-1];o.break?t.splice(--e,1,o.left,null,o.right):t.splice(--e,1,o.left,o.right);i+=1+o.break;s-=o.size}else{if(!(o>s*2))break;{let e=t[i];e.break?t.splice(i,1,e.left,null,e.right):t.splice(i,1,e.left,e.right);i+=2+e.break;o-=e.size}}else if(s<o){let i=t[e++];i&&(s+=i.size)}else{let e=t[--i];e&&(o+=e.size)}let n=0;if(t[e-1]==null){n=1;e--}else if(t[e]==null){n=1;i++}return new HeightMapBranch(HeightMap.of(t.slice(0,e)),n,HeightMap.of(t.slice(i)))}}function replace(t,e){if(t==e)return t;t.constructor!=e.constructor&&(zt=true);return e}HeightMap.prototype.size=1;class HeightMapBlock extends HeightMap{constructor(t,e,i){super(t,e);this.deco=i}blockAt(t,e,i,s){return new BlockInfo(s,this.length,i,this.height,this.deco||0)}lineAt(t,e,i,s,o){return this.blockAt(0,i,s,o)}forEachLine(t,e,i,s,o,n){t<=o+this.length&&e>=o&&n(this.blockAt(0,i,s,o))}updateHeight(t,e=0,i=false,s){s&&s.from<=e&&s.more&&this.setHeight(s.heights[s.index++]);this.outdated=false;return this}toString(){return`block(${this.length})`}}class HeightMapText extends HeightMapBlock{constructor(t,e){super(t,e,null);this.collapsed=0;this.widgetHeight=0;this.breaks=0}blockAt(t,e,i,s){return new BlockInfo(s,this.length,i,this.height,this.breaks)}replace(t,e,i){let s=i[0];if(i.length==1&&(s instanceof HeightMapText||s instanceof HeightMapGap&&s.flags&4)&&Math.abs(this.length-s.length)<10){s instanceof HeightMapGap?s=new HeightMapText(s.length,this.height):s.height=this.height;this.outdated||(s.outdated=false);return s}return HeightMap.of(i)}updateHeight(t,e=0,i=false,s){s&&s.from<=e&&s.more?this.setHeight(s.heights[s.index++]):(i||this.outdated)&&this.setHeight(Math.max(this.widgetHeight,t.heightForLine(this.length-this.collapsed))+this.breaks*t.lineHeight);this.outdated=false;return this}toString(){return`line(${this.length}${this.collapsed?-this.collapsed:""}${this.widgetHeight?":"+this.widgetHeight:""})`}}class HeightMapGap extends HeightMap{constructor(t){super(t,0)}heightMetrics(t,e){let i=t.doc.lineAt(e).number,s=t.doc.lineAt(e+this.length).number;let o=s-i+1;let n,r=0;if(t.lineWrapping){let e=Math.min(this.height,t.lineHeight*o);n=e/o;this.length>o+1&&(r=(this.height-e)/(this.length-o-1))}else n=this.height/o;return{firstLine:i,lastLine:s,perLine:n,perChar:r}}blockAt(t,e,i,s){let{firstLine:o,lastLine:n,perLine:r,perChar:l}=this.heightMetrics(e,s);if(e.lineWrapping){let o=s+(t<e.lineHeight?0:Math.round(Math.max(0,Math.min(1,(t-i)/this.height))*this.length));let n=e.doc.lineAt(o),a=r+n.length*l;let h=Math.max(i,t-a/2);return new BlockInfo(n.from,n.length,h,a,0)}{let s=Math.max(0,Math.min(n-o,Math.floor((t-i)/r)));let{from:l,length:a}=e.doc.line(o+s);return new BlockInfo(l,a,i+r*s,r,0)}}lineAt(t,e,i,s,o){if(e==qt.ByHeight)return this.blockAt(t,i,s,o);if(e==qt.ByPosNoHeight){let{from:e,to:s}=i.doc.lineAt(t);return new BlockInfo(e,s-e,0,0,0)}let{firstLine:n,perLine:r,perChar:l}=this.heightMetrics(i,o);let a=i.doc.lineAt(t),h=r+a.length*l;let c=a.number-n;let d=s+r*c+l*(a.from-o-c);return new BlockInfo(a.from,a.length,Math.max(s,Math.min(d,s+this.height-h)),h,0)}forEachLine(t,e,i,s,o,n){t=Math.max(t,o);e=Math.min(e,o+this.length);let{firstLine:r,perLine:l,perChar:a}=this.heightMetrics(i,o);for(let h=t,c=s;h<=e;){let e=i.doc.lineAt(h);if(h==t){let i=e.number-r;c+=l*i+a*(t-o-i)}let s=l+a*e.length;n(new BlockInfo(e.from,e.length,c,s,0));c+=s;h=e.to+1}}replace(t,e,i){let s=this.length-e;if(s>0){let t=i[i.length-1];t instanceof HeightMapGap?i[i.length-1]=new HeightMapGap(t.length+s):i.push(null,new HeightMapGap(s-1))}if(t>0){let e=i[0];e instanceof HeightMapGap?i[0]=new HeightMapGap(t+e.length):i.unshift(new HeightMapGap(t-1),null)}return HeightMap.of(i)}decomposeLeft(t,e){e.push(new HeightMapGap(t-1),null)}decomposeRight(t,e){e.push(null,new HeightMapGap(this.length-t-1))}updateHeight(t,e=0,i=false,s){let o=e+this.length;if(s&&s.from<=e+this.length&&s.more){let i=[],n=Math.max(e,s.from),r=-1;s.from>e&&i.push(new HeightMapGap(s.from-e-1).updateHeight(t,e));while(n<=o&&s.more){let e=t.doc.lineAt(n).length;i.length&&i.push(null);let o=s.heights[s.index++];r==-1?r=o:Math.abs(o-r)>=Kt&&(r=-2);let l=new HeightMapText(e,o);l.outdated=false;i.push(l);n+=e+1}n<=o&&i.push(null,new HeightMapGap(o-n).updateHeight(t,n));let l=HeightMap.of(i);(r<0||Math.abs(l.height-this.height)>=Kt||Math.abs(r-this.heightMetrics(t,e).perLine)>=Kt)&&(zt=true);return replace(this,l)}if(i||this.outdated){this.setHeight(t.heightForGap(e,e+this.length));this.outdated=false}return this}toString(){return`gap(${this.length})`}}class HeightMapBranch extends HeightMap{constructor(t,e,i){super(t.length+e+i.length,t.height+i.height,e|(t.outdated||i.outdated?2:0));this.left=t;this.right=i;this.size=t.size+i.size}get break(){return this.flags&1}blockAt(t,e,i,s){let o=i+this.left.height;return t<o?this.left.blockAt(t,e,i,s):this.right.blockAt(t,e,o,s+this.left.length+this.break)}lineAt(t,e,i,s,o){let n=s+this.left.height,r=o+this.left.length+this.break;let l=e==qt.ByHeight?t<n:t<r;let a=l?this.left.lineAt(t,e,i,s,o):this.right.lineAt(t,e,i,n,r);if(this.break||(l?a.to<r:a.from>r))return a;let h=e==qt.ByPosNoHeight?qt.ByPosNoHeight:qt.ByPos;return l?a.join(this.right.lineAt(r,h,i,n,r)):this.left.lineAt(r,h,i,s,o).join(a)}forEachLine(t,e,i,s,o,n){let r=s+this.left.height,l=o+this.left.length+this.break;if(this.break){t<l&&this.left.forEachLine(t,e,i,s,o,n);e>=l&&this.right.forEachLine(t,e,i,r,l,n)}else{let a=this.lineAt(l,qt.ByPos,i,s,o);t<a.from&&this.left.forEachLine(t,a.from-1,i,s,o,n);a.to>=t&&a.from<=e&&n(a);e>a.to&&this.right.forEachLine(a.to+1,e,i,r,l,n)}}replace(t,e,i){let s=this.left.length+this.break;if(e<s)return this.balanced(this.left.replace(t,e,i),this.right);if(t>this.left.length)return this.balanced(this.left,this.right.replace(t-s,e-s,i));let o=[];t>0&&this.decomposeLeft(t,o);let n=o.length;for(let t of i)o.push(t);t>0&&mergeGaps(o,n-1);if(e<this.length){let t=o.length;this.decomposeRight(e,o);mergeGaps(o,t)}return HeightMap.of(o)}decomposeLeft(t,e){let i=this.left.length;if(t<=i)return this.left.decomposeLeft(t,e);e.push(this.left);if(this.break){i++;t>=i&&e.push(null)}t>i&&this.right.decomposeLeft(t-i,e)}decomposeRight(t,e){let i=this.left.length,s=i+this.break;if(t>=s)return this.right.decomposeRight(t-s,e);t<i&&this.left.decomposeRight(t,e);this.break&&t<s&&e.push(null);e.push(this.right)}balanced(t,e){if(t.size>2*e.size||e.size>2*t.size)return HeightMap.of(this.break?[t,null,e]:[t,e]);this.left=replace(this.left,t);this.right=replace(this.right,e);this.setHeight(t.height+e.height);this.outdated=t.outdated||e.outdated;this.size=t.size+e.size;this.length=t.length+this.break+e.length;return this}updateHeight(t,e=0,i=false,s){let{left:o,right:n}=this,r=e+o.length+this.break,l=null;s&&s.from<=e+o.length&&s.more?l=o=o.updateHeight(t,e,i,s):o.updateHeight(t,e,i);s&&s.from<=r+n.length&&s.more?l=n=n.updateHeight(t,r,i,s):n.updateHeight(t,r,i);if(l)return this.balanced(o,n);this.height=this.left.height+this.right.height;this.outdated=false;return this}toString(){return this.left+(this.break?" ":"-")+this.right}}function mergeGaps(t,e){let i,s;t[e]==null&&(i=t[e-1])instanceof HeightMapGap&&(s=t[e+1])instanceof HeightMapGap&&t.splice(e-1,3,new HeightMapGap(i.length+1+s.length))}const Gt=5;class NodeBuilder{constructor(t,e){this.pos=t;this.oracle=e;this.nodes=[];this.lineStart=-1;this.lineEnd=-1;this.covering=null;this.writtenTo=t}get isCovered(){return this.covering&&this.nodes[this.nodes.length-1]==this.covering}span(t,e){if(this.lineStart>-1){let t=Math.min(e,this.lineEnd),i=this.nodes[this.nodes.length-1];i instanceof HeightMapText?i.length+=t-this.pos:(t>this.pos||!this.isCovered)&&this.nodes.push(new HeightMapText(t-this.pos,-1));this.writtenTo=t;if(e>t){this.nodes.push(null);this.writtenTo++;this.lineStart=-1}}this.pos=e}point(t,e,i){if(t<e||i.heightRelevant){let s=i.widget?i.widget.estimatedHeight:0;let o=i.widget?i.widget.lineBreaks:0;s<0&&(s=this.oracle.lineHeight);let n=e-t;i.block?this.addBlock(new HeightMapBlock(n,s,i)):(n||o||s>=Gt)&&this.addLineDeco(s,o,n)}else e>t&&this.span(t,e);this.lineEnd>-1&&this.lineEnd<this.pos&&(this.lineEnd=this.oracle.doc.lineAt(this.pos).to)}enterLine(){if(this.lineStart>-1)return;let{from:t,to:e}=this.oracle.doc.lineAt(this.pos);this.lineStart=t;this.lineEnd=e;if(this.writtenTo<t){(this.writtenTo<t-1||this.nodes[this.nodes.length-1]==null)&&this.nodes.push(this.blankContent(this.writtenTo,t-1));this.nodes.push(null)}this.pos>t&&this.nodes.push(new HeightMapText(this.pos-t,-1));this.writtenTo=this.pos}blankContent(t,e){let i=new HeightMapGap(e-t);this.oracle.doc.lineAt(t).to==e&&(i.flags|=4);return i}ensureLine(){this.enterLine();let t=this.nodes.length?this.nodes[this.nodes.length-1]:null;if(t instanceof HeightMapText)return t;let e=new HeightMapText(0,-1);this.nodes.push(e);return e}addBlock(t){this.enterLine();let e=t.deco;e&&e.startSide>0&&!this.isCovered&&this.ensureLine();this.nodes.push(t);this.writtenTo=this.pos=this.pos+t.length;e&&e.endSide>0&&(this.covering=t)}addLineDeco(t,e,i){let s=this.ensureLine();s.length+=i;s.collapsed+=i;s.widgetHeight=Math.max(s.widgetHeight,t);s.breaks+=e;this.writtenTo=this.pos=this.pos+i}finish(t){let e=this.nodes.length==0?null:this.nodes[this.nodes.length-1];!(this.lineStart>-1)||e instanceof HeightMapText||this.isCovered?(this.writtenTo<this.pos||e==null)&&this.nodes.push(this.blankContent(this.writtenTo,this.pos)):this.nodes.push(new HeightMapText(0,-1));let i=t;for(let t of this.nodes){t instanceof HeightMapText&&t.updateHeight(this.oracle,i);i+=t?t.length:1}return this.nodes}static build(t,e,s,o){let n=new NodeBuilder(s,t);i.spans(e,s,o,n,0);return n.finish(s)}}function heightRelevantDecoChanges(t,e,s){let o=new DecorationComparator;i.compare(t,e,s,o,0);return o.changes}class DecorationComparator{constructor(){this.changes=[]}compareRange(){}comparePoint(t,e,i,s){(t<e||i&&i.heightRelevant||s&&s.heightRelevant)&&addRange(t,e,this.changes,5)}}function visiblePixelRange(t,e){let i=t.getBoundingClientRect();let s=t.ownerDocument,o=s.defaultView||window;let n=Math.max(0,i.left),r=Math.min(o.innerWidth,i.right);let l=Math.max(0,i.top),a=Math.min(o.innerHeight,i.bottom);for(let e=t.parentNode;e&&e!=s.body;)if(e.nodeType==1){let i=e;let s=window.getComputedStyle(i);if((i.scrollHeight>i.clientHeight||i.scrollWidth>i.clientWidth)&&s.overflow!="visible"){let s=i.getBoundingClientRect();n=Math.max(n,s.left);r=Math.min(r,s.right);l=Math.max(l,s.top);a=Math.min(e==t.parentNode?o.innerHeight:a,s.bottom)}e=s.position=="absolute"||s.position=="fixed"?i.offsetParent:i.parentNode}else{if(e.nodeType!=11)break;e=e.host}return{left:n-i.left,right:Math.max(n,r)-i.left,top:l-(i.top+e),bottom:Math.max(l,a)-(i.top+e)}}function fullPixelRange(t,e){let i=t.getBoundingClientRect();return{left:0,right:i.right-i.left,top:e,bottom:i.bottom-(i.top+e)}}class LineGap{constructor(t,e,i,s){this.from=t;this.to=e;this.size=i;this.displaySize=s}static same(t,e){if(t.length!=e.length)return false;for(let i=0;i<t.length;i++){let s=t[i],o=e[i];if(s.from!=o.from||s.to!=o.to||s.size!=o.size)return false}return true}draw(t,e){return Decoration.replace({widget:new LineGapWidget(this.displaySize*(e?t.scaleY:t.scaleX),e)}).range(this.from,this.to)}}class LineGapWidget extends WidgetType{constructor(t,e){super();this.size=t;this.vertical=e}eq(t){return t.size==this.size&&t.vertical==this.vertical}toDOM(){let t=document.createElement("div");if(this.vertical)t.style.height=this.size+"px";else{t.style.width=this.size+"px";t.style.height="2px";t.style.display="inline-block"}return t}get estimatedHeight(){return this.vertical?this.size:-1}}class ViewState{constructor(e){this.state=e;this.pixelViewport={left:0,right:window.innerWidth,top:0,bottom:0};this.inView=true;this.paddingTop=0;this.paddingBottom=0;this.contentDOMWidth=0;this.contentDOMHeight=0;this.editorHeight=0;this.editorWidth=0;this.scrollTop=0;this.scrolledToBottom=false;this.scaleX=1;this.scaleY=1;this.scrollAnchorPos=0;this.scrollAnchorHeight=-1;this.scaler=Yt;this.scrollTarget=null;this.printing=false;this.mustMeasureContent=true;this.defaultTextDirection=K.LTR;this.visibleRanges=[];this.mustEnforceCursorAssoc=false;let i=e.facet(wt).some((t=>typeof t!="function"&&t.class=="cm-lineWrapping"));this.heightOracle=new HeightOracle(i);this.stateDeco=e.facet(vt).filter((t=>typeof t!="function"));this.heightMap=HeightMap.empty().applyChanges(this.stateDeco,t.empty,this.heightOracle.setDoc(e.doc),[new ChangedRange(0,0,0,e.doc.length)]);for(let t=0;t<2;t++){this.viewport=this.getViewport(0,null);if(!this.updateForViewport())break}this.updateViewportLines();this.lineGaps=this.ensureLineGaps([]);this.lineGapDeco=Decoration.set(this.lineGaps.map((t=>t.draw(this,false))));this.computeVisibleRanges()}updateForViewport(){let t=[this.viewport],{main:e}=this.state.selection;for(let i=0;i<=1;i++){let s=i?e.head:e.anchor;if(!t.some((({from:t,to:e})=>s>=t&&s<=e))){let{from:e,to:i}=this.lineBlockAt(s);t.push(new Viewport(e,i))}}this.viewports=t.sort(((t,e)=>t.from-e.from));return this.updateScaler()}updateScaler(){let t=this.scaler;this.scaler=this.heightMap.height<=7e6?Yt:new BigScaler(this.heightOracle,this.heightMap,this.viewports);return t.eq(this.scaler)?0:2}updateViewportLines(){this.viewportLines=[];this.heightMap.forEachLine(this.viewport.from,this.viewport.to,this.heightOracle.setDoc(this.state.doc),0,0,(t=>{this.viewportLines.push(scaleBlock(t,this.scaler))}))}update(t,e=null){this.state=t.state;let i=this.stateDeco;this.stateDeco=this.state.facet(vt).filter((t=>typeof t!="function"));let s=t.changedRanges;let o=ChangedRange.extendWithRanges(s,heightRelevantDecoChanges(i,this.stateDeco,t?t.changes:a.empty(this.state.doc.length)));let n=this.heightMap.height;let r=this.scrolledToBottom?null:this.scrollAnchorAt(this.scrollTop);clearHeightChangeFlag();this.heightMap=this.heightMap.applyChanges(this.stateDeco,t.startState.doc,this.heightOracle.setDoc(this.state.doc),o);(this.heightMap.height!=n||zt)&&(t.flags|=2);if(r){this.scrollAnchorPos=t.changes.mapPos(r.from,-1);this.scrollAnchorHeight=r.top}else{this.scrollAnchorPos=-1;this.scrollAnchorHeight=this.heightMap.height}let l=o.length?this.mapViewport(this.viewport,t.changes):this.viewport;(e&&(e.range.head<l.from||e.range.head>l.to)||!this.viewportIsAppropriate(l))&&(l=this.getViewport(0,e));let h=l.from!=this.viewport.from||l.to!=this.viewport.to;this.viewport=l;t.flags|=this.updateForViewport();(h||!t.changes.empty||t.flags&2)&&this.updateViewportLines();(this.lineGaps.length||this.viewport.to-this.viewport.from>4e3)&&this.updateLineGaps(this.ensureLineGaps(this.mapLineGaps(this.lineGaps,t.changes)));t.flags|=this.computeVisibleRanges();e&&(this.scrollTarget=e);!this.mustEnforceCursorAssoc&&t.selectionSet&&t.view.lineWrapping&&t.state.selection.main.empty&&t.state.selection.main.assoc&&!t.state.facet(ht)&&(this.mustEnforceCursorAssoc=true)}measure(e){let i=e.contentDOM,s=window.getComputedStyle(i);let o=this.heightOracle;let n=s.whiteSpace;this.defaultTextDirection=s.direction=="rtl"?K.RTL:K.LTR;let r=this.heightOracle.mustRefreshForWrapping(n);let l=i.getBoundingClientRect();let a=r||this.mustMeasureContent||this.contentDOMHeight!=l.height;this.contentDOMHeight=l.height;this.mustMeasureContent=false;let h=0,c=0;if(l.width&&l.height){let{scaleX:t,scaleY:e}=getScale(i,l);if(t>.005&&Math.abs(this.scaleX-t)>.005||e>.005&&Math.abs(this.scaleY-e)>.005){this.scaleX=t;this.scaleY=e;h|=8;r=a=true}}let d=(parseInt(s.paddingTop)||0)*this.scaleY;let u=(parseInt(s.paddingBottom)||0)*this.scaleY;if(this.paddingTop!=d||this.paddingBottom!=u){this.paddingTop=d;this.paddingBottom=u;h|=10}if(this.editorWidth!=e.scrollDOM.clientWidth){o.lineWrapping&&(a=true);this.editorWidth=e.scrollDOM.clientWidth;h|=8}let f=e.scrollDOM.scrollTop*this.scaleY;if(this.scrollTop!=f){this.scrollAnchorHeight=-1;this.scrollTop=f}this.scrolledToBottom=isScrolledToBottom(e.scrollDOM);let p=(this.printing?fullPixelRange:visiblePixelRange)(i,this.paddingTop);let g=p.top-this.pixelViewport.top,m=p.bottom-this.pixelViewport.bottom;this.pixelViewport=p;let w=this.pixelViewport.bottom>this.pixelViewport.top&&this.pixelViewport.right>this.pixelViewport.left;if(w!=this.inView){this.inView=w;w&&(a=true)}if(!this.inView&&!this.scrollTarget)return 0;let v=l.width;if(this.contentDOMWidth!=v||this.editorHeight!=e.scrollDOM.clientHeight){this.contentDOMWidth=l.width;this.editorHeight=e.scrollDOM.clientHeight;h|=8}if(a){let i=e.docView.measureVisibleLineHeights(this.viewport);o.mustRefreshForHeights(i)&&(r=true);if(r||o.lineWrapping&&Math.abs(v-this.contentDOMWidth)>o.charWidth){let{lineHeight:t,charWidth:s,textHeight:l}=e.docView.measureTextSize();r=t>0&&o.refresh(n,t,s,l,v/s,i);if(r){e.docView.minWidth=0;h|=8}}g>0&&m>0?c=Math.max(g,m):g<0&&m<0&&(c=Math.min(g,m));clearHeightChangeFlag();for(let s of this.viewports){let n=s.from==this.viewport.from?i:e.docView.measureVisibleLineHeights(s);this.heightMap=(r?HeightMap.empty().applyChanges(this.stateDeco,t.empty,this.heightOracle,[new ChangedRange(0,0,0,e.state.doc.length)]):this.heightMap).updateHeight(o,0,r,new MeasuredHeights(s.from,n))}zt&&(h|=2)}let b=!this.viewportIsAppropriate(this.viewport,c)||this.scrollTarget&&(this.scrollTarget.range.head<this.viewport.from||this.scrollTarget.range.head>this.viewport.to);if(b){h&2&&(h|=this.updateScaler());this.viewport=this.getViewport(c,this.scrollTarget);h|=this.updateForViewport()}(h&2||b)&&this.updateViewportLines();(this.lineGaps.length||this.viewport.to-this.viewport.from>4e3)&&this.updateLineGaps(this.ensureLineGaps(r?[]:this.lineGaps,e));h|=this.computeVisibleRanges();if(this.mustEnforceCursorAssoc){this.mustEnforceCursorAssoc=false;e.docView.enforceCursorAssoc()}return h}get visibleTop(){return this.scaler.fromDOM(this.pixelViewport.top)}get visibleBottom(){return this.scaler.fromDOM(this.pixelViewport.bottom)}getViewport(t,e){let i=.5-Math.max(-.5,Math.min(.5,t/1e3/2));let s=this.heightMap,o=this.heightOracle;let{visibleTop:n,visibleBottom:r}=this;let l=new Viewport(s.lineAt(n-i*1e3,qt.ByHeight,o,0,0).from,s.lineAt(r+1e3*(1-i),qt.ByHeight,o,0,0).to);if(e){let{head:t}=e.range;if(t<l.from||t>l.to){let i=Math.min(this.editorHeight,this.pixelViewport.bottom-this.pixelViewport.top);let n,r=s.lineAt(t,qt.ByPos,o,0,0);n=e.y=="center"?(r.top+r.bottom)/2-i/2:e.y=="start"||e.y=="nearest"&&t<l.from?r.top:r.bottom-i;l=new Viewport(s.lineAt(n-500,qt.ByHeight,o,0,0).from,s.lineAt(n+i+500,qt.ByHeight,o,0,0).to)}}return l}mapViewport(t,e){let i=e.mapPos(t.from,-1),s=e.mapPos(t.to,1);return new Viewport(this.heightMap.lineAt(i,qt.ByPos,this.heightOracle,0,0).from,this.heightMap.lineAt(s,qt.ByPos,this.heightOracle,0,0).to)}viewportIsAppropriate({from:t,to:e},i=0){if(!this.inView)return true;let{top:s}=this.heightMap.lineAt(t,qt.ByPos,this.heightOracle,0,0);let{bottom:o}=this.heightMap.lineAt(e,qt.ByPos,this.heightOracle,0,0);let{visibleTop:n,visibleBottom:r}=this;return(t==0||s<=n-Math.max(10,Math.min(-i,250)))&&(e==this.state.doc.length||o>=r+Math.max(10,Math.min(i,250)))&&s>n-2e3&&o<r+2e3}mapLineGaps(t,e){if(!t.length||e.empty)return t;let i=[];for(let s of t)e.touchesRange(s.from,s.to)||i.push(new LineGap(e.mapPos(s.from),e.mapPos(s.to),s.size,s.displaySize));return i}ensureLineGaps(t,e){let i=this.heightOracle.lineWrapping;let s=i?1e4:2e3,o=s>>1,r=s<<1;if(this.defaultTextDirection!=K.LTR&&!i)return[];let l=[];let addGap=(s,r,a,h)=>{if(r-s<o)return;let c=this.state.selection.main,d=[c.from];c.empty||d.push(c.to);for(let t of d)if(t>s&&t<r){addGap(s,t-10,a,h);addGap(t+10,r,a,h);return}let u=find(t,(t=>t.from>=a.from&&t.to<=a.to&&Math.abs(t.from-s)<o&&Math.abs(t.to-r)<o&&!d.some((e=>t.from<e&&t.to>e))));if(!u){if(r<a.to&&e&&i&&e.visibleRanges.some((t=>t.from<=r&&t.to>=r))){let t=e.moveToLineBoundary(n.cursor(r),false,true).head;t>s&&(r=t)}let t=this.gapSize(a,s,r,h);let o=i||t<2e6?t:2e6;u=new LineGap(s,r,t,o)}l.push(u)};let checkLine=e=>{if(e.length<r||e.type!=q.Text)return;let o=lineStructure(e.from,e.to,this.stateDeco);if(o.total<r)return;let n=this.scrollTarget?this.scrollTarget.range.head:null;let l,a;if(i){let t=s/this.heightOracle.lineLength*this.heightOracle.lineHeight;let i,r;if(n!=null){let s=findFraction(o,n);let l=((this.visibleBottom-this.visibleTop)/2+t)/e.height;i=s-l;r=s+l}else{i=(this.visibleTop-e.top-t)/e.height;r=(this.visibleBottom-e.top+t)/e.height}l=findPosition(o,i);a=findPosition(o,r)}else{let i=o.total*this.heightOracle.charWidth;let r=s*this.heightOracle.charWidth;let h=0;if(i>2e6)for(let i of t)i.from>=e.from&&i.from<e.to&&i.size!=i.displaySize&&i.from*this.heightOracle.charWidth+h<this.pixelViewport.left&&(h=i.size-i.displaySize);let c=this.pixelViewport.left+h,d=this.pixelViewport.right+h;let u,f;if(n!=null){let t=findFraction(o,n);let e=((d-c)/2+r)/i;u=t-e;f=t+e}else{u=(c-r)/i;f=(d+r)/i}l=findPosition(o,u);a=findPosition(o,f)}l>e.from&&addGap(e.from,l,e,o);a<e.to&&addGap(a,e.to,e,o)};for(let t of this.viewportLines)Array.isArray(t.type)?t.type.forEach(checkLine):checkLine(t);return l}gapSize(t,e,i,s){let o=findFraction(s,i)-findFraction(s,e);return this.heightOracle.lineWrapping?t.height*o:s.total*this.heightOracle.charWidth*o}updateLineGaps(t){if(!LineGap.same(t,this.lineGaps)){this.lineGaps=t;this.lineGapDeco=Decoration.set(t.map((t=>t.draw(this,this.heightOracle.lineWrapping))))}}computeVisibleRanges(){let t=this.stateDeco;this.lineGaps.length&&(t=t.concat(this.lineGapDeco));let e=[];i.spans(t,this.viewport.from,this.viewport.to,{span(t,i){e.push({from:t,to:i})},point(){}},20);let s=e.length!=this.visibleRanges.length||this.visibleRanges.some(((t,i)=>t.from!=e[i].from||t.to!=e[i].to));this.visibleRanges=e;return s?4:0}lineBlockAt(t){return t>=this.viewport.from&&t<=this.viewport.to&&this.viewportLines.find((e=>e.from<=t&&e.to>=t))||scaleBlock(this.heightMap.lineAt(t,qt.ByPos,this.heightOracle,0,0),this.scaler)}lineBlockAtHeight(t){return t>=this.viewportLines[0].top&&t<=this.viewportLines[this.viewportLines.length-1].bottom&&this.viewportLines.find((e=>e.top<=t&&e.bottom>=t))||scaleBlock(this.heightMap.lineAt(this.scaler.fromDOM(t),qt.ByHeight,this.heightOracle,0,0),this.scaler)}scrollAnchorAt(t){let e=this.lineBlockAtHeight(t+8);return e.from>=this.viewport.from||this.viewportLines[0].top-t>200?e:this.viewportLines[0]}elementAtHeight(t){return scaleBlock(this.heightMap.blockAt(this.scaler.fromDOM(t),this.heightOracle,0,0),this.scaler)}get docHeight(){return this.scaler.toDOM(this.heightMap.height)}get contentHeight(){return this.docHeight+this.paddingTop+this.paddingBottom}}class Viewport{constructor(t,e){this.from=t;this.to=e}}function lineStructure(t,e,s){let o=[],n=t,r=0;i.spans(s,t,e,{span(){},point(t,e){if(t>n){o.push({from:n,to:t});r+=t-n}n=e}},20);if(n<e){o.push({from:n,to:e});r+=e-n}return{total:r,ranges:o}}function findPosition({total:t,ranges:e},i){if(i<=0)return e[0].from;if(i>=1)return e[e.length-1].to;let s=Math.floor(t*i);for(let t=0;;t++){let{from:i,to:o}=e[t],n=o-i;if(s<=n)return i+s;s-=n}}function findFraction(t,e){let i=0;for(let{from:s,to:o}of t.ranges){if(e<=o){i+=e-s;break}i+=o-s}return i/t.total}function find(t,e){for(let i of t)if(e(i))return i}const Yt={toDOM(t){return t},fromDOM(t){return t},scale:1,eq(t){return t==this}};class BigScaler{constructor(t,e,i){let s=0,o=0,n=0;this.viewports=i.map((({from:i,to:o})=>{let n=e.lineAt(i,qt.ByPos,t,0,0).top;let r=e.lineAt(o,qt.ByPos,t,0,0).bottom;s+=r-n;return{from:i,to:o,top:n,bottom:r,domTop:0,domBottom:0}}));this.scale=(7e6-s)/(e.height-s);for(let t of this.viewports){t.domTop=n+(t.top-o)*this.scale;n=t.domBottom=t.domTop+(t.bottom-t.top);o=t.bottom}}toDOM(t){for(let e=0,i=0,s=0;;e++){let o=e<this.viewports.length?this.viewports[e]:null;if(!o||t<o.top)return s+(t-i)*this.scale;if(t<=o.bottom)return o.domTop+(t-o.top);i=o.bottom;s=o.domBottom}}fromDOM(t){for(let e=0,i=0,s=0;;e++){let o=e<this.viewports.length?this.viewports[e]:null;if(!o||t<o.domTop)return i+(t-s)/this.scale;if(t<=o.domBottom)return o.top+(t-o.domTop);i=o.bottom;s=o.domBottom}}eq(t){return t instanceof BigScaler&&(this.scale==t.scale&&this.viewports.length==t.viewports.length&&this.viewports.every(((e,i)=>e.from==t.viewports[i].from&&e.to==t.viewports[i].to)))}}function scaleBlock(t,e){if(e.scale==1)return t;let i=e.toDOM(t.top),s=e.toDOM(t.bottom);return new BlockInfo(t.from,t.length,i,s-i,Array.isArray(t._content)?t._content.map((t=>scaleBlock(t,e))):t._content)}const Xt=r.define({combine:t=>t.join(" ")});const jt=r.define({combine:t=>t.indexOf(true)>-1});const Ut=x.newName(),_t=x.newName(),$t=x.newName();const Qt={"&light":"."+_t,"&dark":"."+$t};function buildTheme(t,e,i){return new x(e,{finish(e){return/&/.test(e)?e.replace(/&\w*/,(e=>{if(e=="&")return t;if(!i||!i[e])throw new RangeError(`Unsupported selector: ${e}`);return i[e]})):t+" "+e}})}const Jt=buildTheme("."+Ut,{"&":{position:"relative !important",boxSizing:"border-box","&.cm-focused":{outline:"1px dotted #212121"},display:"flex !important",flexDirection:"column"},".cm-scroller":{display:"flex !important",alignItems:"flex-start !important",fontFamily:"monospace",lineHeight:1.4,height:"100%",overflowX:"auto",position:"relative",zIndex:0,overflowAnchor:"none"},".cm-content":{margin:0,flexGrow:2,flexShrink:0,display:"block",whiteSpace:"pre",wordWrap:"normal",boxSizing:"border-box",minHeight:"100%",padding:"4px 0",outline:"none","&[contenteditable=true]":{WebkitUserModify:"read-write-plaintext-only"}},".cm-lineWrapping":{whiteSpace_fallback:"pre-wrap",whiteSpace:"break-spaces",wordBreak:"break-word",overflowWrap:"anywhere",flexShrink:1},"&light .cm-content":{caretColor:"black"},"&dark .cm-content":{caretColor:"white"},".cm-line":{display:"block",padding:"0 2px 0 6px"},".cm-layer":{position:"absolute",left:0,top:0,contain:"size style","& > *":{position:"absolute"}},"&light .cm-selectionBackground":{background:"#d9d9d9"},"&dark .cm-selectionBackground":{background:"#222"},"&light.cm-focused > .cm-scroller > .cm-selectionLayer .cm-selectionBackground":{background:"#d7d4f0"},"&dark.cm-focused > .cm-scroller > .cm-selectionLayer .cm-selectionBackground":{background:"#233"},".cm-cursorLayer":{pointerEvents:"none"},"&.cm-focused > .cm-scroller > .cm-cursorLayer":{animation:"steps(1) cm-blink 1.2s infinite"},"@keyframes cm-blink":{"0%":{},"50%":{opacity:0},"100%":{}},"@keyframes cm-blink2":{"0%":{},"50%":{opacity:0},"100%":{}},".cm-cursor, .cm-dropCursor":{borderLeft:"1.2px solid black",marginLeft:"-0.6px",pointerEvents:"none"},".cm-cursor":{display:"none"},"&dark .cm-cursor":{borderLeftColor:"#ddd"},".cm-dropCursor":{position:"absolute"},"&.cm-focused > .cm-scroller > .cm-cursorLayer .cm-cursor":{display:"block"},".cm-iso":{unicodeBidi:"isolate"},".cm-announced":{position:"fixed",top:"-10000px"},"@media print":{".cm-announced":{display:"none"}},"&light .cm-activeLine":{backgroundColor:"#cceeff44"},"&dark .cm-activeLine":{backgroundColor:"#99eeff33"},"&light .cm-specialChar":{color:"red"},"&dark .cm-specialChar":{color:"#f78"},".cm-gutters":{flexShrink:0,display:"flex",height:"100%",boxSizing:"border-box",insetInlineStart:0,zIndex:200},"&light .cm-gutters":{backgroundColor:"#f5f5f5",color:"#6c6c6c",borderRight:"1px solid #ddd"},"&dark .cm-gutters":{backgroundColor:"#333338",color:"#ccc"},".cm-gutter":{display:"flex !important",flexDirection:"column",flexShrink:0,boxSizing:"border-box",minHeight:"100%",overflow:"hidden"},".cm-gutterElement":{boxSizing:"border-box"},".cm-lineNumbers .cm-gutterElement":{padding:"0 3px 0 5px",minWidth:"20px",textAlign:"right",whiteSpace:"nowrap"},"&light .cm-activeLineGutter":{backgroundColor:"#e2f2ff"},"&dark .cm-activeLineGutter":{backgroundColor:"#222227"},".cm-panels":{boxSizing:"border-box",position:"sticky",left:0,right:0,zIndex:300},"&light .cm-panels":{backgroundColor:"#f5f5f5",color:"black"},"&light .cm-panels-top":{borderBottom:"1px solid #ddd"},"&light .cm-panels-bottom":{borderTop:"1px solid #ddd"},"&dark .cm-panels":{backgroundColor:"#333338",color:"white"},".cm-tab":{display:"inline-block",overflow:"hidden",verticalAlign:"bottom"},".cm-widgetBuffer":{verticalAlign:"text-top",height:"1em",width:0,display:"inline"},".cm-placeholder":{color:"#888",display:"inline-block",verticalAlign:"top"},".cm-highlightSpace":{backgroundImage:"radial-gradient(circle at 50% 55%, #aaa 20%, transparent 5%)",backgroundPosition:"center"},".cm-highlightTab":{backgroundImage:'url(\'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="20"><path stroke="%23888" stroke-width="1" fill="none" d="M1 10H196L190 5M190 15L196 10M197 4L197 16"/></svg>\')',backgroundSize:"auto 100%",backgroundPosition:"right 90%",backgroundRepeat:"no-repeat"},".cm-trailingSpace":{backgroundColor:"#ff332255"},".cm-button":{verticalAlign:"middle",color:"inherit",fontSize:"70%",padding:".2em 1em",borderRadius:"1px"},"&light .cm-button":{backgroundImage:"linear-gradient(#eff1f5, #d9d9df)",border:"1px solid #888","&:active":{backgroundImage:"linear-gradient(#b4b4b4, #d0d3d6)"}},"&dark .cm-button":{backgroundImage:"linear-gradient(#393939, #111)",border:"1px solid #888","&:active":{backgroundImage:"linear-gradient(#111, #333)"}},".cm-textfield":{verticalAlign:"middle",color:"inherit",fontSize:"70%",border:"1px solid silver",padding:".2em .5em"},"&light .cm-textfield":{backgroundColor:"white"},"&dark .cm-textfield":{border:"1px solid #555",backgroundColor:"inherit"}},Qt);const Zt={childList:true,characterData:true,subtree:true,attributes:true,characterDataOldValue:true};const te=F.ie&&F.ie_version<=11;class DOMObserver{constructor(t){this.view=t;this.active=false;this.editContext=null;this.selectionRange=new DOMSelectionState;this.selectionChanged=false;this.delayedFlush=-1;this.resizeTimeout=-1;this.queue=[];this.delayedAndroidKey=null;this.flushingAndroidKey=-1;this.lastChange=0;this.scrollTargets=[];this.intersection=null;this.resizeScroll=null;this.intersecting=false;this.gapIntersection=null;this.gaps=[];this.printQuery=null;this.parentCheck=-1;this.dom=t.contentDOM;this.observer=new MutationObserver((e=>{for(let t of e)this.queue.push(t);(F.ie&&F.ie_version<=11||F.ios&&t.composing)&&e.some((t=>t.type=="childList"&&t.removedNodes.length||t.type=="characterData"&&t.oldValue.length>t.target.nodeValue.length))?this.flushSoon():this.flush()}));if(window.EditContext&&t.constructor.EDIT_CONTEXT!==false&&!(F.chrome&&F.chrome_version<126)){this.editContext=new EditContextManager(t);t.state.facet(ft)&&(t.contentDOM.editContext=this.editContext.editContext)}te&&(this.onCharData=t=>{this.queue.push({target:t.target,type:"characterData",oldValue:t.prevValue});this.flushSoon()});this.onSelectionChange=this.onSelectionChange.bind(this);this.onResize=this.onResize.bind(this);this.onPrint=this.onPrint.bind(this);this.onScroll=this.onScroll.bind(this);window.matchMedia&&(this.printQuery=window.matchMedia("print"));if(typeof ResizeObserver=="function"){this.resizeScroll=new ResizeObserver((()=>{var t;((t=this.view.docView)===null||t===void 0?void 0:t.lastUpdate)<Date.now()-75&&this.onResize()}));this.resizeScroll.observe(t.scrollDOM)}this.addWindowListeners(this.win=t.win);this.start();if(typeof IntersectionObserver=="function"){this.intersection=new IntersectionObserver((t=>{this.parentCheck<0&&(this.parentCheck=setTimeout(this.listenForScroll.bind(this),1e3));if(t.length>0&&t[t.length-1].intersectionRatio>0!=this.intersecting){this.intersecting=!this.intersecting;this.intersecting!=this.view.inView&&this.onScrollChanged(document.createEvent("Event"))}}),{threshold:[0,.001]});this.intersection.observe(this.dom);this.gapIntersection=new IntersectionObserver((t=>{t.length>0&&t[t.length-1].intersectionRatio>0&&this.onScrollChanged(document.createEvent("Event"))}),{})}this.listenForScroll();this.readSelectionRange()}onScrollChanged(t){this.view.inputState.runHandlers("scroll",t);this.intersecting&&this.view.measure()}onScroll(t){this.intersecting&&this.flush(false);this.editContext&&this.view.requestMeasure(this.editContext.measureReq);this.onScrollChanged(t)}onResize(){this.resizeTimeout<0&&(this.resizeTimeout=setTimeout((()=>{this.resizeTimeout=-1;this.view.requestMeasure()}),50))}onPrint(t){if(t.type!="change"&&t.type||t.matches){this.view.viewState.printing=true;this.view.measure();setTimeout((()=>{this.view.viewState.printing=false;this.view.requestMeasure()}),500)}}updateGaps(t){if(this.gapIntersection&&(t.length!=this.gaps.length||this.gaps.some(((e,i)=>e!=t[i])))){this.gapIntersection.disconnect();for(let e of t)this.gapIntersection.observe(e);this.gaps=t}}onSelectionChange(t){let e=this.selectionChanged;if(!this.readSelectionRange()||this.delayedAndroidKey)return;let{view:i}=this,s=this.selectionRange;if(i.state.facet(ft)?i.root.activeElement!=this.dom:!hasSelection(this.dom,s))return;let o=s.anchorNode&&i.docView.nearest(s.anchorNode);o&&o.ignoreEvent(t)?e||(this.selectionChanged=false):(F.ie&&F.ie_version<=11||F.android&&F.chrome)&&!i.state.selection.main.empty&&s.focusNode&&isEquivalentPosition(s.focusNode,s.focusOffset,s.anchorNode,s.anchorOffset)?this.flushSoon():this.flush(false)}readSelectionRange(){let{view:t}=this;let e=getSelection(t.root);if(!e)return false;let i=F.safari&&t.root.nodeType==11&&t.root.activeElement==this.dom&&safariSelectionRangeHack(this.view,e)||e;if(!i||this.selectionRange.eq(i))return false;let s=hasSelection(this.dom,i);if(s&&!this.selectionChanged&&t.inputState.lastFocusTime>Date.now()-200&&t.inputState.lastTouchTime<Date.now()-300&&atElementStart(this.dom,i)){this.view.inputState.lastFocusTime=0;t.docView.updateSelection();return false}this.selectionRange.setRange(i);s&&(this.selectionChanged=true);return true}setSelectionRange(t,e){this.selectionRange.set(t.node,t.offset,e.node,e.offset);this.selectionChanged=false}clearSelectionRange(){this.selectionRange.set(null,0,null,0)}listenForScroll(){this.parentCheck=-1;let t=0,e=null;for(let i=this.dom;i;)if(i.nodeType==1){!e&&t<this.scrollTargets.length&&this.scrollTargets[t]==i?t++:e||(e=this.scrollTargets.slice(0,t));e&&e.push(i);i=i.assignedSlot||i.parentNode}else{if(i.nodeType!=11)break;i=i.host}t<this.scrollTargets.length&&!e&&(e=this.scrollTargets.slice(0,t));if(e){for(let t of this.scrollTargets)t.removeEventListener("scroll",this.onScroll);for(let t of this.scrollTargets=e)t.addEventListener("scroll",this.onScroll)}}ignore(t){if(!this.active)return t();try{this.stop();return t()}finally{this.start();this.clear()}}start(){if(!this.active){this.observer.observe(this.dom,Zt);te&&this.dom.addEventListener("DOMCharacterDataModified",this.onCharData);this.active=true}}stop(){if(this.active){this.active=false;this.observer.disconnect();te&&this.dom.removeEventListener("DOMCharacterDataModified",this.onCharData)}}clear(){this.processRecords();this.queue.length=0;this.selectionChanged=false}delayAndroidKey(t,e){var i;if(!this.delayedAndroidKey){let flush=()=>{let t=this.delayedAndroidKey;if(t){this.clearDelayedAndroidKey();this.view.inputState.lastKeyCode=t.keyCode;this.view.inputState.lastKeyTime=Date.now();let e=this.flush();!e&&t.force&&dispatchKey(this.dom,t.key,t.keyCode)}};this.flushingAndroidKey=this.view.win.requestAnimationFrame(flush)}this.delayedAndroidKey&&t!="Enter"||(this.delayedAndroidKey={key:t,keyCode:e,force:this.lastChange<Date.now()-50||!!((i=this.delayedAndroidKey)===null||i===void 0?void 0:i.force)})}clearDelayedAndroidKey(){this.win.cancelAnimationFrame(this.flushingAndroidKey);this.delayedAndroidKey=null;this.flushingAndroidKey=-1}flushSoon(){this.delayedFlush<0&&(this.delayedFlush=this.view.win.requestAnimationFrame((()=>{this.delayedFlush=-1;this.flush()})))}forceFlush(){if(this.delayedFlush>=0){this.view.win.cancelAnimationFrame(this.delayedFlush);this.delayedFlush=-1}this.flush()}pendingRecords(){for(let t of this.observer.takeRecords())this.queue.push(t);return this.queue}processRecords(){let t=this.pendingRecords();t.length&&(this.queue=[]);let e=-1,i=-1,s=false;for(let o of t){let t=this.readMutation(o);if(t){t.typeOver&&(s=true);if(e==-1)({from:e,to:i}=t);else{e=Math.min(t.from,e);i=Math.max(t.to,i)}}}return{from:e,to:i,typeOver:s}}readChange(){let{from:t,to:e,typeOver:i}=this.processRecords();let s=this.selectionChanged&&hasSelection(this.dom,this.selectionRange);if(t<0&&!s)return null;t>-1&&(this.lastChange=Date.now());this.view.inputState.lastFocusTime=0;this.selectionChanged=false;let o=new DOMChange(this.view,t,e,i);this.view.docView.domChanged={newSel:o.newSel?o.newSel.main:null};return o}flush(t=true){if(this.delayedFlush>=0||this.delayedAndroidKey)return false;t&&this.readSelectionRange();let e=this.readChange();if(!e){this.view.requestMeasure();return false}let i=this.view.state;let s=applyDOMChange(this.view,e);this.view.state==i&&(e.domChanged||e.newSel&&!e.newSel.main.eq(this.view.state.selection.main))&&this.view.update([]);return s}readMutation(t){let e=this.view.docView.nearest(t.target);if(!e||e.ignoreMutation(t))return null;e.markDirty(t.type=="attributes");t.type=="attributes"&&(e.flags|=4);if(t.type=="childList"){let i=findChild(e,t.previousSibling||t.target.previousSibling,-1);let s=findChild(e,t.nextSibling||t.target.nextSibling,1);return{from:i?e.posAfter(i):e.posAtStart,to:s?e.posBefore(s):e.posAtEnd,typeOver:false}}return t.type=="characterData"?{from:e.posAtStart,to:e.posAtEnd,typeOver:t.target.nodeValue==t.oldValue}:null}setWindow(t){if(t!=this.win){this.removeWindowListeners(this.win);this.win=t;this.addWindowListeners(this.win)}}addWindowListeners(t){t.addEventListener("resize",this.onResize);this.printQuery?this.printQuery.addEventListener?this.printQuery.addEventListener("change",this.onPrint):this.printQuery.addListener(this.onPrint):t.addEventListener("beforeprint",this.onPrint);t.addEventListener("scroll",this.onScroll);t.document.addEventListener("selectionchange",this.onSelectionChange)}removeWindowListeners(t){t.removeEventListener("scroll",this.onScroll);t.removeEventListener("resize",this.onResize);this.printQuery?this.printQuery.removeEventListener?this.printQuery.removeEventListener("change",this.onPrint):this.printQuery.removeListener(this.onPrint):t.removeEventListener("beforeprint",this.onPrint);t.document.removeEventListener("selectionchange",this.onSelectionChange)}update(t){if(this.editContext){this.editContext.update(t);t.startState.facet(ft)!=t.state.facet(ft)&&(t.view.contentDOM.editContext=t.state.facet(ft)?this.editContext.editContext:null)}}destroy(){var t,e,i;this.stop();(t=this.intersection)===null||t===void 0?void 0:t.disconnect();(e=this.gapIntersection)===null||e===void 0?void 0:e.disconnect();(i=this.resizeScroll)===null||i===void 0?void 0:i.disconnect();for(let t of this.scrollTargets)t.removeEventListener("scroll",this.onScroll);this.removeWindowListeners(this.win);clearTimeout(this.parentCheck);clearTimeout(this.resizeTimeout);this.win.cancelAnimationFrame(this.delayedFlush);this.win.cancelAnimationFrame(this.flushingAndroidKey);if(this.editContext){this.view.contentDOM.editContext=null;this.editContext.destroy()}}}function findChild(t,e,i){while(e){let s=ContentView.get(e);if(s&&s.parent==t)return s;let o=e.parentNode;e=o!=t.dom?o:i>0?e.nextSibling:e.previousSibling}return null}function buildSelectionRangeFromRange(t,e){let i=e.startContainer,s=e.startOffset;let o=e.endContainer,n=e.endOffset;let r=t.docView.domAtPos(t.state.selection.main.anchor);isEquivalentPosition(r.node,r.offset,o,n)&&([i,s,o,n]=[o,n,i,s]);return{anchorNode:i,anchorOffset:s,focusNode:o,focusOffset:n}}function safariSelectionRangeHack(t,e){if(e.getComposedRanges){let i=e.getComposedRanges(t.root)[0];if(i)return buildSelectionRangeFromRange(t,i)}let i=null;function read(t){t.preventDefault();t.stopImmediatePropagation();i=t.getTargetRanges()[0]}t.contentDOM.addEventListener("beforeinput",read,true);t.dom.ownerDocument.execCommand("indent");t.contentDOM.removeEventListener("beforeinput",read,true);return i?buildSelectionRangeFromRange(t,i):null}class EditContextManager{constructor(e){this.from=0;this.to=0;this.pendingContextChange=null;this.handlers=Object.create(null);this.composing=null;this.resetRange(e.state);let i=this.editContext=new window.EditContext({text:e.state.doc.sliceString(this.from,this.to),selectionStart:this.toContextPos(Math.max(this.from,Math.min(this.to,e.state.selection.main.anchor))),selectionEnd:this.toContextPos(e.state.selection.main.head)});this.handlers.textupdate=i=>{let{anchor:s}=e.state.selection.main;let o=this.toEditorPos(i.updateRangeStart),r=this.toEditorPos(i.updateRangeEnd);e.inputState.composing>=0&&!this.composing&&(this.composing={contextBase:i.updateRangeStart,editorBase:o,drifted:false});let l={from:o,to:r,insert:t.of(i.text.split("\n"))};l.from==this.from&&s<this.from?l.from=s:l.to==this.to&&s>this.to&&(l.to=s);if(l.from!=l.to||l.insert.length){this.pendingContextChange=l;e.state.readOnly||applyDOMChangeInner(e,l,n.single(this.toEditorPos(i.selectionStart),this.toEditorPos(i.selectionEnd)));if(this.pendingContextChange){this.revertPending(e.state);this.setSelection(e.state)}}};this.handlers.characterboundsupdate=t=>{let s=[],o=null;for(let i=this.toEditorPos(t.rangeStart),n=this.toEditorPos(t.rangeEnd);i<n;i++){let t=e.coordsForChar(i);o=t&&new DOMRect(t.left,t.top,t.right-t.left,t.bottom-t.top)||o||new DOMRect;s.push(o)}i.updateCharacterBounds(t.rangeStart,s)};this.handlers.textformatupdate=t=>{let i=[];for(let e of t.getTextFormats()){let t=e.underlineStyle,s=e.underlineThickness;if(t!="None"&&s!="None"){let o=`text-decoration: underline ${t=="Dashed"?"dashed ":t=="Squiggle"?"wavy ":""}${s=="Thin"?1:2}px`;i.push(Decoration.mark({attributes:{style:o}}).range(this.toEditorPos(e.rangeStart),this.toEditorPos(e.rangeEnd)))}}e.dispatch({effects:ut.of(Decoration.set(i))})};this.handlers.compositionstart=()=>{if(e.inputState.composing<0){e.inputState.composing=0;e.inputState.compositionFirstChange=true}};this.handlers.compositionend=()=>{e.inputState.composing=-1;e.inputState.compositionFirstChange=null;if(this.composing){let{drifted:t}=this.composing;this.composing=null;t&&this.reset(e.state)}};for(let t in this.handlers)i.addEventListener(t,this.handlers[t]);this.measureReq={read:t=>{this.editContext.updateControlBounds(t.contentDOM.getBoundingClientRect());let e=getSelection(t.root);e&&e.rangeCount&&this.editContext.updateSelectionBounds(e.getRangeAt(0).getBoundingClientRect())}}}applyEdits(t){let e=0,i=false,s=this.pendingContextChange;t.changes.iterChanges(((o,n,r,l,a)=>{if(i)return;let h=a.length-(n-o);if(s&&n>=s.to){if(s.from==o&&s.to==n&&s.insert.eq(a)){s=this.pendingContextChange=null;e+=h;this.to+=h;return}s=null;this.revertPending(t.state)}o+=e;n+=e;if(n<=this.from){this.from+=h;this.to+=h}else if(o<this.to){if(o<this.from||n>this.to||this.to-this.from+a.length>3e4){i=true;return}this.editContext.updateText(this.toContextPos(o),this.toContextPos(n),a.toString());this.to+=h}e+=h}));s&&!i&&this.revertPending(t.state);return!i}update(t){let e=this.pendingContextChange;if(this.composing&&(this.composing.drifted||t.transactions.some((t=>!t.isUserEvent("input.type")&&t.changes.touchesRange(this.from,this.to))))){this.composing.drifted=true;this.composing.editorBase=t.changes.mapPos(this.composing.editorBase)}else if(this.applyEdits(t)&&this.rangeIsValid(t.state))(t.docChanged||t.selectionSet||e)&&this.setSelection(t.state);else{this.pendingContextChange=null;this.reset(t.state)}(t.geometryChanged||t.docChanged||t.selectionSet)&&t.view.requestMeasure(this.measureReq)}resetRange(t){let{head:e}=t.selection.main;this.from=Math.max(0,e-1e4);this.to=Math.min(t.doc.length,e+1e4)}reset(t){this.resetRange(t);this.editContext.updateText(0,this.editContext.text.length,t.doc.sliceString(this.from,this.to));this.setSelection(t)}revertPending(t){let e=this.pendingContextChange;this.pendingContextChange=null;this.editContext.updateText(this.toContextPos(e.from),this.toContextPos(e.from+e.insert.length),t.doc.sliceString(e.from,e.to))}setSelection(t){let{main:e}=t.selection;let i=this.toContextPos(Math.max(this.from,Math.min(this.to,e.anchor)));let s=this.toContextPos(e.head);this.editContext.selectionStart==i&&this.editContext.selectionEnd==s||this.editContext.updateSelection(i,s)}rangeIsValid(t){let{head:e}=t.selection.main;return!(this.from>0&&e-this.from<500||this.to<t.doc.length&&this.to-e<500||this.to-this.from>3e4)}toEditorPos(t){let e=this.composing;return e&&e.drifted?e.editorBase+(t-e.contextBase):t+this.from}toContextPos(t){let e=this.composing;return e&&e.drifted?e.contextBase+(t-e.editorBase):t-this.from}destroy(){for(let t in this.handlers)this.editContext.removeEventListener(t,this.handlers[t])}}class EditorView{get state(){return this.viewState.state}get viewport(){return this.viewState.viewport}get visibleRanges(){return this.viewState.visibleRanges}get inView(){return this.viewState.inView}get composing(){return this.inputState.composing>0}get compositionStarted(){return this.inputState.composing>=0}get root(){return this._root}get win(){return this.dom.ownerDocument.defaultView||window}constructor(t={}){var e;this.plugins=[];this.pluginMap=new Map;this.editorAttrs={};this.contentAttrs={};this.bidiCache=[];this.destroyed=false;this.updateState=2;this.measureScheduled=-1;this.measureRequests=[];this.contentDOM=document.createElement("div");this.scrollDOM=document.createElement("div");this.scrollDOM.tabIndex=-1;this.scrollDOM.className="cm-scroller";this.scrollDOM.appendChild(this.contentDOM);this.announceDOM=document.createElement("div");this.announceDOM.className="cm-announced";this.announceDOM.setAttribute("aria-live","polite");this.dom=document.createElement("div");this.dom.appendChild(this.announceDOM);this.dom.appendChild(this.scrollDOM);t.parent&&t.parent.appendChild(this.dom);let{dispatch:i}=t;this.dispatchTransactions=t.dispatchTransactions||i&&(t=>t.forEach((t=>i(t,this))))||(t=>this.update(t));this.dispatch=this.dispatch.bind(this);this._root=t.root||getRoot(t.parent)||document;this.viewState=new ViewState(t.state||d.create(t));t.scrollTo&&t.scrollTo.is(dt)&&(this.viewState.scrollTarget=t.scrollTo.value.clip(this.viewState.state));this.plugins=this.state.facet(gt).map((t=>new PluginInstance(t)));for(let t of this.plugins)t.update(this);this.observer=new DOMObserver(this);this.inputState=new InputState(this);this.inputState.ensureHandlers(this.plugins);this.docView=new DocView(this);this.mountStyles();this.updateAttrs();this.updateState=0;this.requestMeasure();((e=document.fonts)===null||e===void 0?void 0:e.ready)&&document.fonts.ready.then((()=>this.requestMeasure()))}dispatch(...t){let e=t.length==1&&t[0]instanceof f?t:t.length==1&&Array.isArray(t[0])?t[0]:[this.state.update(...t)];this.dispatchTransactions(e,this)}update(t){if(this.updateState!=0)throw new Error("Calls to EditorView.update are not allowed while an update is in progress");let e,i=false,s=false;let o=this.state;for(let e of t){if(e.startState!=o)throw new RangeError("Trying to update state with a transaction that doesn't start from the previous state.");o=e.state}if(this.destroyed){this.viewState.state=o;return}let r=this.hasFocus,l=0,a=null;if(t.some((t=>t.annotation(Wt)))){this.inputState.notifiedFocused=r;l=1}else if(r!=this.inputState.notifiedFocused){this.inputState.notifiedFocused=r;a=focusChangeTransaction(o,r);a||(l=1)}let h=this.observer.delayedAndroidKey,c=null;if(h){this.observer.clearDelayedAndroidKey();c=this.observer.readChange();(c&&!this.state.doc.eq(o.doc)||!this.state.selection.eq(o.selection))&&(c=null)}else this.observer.clear();if(o.facet(d.phrases)!=this.state.facet(d.phrases))return this.setState(o);e=ViewUpdate.create(this,o,t);e.flags|=l;let u=this.viewState.scrollTarget;try{this.updateState=2;for(let e of t){u&&(u=u.map(e.changes));if(e.scrollIntoView){let{main:t}=e.state.selection;u=new ScrollTarget(t.empty?t:n.cursor(t.head,t.head>t.anchor?-1:1))}for(let t of e.effects)t.is(dt)&&(u=t.value.clip(this.state))}this.viewState.update(e,u);this.bidiCache=CachedOrder.update(this.bidiCache,e.changes);if(!e.empty){this.updatePlugins(e);this.inputState.update(e)}i=this.docView.update(e);this.state.facet(Mt)!=this.styleModules&&this.mountStyles();s=this.updateAttrs();this.showAnnouncements(t);this.docView.updateSelection(i,t.some((t=>t.isUserEvent("select.pointer"))))}finally{this.updateState=0}e.startState.facet(Xt)!=e.state.facet(Xt)&&(this.viewState.mustMeasureContent=true);(i||s||u||this.viewState.mustEnforceCursorAssoc||this.viewState.mustMeasureContent)&&this.requestMeasure();i&&this.docViewUpdate();if(!e.empty)for(let t of this.state.facet(st))try{t(e)}catch(t){logException(this.state,t,"update listener")}(a||c)&&Promise.resolve().then((()=>{a&&this.state==a.startState&&this.dispatch(a);c&&!applyDOMChange(this,c)&&h.force&&dispatchKey(this.contentDOM,h.key,h.keyCode)}))}setState(t){if(this.updateState!=0)throw new Error("Calls to EditorView.setState are not allowed while an update is in progress");if(this.destroyed){this.viewState.state=t;return}this.updateState=2;let e=this.hasFocus;try{for(let t of this.plugins)t.destroy(this);this.viewState=new ViewState(t);this.plugins=t.facet(gt).map((t=>new PluginInstance(t)));this.pluginMap.clear();for(let t of this.plugins)t.update(this);this.docView.destroy();this.docView=new DocView(this);this.inputState.ensureHandlers(this.plugins);this.mountStyles();this.updateAttrs();this.bidiCache=[]}finally{this.updateState=0}e&&this.focus();this.requestMeasure()}updatePlugins(t){let e=t.startState.facet(gt),i=t.state.facet(gt);if(e!=i){let s=[];for(let o of i){let i=e.indexOf(o);if(i<0)s.push(new PluginInstance(o));else{let e=this.plugins[i];e.mustUpdate=t;s.push(e)}}for(let e of this.plugins)e.mustUpdate!=t&&e.destroy(this);this.plugins=s;this.pluginMap.clear()}else for(let e of this.plugins)e.mustUpdate=t;for(let t=0;t<this.plugins.length;t++)this.plugins[t].update(this);e!=i&&this.inputState.ensureHandlers(this.plugins)}docViewUpdate(){for(let t of this.plugins){let e=t.value;if(e&&e.docViewUpdate)try{e.docViewUpdate(this)}catch(t){logException(this.state,t,"doc view update listener")}}}measure(t=true){if(this.destroyed)return;this.measureScheduled>-1&&this.win.cancelAnimationFrame(this.measureScheduled);if(this.observer.delayedAndroidKey){this.measureScheduled=-1;this.requestMeasure();return}this.measureScheduled=0;t&&this.observer.forceFlush();let e=null;let i=this.scrollDOM,s=i.scrollTop*this.scaleY;let{scrollAnchorPos:o,scrollAnchorHeight:n}=this.viewState;Math.abs(s-this.viewState.scrollTop)>1&&(n=-1);this.viewState.scrollAnchorHeight=-1;try{for(let t=0;;t++){if(n<0)if(isScrolledToBottom(i)){o=-1;n=this.viewState.heightMap.height}else{let t=this.viewState.scrollAnchorAt(s);o=t.from;n=t.top}this.updateState=1;let r=this.viewState.measure(this);if(!r&&!this.measureRequests.length&&this.viewState.scrollTarget==null)break;if(t>5){console.warn(this.measureRequests.length?"Measure loop restarted more than 5 times":"Viewport failed to stabilize");break}let l=[];r&4||([this.measureRequests,l]=[l,this.measureRequests]);let a=l.map((t=>{try{return t.read(this)}catch(t){logException(this.state,t);return ie}}));let h=ViewUpdate.create(this,this.state,[]),c=false;h.flags|=r;e?e.flags|=r:e=h;this.updateState=2;if(!h.empty){this.updatePlugins(h);this.inputState.update(h);this.updateAttrs();c=this.docView.update(h);c&&this.docViewUpdate()}for(let t=0;t<l.length;t++)if(a[t]!=ie)try{let e=l[t];e.write&&e.write(a[t],this)}catch(t){logException(this.state,t)}c&&this.docView.updateSelection(true);if(!h.viewportChanged&&this.measureRequests.length==0){if(this.viewState.editorHeight){if(this.viewState.scrollTarget){this.docView.scrollIntoView(this.viewState.scrollTarget);this.viewState.scrollTarget=null;n=-1;continue}{let t=o<0?this.viewState.heightMap.height:this.viewState.lineBlockAt(o).top;let e=t-n;if(e>1||e<-1){s+=e;i.scrollTop=s/this.scaleY;n=-1;continue}}}break}}}finally{this.updateState=0;this.measureScheduled=-1}if(e&&!e.empty)for(let t of this.state.facet(st))t(e)}get themeClasses(){return Ut+" "+(this.state.facet(jt)?$t:_t)+" "+this.state.facet(Xt)}updateAttrs(){let t=attrsFromFacet(this,mt,{class:"cm-editor"+(this.hasFocus?" cm-focused ":" ")+this.themeClasses});let e={spellcheck:"false",autocorrect:"off",autocapitalize:"off",translate:"no",contenteditable:this.state.facet(ft)?"true":"false",class:"cm-content",style:`${F.tabSize}: ${this.state.tabSize}`,role:"textbox","aria-multiline":"true"};this.state.readOnly&&(e["aria-readonly"]="true");attrsFromFacet(this,wt,e);let i=this.observer.ignore((()=>{let i=updateAttrs(this.contentDOM,this.contentAttrs,e);let s=updateAttrs(this.dom,this.editorAttrs,t);return i||s}));this.editorAttrs=t;this.contentAttrs=e;return i}showAnnouncements(t){let e=true;for(let i of t)for(let t of i.effects)if(t.is(EditorView.announce)){e&&(this.announceDOM.textContent="");e=false;let i=this.announceDOM.appendChild(document.createElement("div"));i.textContent=t.value}}mountStyles(){this.styleModules=this.state.facet(Mt);let t=this.state.facet(EditorView.cspNonce);x.mount(this.root,this.styleModules.concat(Jt).reverse(),t?{nonce:t}:void 0)}readMeasured(){if(this.updateState==2)throw new Error("Reading the editor layout isn't allowed during an update");this.updateState==0&&this.measureScheduled>-1&&this.measure(false)}requestMeasure(t){this.measureScheduled<0&&(this.measureScheduled=this.win.requestAnimationFrame((()=>this.measure())));if(t){if(this.measureRequests.indexOf(t)>-1)return;if(t.key!=null)for(let e=0;e<this.measureRequests.length;e++)if(this.measureRequests[e].key===t.key){this.measureRequests[e]=t;return}this.measureRequests.push(t)}}plugin(t){let e=this.pluginMap.get(t);(e===void 0||e&&e.spec!=t)&&this.pluginMap.set(t,e=this.plugins.find((e=>e.spec==t))||null);return e&&e.update(this).value}get documentTop(){return this.contentDOM.getBoundingClientRect().top+this.viewState.paddingTop}get documentPadding(){return{top:this.viewState.paddingTop,bottom:this.viewState.paddingBottom}}get scaleX(){return this.viewState.scaleX}get scaleY(){return this.viewState.scaleY}elementAtHeight(t){this.readMeasured();return this.viewState.elementAtHeight(t)}lineBlockAtHeight(t){this.readMeasured();return this.viewState.lineBlockAtHeight(t)}get viewportLineBlocks(){return this.viewState.viewportLines}lineBlockAt(t){return this.viewState.lineBlockAt(t)}get contentHeight(){return this.viewState.contentHeight}moveByChar(t,e,i){return skipAtoms(this,t,moveByChar(this,t,e,i))}moveByGroup(t,e){return skipAtoms(this,t,moveByChar(this,t,e,(e=>byGroup(this,t.head,e))))}visualLineSide(t,e){let i=this.bidiSpans(t),s=this.textDirectionAt(t.from);let o=i[e?i.length-1:0];return n.cursor(o.side(e,s)+t.from,o.forward(!e,s)?1:-1)}moveToLineBoundary(t,e,i=true){return moveToLineBoundary(this,t,e,i)}moveVertically(t,e,i){return skipAtoms(this,t,moveVertically(this,t,e,i))}domAtPos(t){return this.docView.domAtPos(t)}posAtDOM(t,e=0){return this.docView.posFromDOM(t,e)}posAtCoords(t,e=true){this.readMeasured();return posAtCoords(this,t,e)}coordsAtPos(t,e=1){this.readMeasured();let i=this.docView.coordsAt(t,e);if(!i||i.left==i.right)return i;let s=this.state.doc.lineAt(t),o=this.bidiSpans(s);let n=o[BidiSpan.find(o,t-s.from,-1,e)];return flattenRect(i,n.dir==K.LTR==e>0)}coordsForChar(t){this.readMeasured();return this.docView.coordsForChar(t)}get defaultCharacterWidth(){return this.viewState.heightOracle.charWidth}get defaultLineHeight(){return this.viewState.heightOracle.lineHeight}get textDirection(){return this.viewState.defaultTextDirection}textDirectionAt(t){let e=this.state.facet(at);if(!e||t<this.viewport.from||t>this.viewport.to)return this.textDirection;this.readMeasured();return this.docView.textDirectionAt(t)}get lineWrapping(){return this.viewState.heightOracle.lineWrapping}bidiSpans(t){if(t.length>ee)return trivialOrder(t.length);let e,i=this.textDirectionAt(t.from);for(let s of this.bidiCache)if(s.from==t.from&&s.dir==i&&(s.fresh||isolatesEq(s.isolates,e=getIsolatedRanges(this,t))))return s.order;e||(e=getIsolatedRanges(this,t));let s=computeOrder(t.text,i,e);this.bidiCache.push(new CachedOrder(t.from,t.to,i,e,true,s));return s}get hasFocus(){var t;return(this.dom.ownerDocument.hasFocus()||F.safari&&((t=this.inputState)===null||t===void 0?void 0:t.lastContextMenu)>Date.now()-3e4)&&this.root.activeElement==this.contentDOM}focus(){this.observer.ignore((()=>{focusPreventScroll(this.contentDOM);this.docView.updateSelection()}))}setRoot(t){if(this._root!=t){this._root=t;this.observer.setWindow((t.nodeType==9?t:t.ownerDocument).defaultView||window);this.mountStyles()}}destroy(){this.root.activeElement==this.contentDOM&&this.contentDOM.blur();for(let t of this.plugins)t.destroy(this);this.plugins=[];this.inputState.destroy();this.docView.destroy();this.dom.remove();this.observer.destroy();this.measureScheduled>-1&&this.win.cancelAnimationFrame(this.measureScheduled);this.destroyed=true}static scrollIntoView(t,e={}){return dt.of(new ScrollTarget(typeof t=="number"?n.cursor(t):t,e.y,e.x,e.yMargin,e.xMargin))}scrollSnapshot(){let{scrollTop:t,scrollLeft:e}=this.scrollDOM;let i=this.viewState.scrollAnchorAt(t);return dt.of(new ScrollTarget(n.cursor(i.from),"start","start",i.top-t,e,true))}setTabFocusMode(t){t==null?this.inputState.tabFocusMode=this.inputState.tabFocusMode<0?0:-1:typeof t=="boolean"?this.inputState.tabFocusMode=t?0:-1:this.inputState.tabFocusMode!=0&&(this.inputState.tabFocusMode=Date.now()+t)}static domEventHandlers(t){return ViewPlugin.define((()=>({})),{eventHandlers:t})}static domEventObservers(t){return ViewPlugin.define((()=>({})),{eventObservers:t})}static theme(t,e){let i=x.newName();let s=[Xt.of(i),Mt.of(buildTheme(`.${i}`,t))];e&&e.dark&&s.push(jt.of(true));return s}static baseTheme(t){return p.lowest(Mt.of(buildTheme("."+Ut,t,Qt)))}static findFromDOM(t){var e;let i=t.querySelector(".cm-content");let s=i&&ContentView.get(i)||ContentView.get(t);return((e=s===null||s===void 0?void 0:s.rootView)===null||e===void 0?void 0:e.view)||null}}EditorView.styleModule=Mt;EditorView.inputHandler=ot;EditorView.clipboardInputFilter=rt;EditorView.clipboardOutputFilter=lt;EditorView.scrollHandler=ct;EditorView.focusChangeEffect=nt;EditorView.perLineTextDirection=at;EditorView.exceptionSink=it;EditorView.updateListener=st;EditorView.editable=ft;EditorView.mouseSelectionStyle=et;EditorView.dragMovesSelection=tt;EditorView.clickAddsSelectionRange=Z;EditorView.decorations=vt;EditorView.outerDecorations=bt;EditorView.atomicRanges=yt;EditorView.bidiIsolatedRanges=xt;EditorView.scrollMargins=St;EditorView.darkTheme=jt;EditorView.cspNonce=r.define({combine:t=>t.length?t[0]:""});EditorView.contentAttributes=wt;EditorView.editorAttributes=mt;EditorView.lineWrapping=EditorView.contentAttributes.of({class:"cm-lineWrapping"});EditorView.announce=l.define();const ee=4096;const ie={};class CachedOrder{constructor(t,e,i,s,o,n){this.from=t;this.to=e;this.dir=i;this.isolates=s;this.fresh=o;this.order=n}static update(t,e){if(e.empty&&!t.some((t=>t.fresh)))return t;let i=[],s=t.length?t[t.length-1].dir:K.LTR;for(let o=Math.max(0,t.length-10);o<t.length;o++){let n=t[o];n.dir!=s||e.touchesRange(n.from,n.to)||i.push(new CachedOrder(e.mapPos(n.from,1),e.mapPos(n.to,-1),n.dir,n.isolates,false,n.order))}return i}}function attrsFromFacet(t,e,i){for(let s=t.state.facet(e),o=s.length-1;o>=0;o--){let e=s[o],n=typeof e=="function"?e(t):e;n&&combineAttrs(n,i)}return i}const se=F.mac?"mac":F.windows?"win":F.linux?"linux":"key";function normalizeKeyName(t,e){const i=t.split(/-(?!$)/);let s=i[i.length-1];s=="Space"&&(s=" ");let o,n,r,l;for(let t=0;t<i.length-1;++t){const s=i[t];if(/^(cmd|meta|m)$/i.test(s))l=true;else if(/^a(lt)?$/i.test(s))o=true;else if(/^(c|ctrl|control)$/i.test(s))n=true;else if(/^s(hift)?$/i.test(s))r=true;else{if(!/^mod$/i.test(s))throw new Error("Unrecognized modifier name: "+s);e=="mac"?l=true:n=true}}o&&(s="Alt-"+s);n&&(s="Ctrl-"+s);l&&(s="Meta-"+s);r&&(s="Shift-"+s);return s}function modifiers(t,e,i){e.altKey&&(t="Alt-"+t);e.ctrlKey&&(t="Ctrl-"+t);e.metaKey&&(t="Meta-"+t);i!==false&&e.shiftKey&&(t="Shift-"+t);return t}const oe=p.default(EditorView.domEventHandlers({keydown(t,e){return runHandlers(getKeymap(e.state),t,e,"editor")}}));const ne=r.define({enables:oe});const re=new WeakMap;function getKeymap(t){let e=t.facet(ne);let i=re.get(e);i||re.set(e,i=buildKeymap(e.reduce(((t,e)=>t.concat(e)),[])));return i}function runScopeHandlers(t,e,i){return runHandlers(getKeymap(t.state),e,t,i)}let le=null;const ae=4e3;function buildKeymap(t,e=se){let i=Object.create(null);let s=Object.create(null);let checkPrefix=(t,e)=>{let i=s[t];if(i==null)s[t]=e;else if(i!=e)throw new Error("Key binding "+t+" is used both as a regular binding and as a multi-stroke prefix")};let add=(t,s,o,n,r)=>{var l,a;let h=i[t]||(i[t]=Object.create(null));let c=s.split(/ (?!$)/).map((t=>normalizeKeyName(t,e)));for(let e=1;e<c.length;e++){let i=c.slice(0,e).join(" ");checkPrefix(i,true);h[i]||(h[i]={preventDefault:true,stopPropagation:false,run:[e=>{let s=le={view:e,prefix:i,scope:t};setTimeout((()=>{le==s&&(le=null)}),ae);return true}]})}let d=c.join(" ");checkPrefix(d,false);let u=h[d]||(h[d]={preventDefault:false,stopPropagation:false,run:((a=(l=h._any)===null||l===void 0?void 0:l.run)===null||a===void 0?void 0:a.slice())||[]});o&&u.run.push(o);n&&(u.preventDefault=true);r&&(u.stopPropagation=true)};for(let s of t){let t=s.scope?s.scope.split(" "):["editor"];if(s.any)for(let e of t){let t=i[e]||(i[e]=Object.create(null));t._any||(t._any={preventDefault:false,stopPropagation:false,run:[]});let{any:o}=s;for(let e in t)t[e].run.push((t=>o(t,he)))}let o=s[e]||s.key;if(o)for(let e of t){add(e,o,s.run,s.preventDefault,s.stopPropagation);s.shift&&add(e,"Shift-"+o,s.shift,s.preventDefault,s.stopPropagation)}}return i}let he=null;function runHandlers(t,e,i,s){he=e;let o=S(e);let n=g(o,0),r=m(n)==o.length&&o!=" ";let l="",a=false,h=false,c=false;if(le&&le.view==i&&le.scope==s){l=le.prefix+" ";if(Ot.indexOf(e.keyCode)<0){h=true;le=null}}let d=new Set;let runFor=t=>{if(t){for(let e of t.run)if(!d.has(e)){d.add(e);if(e(i)){t.stopPropagation&&(c=true);return true}}if(t.preventDefault){t.stopPropagation&&(c=true);h=true}}return false};let u,f,p=t[s];if(p){runFor(p[l+modifiers(o,e,!r)])?a=true:r&&(e.altKey||e.metaKey||e.ctrlKey)&&!(F.windows&&e.ctrlKey&&e.altKey)&&(u=M[e.keyCode])&&u!=o?(runFor(p[l+modifiers(u,e,true)])||e.shiftKey&&(f=C[e.keyCode])!=o&&f!=u&&runFor(p[l+modifiers(f,e,false)]))&&(a=true):r&&e.shiftKey&&runFor(p[l+modifiers(o,e,true)])&&(a=true);!a&&runFor(p._any)&&(a=true)}h&&(a=true);a&&c&&e.stopPropagation();he=null;return a}class RectangleMarker{constructor(t,e,i,s,o){this.className=t;this.left=e;this.top=i;this.width=s;this.height=o}draw(){let t=document.createElement("div");t.className=this.className;this.adjust(t);return t}update(t,e){if(e.className!=this.className)return false;this.adjust(t);return true}adjust(t){t.style.left=this.left+"px";t.style.top=this.top+"px";this.width!=null&&(t.style.width=this.width+"px");t.style.height=this.height+"px"}eq(t){return this.left==t.left&&this.top==t.top&&this.width==t.width&&this.height==t.height&&this.className==t.className}static forRange(t,e,i){if(i.empty){let s=t.coordsAtPos(i.head,i.assoc||1);if(!s)return[];let o=getBase(t);return[new RectangleMarker(e,s.left-o.left,s.top-o.top,null,s.bottom-s.top)]}return rectanglesForRange(t,e,i)}}function getBase(t){let e=t.scrollDOM.getBoundingClientRect();let i=t.textDirection==K.LTR?e.left:e.right-t.scrollDOM.clientWidth*t.scaleX;return{left:i-t.scrollDOM.scrollLeft*t.scaleX,top:e.top-t.scrollDOM.scrollTop*t.scaleY}}function wrappedLine(t,e,i,s){let o=t.coordsAtPos(e,i*2);if(!o)return s;let n=t.dom.getBoundingClientRect();let r=(o.top+o.bottom)/2;let l=t.posAtCoords({x:n.left+1,y:r});let a=t.posAtCoords({x:n.right-1,y:r});return l==null||a==null?s:{from:Math.max(s.from,Math.min(l,a)),to:Math.min(s.to,Math.max(l,a))}}function rectanglesForRange(t,e,i){if(i.to<=t.viewport.from||i.from>=t.viewport.to)return[];let s=Math.max(i.from,t.viewport.from),o=Math.min(i.to,t.viewport.to);let n=t.textDirection==K.LTR;let r=t.contentDOM,l=r.getBoundingClientRect(),a=getBase(t);let h=r.querySelector(".cm-line"),c=h&&window.getComputedStyle(h);let d=l.left+(c?parseInt(c.paddingLeft)+Math.min(0,parseInt(c.textIndent)):0);let u=l.right-(c?parseInt(c.paddingRight):0);let f=blockAt(t,s),p=blockAt(t,o);let g=f.type==q.Text?f:null;let m=p.type==q.Text?p:null;g&&(t.lineWrapping||f.widgetLineBreaks)&&(g=wrappedLine(t,s,1,g));m&&(t.lineWrapping||p.widgetLineBreaks)&&(m=wrappedLine(t,o,-1,m));if(g&&m&&g.from==m.from&&g.to==m.to)return pieces(drawForLine(i.from,i.to,g));{let e=g?drawForLine(i.from,null,g):drawForWidget(f,false);let s=m?drawForLine(null,i.to,m):drawForWidget(p,true);let o=[];(g||f).to<(m||p).from-(g&&m?1:0)||f.widgetLineBreaks>1&&e.bottom+t.defaultLineHeight/2<s.top?o.push(piece(d,e.bottom,u,s.top)):e.bottom<s.top&&t.elementAtHeight((e.bottom+s.top)/2).type==q.Text&&(e.bottom=s.top=(e.bottom+s.top)/2);return pieces(e).concat(o).concat(pieces(s))}function piece(t,i,s,o){return new RectangleMarker(e,t-a.left,i-a.top-.01,s-t,o-i+.01)}function pieces({top:t,bottom:e,horizontal:i}){let s=[];for(let o=0;o<i.length;o+=2)s.push(piece(i[o],t,i[o+1],e));return s}function drawForLine(e,i,s){let o=1e9,r=-1e9,l=[];function addSpan(e,i,a,h,c){let f=t.coordsAtPos(e,e==s.to?-2:2);let p=t.coordsAtPos(a,a==s.from?2:-2);if(f&&p){o=Math.min(f.top,p.top,o);r=Math.max(f.bottom,p.bottom,r);c==K.LTR?l.push(n&&i?d:f.left,n&&h?u:p.right):l.push(!n&&h?d:p.left,!n&&i?u:f.right)}}let a=e!==null&&e!==void 0?e:s.from,h=i!==null&&i!==void 0?i:s.to;for(let s of t.visibleRanges)if(s.to>a&&s.from<h)for(let o=Math.max(s.from,a),n=Math.min(s.to,h);;){let s=t.state.doc.lineAt(o);for(let r of t.bidiSpans(s)){let t=r.from+s.from,l=r.to+s.from;if(t>=n)break;l>o&&addSpan(Math.max(t,o),e==null&&t<=a,Math.min(l,n),i==null&&l>=h,r.dir)}o=s.to+1;if(o>=n)break}l.length==0&&addSpan(a,e==null,h,i==null,t.textDirection);return{top:o,bottom:r,horizontal:l}}function drawForWidget(t,e){let i=l.top+(e?t.top:t.bottom);return{top:i,bottom:i,horizontal:[]}}}function sameMarker(t,e){return t.constructor==e.constructor&&t.eq(e)}class LayerView{constructor(t,e){this.view=t;this.layer=e;this.drawn=[];this.scaleX=1;this.scaleY=1;this.measureReq={read:this.measure.bind(this),write:this.draw.bind(this)};this.dom=t.scrollDOM.appendChild(document.createElement("div"));this.dom.classList.add("cm-layer");e.above&&this.dom.classList.add("cm-layer-above");e.class&&this.dom.classList.add(e.class);this.scale();this.dom.setAttribute("aria-hidden","true");this.setOrder(t.state);t.requestMeasure(this.measureReq);e.mount&&e.mount(this.dom,t)}update(t){t.startState.facet(ce)!=t.state.facet(ce)&&this.setOrder(t.state);if(this.layer.update(t,this.dom)||t.geometryChanged){this.scale();t.view.requestMeasure(this.measureReq)}}docViewUpdate(t){this.layer.updateOnDocViewUpdate!==false&&t.requestMeasure(this.measureReq)}setOrder(t){let e=0,i=t.facet(ce);while(e<i.length&&i[e]!=this.layer)e++;this.dom.style.zIndex=String((this.layer.above?150:-1)-e)}measure(){return this.layer.markers(this.view)}scale(){let{scaleX:t,scaleY:e}=this.view;if(t!=this.scaleX||e!=this.scaleY){this.scaleX=t;this.scaleY=e;this.dom.style.transform=`scale(${1/t}, ${1/e})`}}draw(t){if(t.length!=this.drawn.length||t.some(((t,e)=>!sameMarker(t,this.drawn[e])))){let e=this.dom.firstChild,i=0;for(let s of t)if(s.update&&e&&s.constructor&&this.drawn[i].constructor&&s.update(e,this.drawn[i])){e=e.nextSibling;i++}else this.dom.insertBefore(s.draw(),e);while(e){let t=e.nextSibling;e.remove();e=t}this.drawn=t}}destroy(){this.layer.destroy&&this.layer.destroy(this.dom,this.view);this.dom.remove()}}const ce=r.define();function layer(t){return[ViewPlugin.define((e=>new LayerView(e,t))),ce.of(t)]}const de=!F.ios;const ue=r.define({combine(t){return w(t,{cursorBlinkRate:1200,drawRangeCursor:true},{cursorBlinkRate:(t,e)=>Math.min(t,e),drawRangeCursor:(t,e)=>t||e})}});function drawSelection(t={}){return[ue.of(t),fe,pe,me,ht.of(true)]}function getDrawSelectionConfig(t){return t.facet(ue)}function configChanged(t){return t.startState.facet(ue)!=t.state.facet(ue)}const fe=layer({above:true,markers(t){let{state:e}=t,i=e.facet(ue);let s=[];for(let o of e.selection.ranges){let r=o==e.selection.main;if(o.empty?!r||de:i.drawRangeCursor){let e=r?"cm-cursor cm-cursor-primary":"cm-cursor cm-cursor-secondary";let i=o.empty?o:n.cursor(o.head,o.head>o.anchor?-1:1);for(let o of RectangleMarker.forRange(t,e,i))s.push(o)}}return s},update(t,e){t.transactions.some((t=>t.selection))&&(e.style.animationName=e.style.animationName=="cm-blink"?"cm-blink2":"cm-blink");let i=configChanged(t);i&&setBlinkRate(t.state,e);return t.docChanged||t.selectionSet||i},mount(t,e){setBlinkRate(e.state,t)},class:"cm-cursorLayer"});function setBlinkRate(t,e){e.style.animationDuration=t.facet(ue).cursorBlinkRate+"ms"}const pe=layer({above:false,markers(t){return t.state.selection.ranges.map((e=>e.empty?[]:RectangleMarker.forRange(t,"cm-selectionBackground",e))).reduce(((t,e)=>t.concat(e)))},update(t,e){return t.docChanged||t.selectionSet||t.viewportChanged||configChanged(t)},class:"cm-selectionLayer"});const ge={".cm-line":{"& ::selection, &::selection":{backgroundColor:"transparent !important"}},".cm-content":{"& :focus":{caretColor:"initial !important","&::selection, & ::selection":{backgroundColor:"Highlight !important"}}}};de&&(ge[".cm-line"].caretColor=ge[".cm-content"].caretColor="transparent !important");const me=p.highest(EditorView.theme(ge));const we=l.define({map(t,e){return t==null?null:e.mapPos(t)}});const ve=v.define({create(){return null},update(t,e){t!=null&&(t=e.changes.mapPos(t));return e.effects.reduce(((t,e)=>e.is(we)?e.value:t),t)}});const be=ViewPlugin.fromClass(class{constructor(t){this.view=t;this.cursor=null;this.measureReq={read:this.readPos.bind(this),write:this.drawCursor.bind(this)}}update(t){var e;let i=t.state.field(ve);if(i==null){if(this.cursor!=null){(e=this.cursor)===null||e===void 0?void 0:e.remove();this.cursor=null}}else{if(!this.cursor){this.cursor=this.view.scrollDOM.appendChild(document.createElement("div"));this.cursor.className="cm-dropCursor"}(t.startState.field(ve)!=i||t.docChanged||t.geometryChanged)&&this.view.requestMeasure(this.measureReq)}}readPos(){let{view:t}=this;let e=t.state.field(ve);let i=e!=null&&t.coordsAtPos(e);if(!i)return null;let s=t.scrollDOM.getBoundingClientRect();return{left:i.left-s.left+t.scrollDOM.scrollLeft*t.scaleX,top:i.top-s.top+t.scrollDOM.scrollTop*t.scaleY,height:i.bottom-i.top}}drawCursor(t){if(this.cursor){let{scaleX:e,scaleY:i}=this.view;if(t){this.cursor.style.left=t.left/e+"px";this.cursor.style.top=t.top/i+"px";this.cursor.style.height=t.height/i+"px"}else this.cursor.style.left="-100000px"}}destroy(){this.cursor&&this.cursor.remove()}setDropPos(t){this.view.state.field(ve)!=t&&this.view.dispatch({effects:we.of(t)})}},{eventObservers:{dragover(t){this.setDropPos(this.view.posAtCoords({x:t.clientX,y:t.clientY}))},dragleave(t){t.target!=this.view.contentDOM&&this.view.contentDOM.contains(t.relatedTarget)||this.setDropPos(null)},dragend(){this.setDropPos(null)},drop(){this.setDropPos(null)}}});function dropCursor(){return[ve,be]}function iterMatches(t,e,i,s,o){e.lastIndex=0;for(let n,r=t.iterRange(i,s),l=i;!r.next().done;l+=r.value.length)if(!r.lineBreak)while(n=e.exec(r.value))o(l+n.index,n)}function matchRanges(t,e){let i=t.visibleRanges;if(i.length==1&&i[0].from==t.viewport.from&&i[0].to==t.viewport.to)return i;let s=[];for(let{from:o,to:n}of i){o=Math.max(t.state.doc.lineAt(o).from,o-e);n=Math.min(t.state.doc.lineAt(n).to,n+e);s.length&&s[s.length-1].to>=o?s[s.length-1].to=n:s.push({from:o,to:n})}return s}class MatchDecorator{constructor(t){const{regexp:e,decoration:i,decorate:s,boundary:o,maxLength:n=1e3}=t;if(!e.global)throw new RangeError("The regular expression given to MatchDecorator should have its 'g' flag set");this.regexp=e;if(s)this.addMatch=(t,e,i,o)=>s(o,i,i+t[0].length,t,e);else if(typeof i=="function")this.addMatch=(t,e,s,o)=>{let n=i(t,e,s);n&&o(s,s+t[0].length,n)};else{if(!i)throw new RangeError("Either 'decorate' or 'decoration' should be provided to MatchDecorator");this.addMatch=(t,e,s,o)=>o(s,s+t[0].length,i)}this.boundary=o;this.maxLength=n}createDeco(t){let e=new b,i=e.add.bind(e);for(let{from:e,to:s}of matchRanges(t,this.maxLength))iterMatches(t.state.doc,this.regexp,e,s,((e,s)=>this.addMatch(s,t,e,i)));return e.finish()}updateDeco(t,e){let i=1e9,s=-1;t.docChanged&&t.changes.iterChanges(((e,o,n,r)=>{if(r>t.view.viewport.from&&n<t.view.viewport.to){i=Math.min(n,i);s=Math.max(r,s)}}));return t.viewportChanged||s-i>1e3?this.createDeco(t.view):s>-1?this.updateRange(t.view,e.map(t.changes),i,s):e}updateRange(t,e,i,s){for(let o of t.visibleRanges){let n=Math.max(o.from,i),r=Math.min(o.to,s);if(r>n){let i=t.state.doc.lineAt(n),s=i.to<r?t.state.doc.lineAt(r):i;let l=Math.max(o.from,i.from),a=Math.min(o.to,s.to);if(this.boundary){for(;n>i.from;n--)if(this.boundary.test(i.text[n-1-i.from])){l=n;break}for(;r<s.to;r++)if(this.boundary.test(s.text[r-s.from])){a=r;break}}let h,c=[];let add=(t,e,i)=>c.push(i.range(t,e));if(i==s){this.regexp.lastIndex=l-i.from;while((h=this.regexp.exec(i.text))&&h.index<a-i.from)this.addMatch(h,t,h.index+i.from,add)}else iterMatches(t.state.doc,this.regexp,l,a,((e,i)=>this.addMatch(i,t,e,add)));e=e.update({filterFrom:l,filterTo:a,filter:(t,e)=>t<l||e>a,add:c})}}return e}}const ye=/x/.unicode!=null?"gu":"g";const xe=new RegExp("[\0-\b\n--\u2028\u2029\ufeff-]",ye);const Se={0:"null",7:"bell",8:"backspace",10:"newline",11:"vertical tab",13:"carriage return",27:"escape",8203:"zero width space",8204:"zero width non-joiner",8205:"zero width joiner",8206:"left-to-right mark",8207:"right-to-left mark",8232:"line separator",8237:"left-to-right override",8238:"right-to-left override",8294:"left-to-right isolate",8295:"right-to-left isolate",8297:"pop directional isolate",8233:"paragraph separator",65279:"zero width no-break space",65532:"object replacement"};let Me=null;function supportsTabSize(){var t;if(Me==null&&typeof document!="undefined"&&document.body){let e=document.body.style;Me=((t=e.tabSize)!==null&&t!==void 0?t:e.MozTabSize)!=null}return Me||false}const Ce=r.define({combine(t){let e=w(t,{render:null,specialChars:xe,addSpecialChars:null});(e.replaceTabs=!supportsTabSize())&&(e.specialChars=new RegExp("\t|"+e.specialChars.source,ye));e.addSpecialChars&&(e.specialChars=new RegExp(e.specialChars.source+"|"+e.addSpecialChars.source,ye));return e}});function highlightSpecialChars(t={}){return[Ce.of(t),specialCharPlugin()]}let ke=null;function specialCharPlugin(){return ke||(ke=ViewPlugin.fromClass(class{constructor(t){this.view=t;this.decorations=Decoration.none;this.decorationCache=Object.create(null);this.decorator=this.makeDecorator(t.state.facet(Ce));this.decorations=this.decorator.createDeco(t)}makeDecorator(t){return new MatchDecorator({regexp:t.specialChars,decoration:(e,i,s)=>{let{doc:o}=i.state;let n=g(e[0],0);if(n==9){let t=o.lineAt(s);let e=i.state.tabSize,n=y(t.text,e,s-t.from);return Decoration.replace({widget:new TabWidget((e-n%e)*this.view.defaultCharacterWidth/this.view.scaleX)})}return this.decorationCache[n]||(this.decorationCache[n]=Decoration.replace({widget:new SpecialCharWidget(t,n)}))},boundary:t.replaceTabs?void 0:/[^]/})}update(t){let e=t.state.facet(Ce);if(t.startState.facet(Ce)!=e){this.decorator=this.makeDecorator(e);this.decorations=this.decorator.createDeco(t.view)}else this.decorations=this.decorator.updateDeco(t,this.decorations)}},{decorations:t=>t.decorations}))}const Ae="";function placeholder$1(t){return t>=32?Ae:t==10?"":String.fromCharCode(9216+t)}class SpecialCharWidget extends WidgetType{constructor(t,e){super();this.options=t;this.code=e}eq(t){return t.code==this.code}toDOM(t){let e=placeholder$1(this.code);let i=t.state.phrase("Control character")+" "+(Se[this.code]||"0x"+this.code.toString(16));let s=this.options.render&&this.options.render(this.code,i,e);if(s)return s;let o=document.createElement("span");o.textContent=e;o.title=i;o.setAttribute("aria-label",i);o.className="cm-specialChar";return o}ignoreEvent(){return false}}class TabWidget extends WidgetType{constructor(t){super();this.width=t}eq(t){return t.width==this.width}toDOM(){let t=document.createElement("span");t.textContent="\t";t.className="cm-tab";t.style.width=this.width+"px";return t}ignoreEvent(){return false}}const De=ViewPlugin.fromClass(class{constructor(){this.height=1e3;this.attrs={style:"padding-bottom: 1000px"}}update(t){let{view:e}=t;let i=e.viewState.editorHeight-e.defaultLineHeight-e.documentPadding.top-.5;if(i>=0&&i!=this.height){this.height=i;this.attrs={style:`padding-bottom: ${i}px`}}}});function scrollPastEnd(){return[De,wt.of((t=>{var e;return((e=t.plugin(De))===null||e===void 0?void 0:e.attrs)||null}))]}function highlightActiveLine(){return Te}const Oe=Decoration.line({class:"cm-activeLine"});const Te=ViewPlugin.fromClass(class{constructor(t){this.decorations=this.getDeco(t)}update(t){(t.docChanged||t.selectionSet)&&(this.decorations=this.getDeco(t.view))}getDeco(t){let e=-1,i=[];for(let s of t.state.selection.ranges){let o=t.lineBlockAt(s.head);if(o.from>e){i.push(Oe.range(o.from));e=o.from}}return Decoration.set(i)}},{decorations:t=>t.decorations});class Placeholder extends WidgetType{constructor(t){super();this.content=t}toDOM(t){let e=document.createElement("span");e.className="cm-placeholder";e.style.pointerEvents="none";e.appendChild(typeof this.content=="string"?document.createTextNode(this.content):typeof this.content=="function"?this.content(t):this.content.cloneNode(true));typeof this.content=="string"?e.setAttribute("aria-label","placeholder "+this.content):e.setAttribute("aria-hidden","true");return e}coordsAt(t){let e=t.firstChild?clientRectsFor(t.firstChild):[];if(!e.length)return null;let i=window.getComputedStyle(t.parentNode);let s=flattenRect(e[0],i.direction!="rtl");let o=parseInt(i.lineHeight);return s.bottom-s.top>o*1.5?{left:s.left,right:s.right,top:s.top,bottom:s.top+o}:s}ignoreEvent(){return false}}function placeholder(t){return ViewPlugin.fromClass(class{constructor(e){this.view=e;this.placeholder=t?Decoration.set([Decoration.widget({widget:new Placeholder(t),side:1}).range(0)]):Decoration.none}get decorations(){return this.view.state.doc.length?Decoration.none:this.placeholder}},{decorations:t=>t.decorations})}const Re=2e3;function rectangleFor(t,e,i){let s=Math.min(e.line,i.line),o=Math.max(e.line,i.line);let r=[];if(e.off>Re||i.off>Re||e.col<0||i.col<0){let l=Math.min(e.off,i.off),a=Math.max(e.off,i.off);for(let e=s;e<=o;e++){let i=t.doc.line(e);i.length<=a&&r.push(n.range(i.from+l,i.to+a))}}else{let l=Math.min(e.col,i.col),a=Math.max(e.col,i.col);for(let e=s;e<=o;e++){let i=t.doc.line(e);let s=h(i.text,l,t.tabSize,true);if(s<0)r.push(n.cursor(i.to));else{let e=h(i.text,a,t.tabSize);r.push(n.range(i.from+s,i.from+e))}}}return r}function absoluteColumn(t,e){let i=t.coordsAtPos(t.viewport.from);return i?Math.round(Math.abs((i.left-e)/t.defaultCharacterWidth)):-1}function getPos(t,e){let i=t.posAtCoords({x:e.clientX,y:e.clientY},false);let s=t.state.doc.lineAt(i),o=i-s.from;let n=o>Re?-1:o==s.length?absoluteColumn(t,e.clientX):y(s.text,t.state.tabSize,i-s.from);return{line:s.number,col:n,off:o}}function rectangleSelectionStyle(t,e){let i=getPos(t,e),s=t.state.selection;return i?{update(t){if(t.docChanged){let e=t.changes.mapPos(t.startState.doc.line(i.line).from);let o=t.state.doc.lineAt(e);i={line:o.number,col:i.col,off:Math.min(i.off,o.length)};s=s.map(t.changes)}},get(e,o,r){let l=getPos(t,e);if(!l)return s;let a=rectangleFor(t.state,i,l);return a.length?r?n.create(a.concat(s.ranges)):n.create(a):s}}:null}function rectangularSelection(t){let e=(t===null||t===void 0?void 0:t.eventFilter)||(t=>t.altKey&&t.button==0);return EditorView.mouseSelectionStyle.of(((t,i)=>e(i)?rectangleSelectionStyle(t,i):null))}const Ee={Alt:[18,t=>!!t.altKey],Control:[17,t=>!!t.ctrlKey],Shift:[16,t=>!!t.shiftKey],Meta:[91,t=>!!t.metaKey]};const Ve={style:"cursor: crosshair"};function crosshairCursor(t={}){let[e,i]=Ee[t.key||"Alt"];let s=ViewPlugin.fromClass(class{constructor(t){this.view=t;this.isDown=false}set(t){if(this.isDown!=t){this.isDown=t;this.view.update([])}}},{eventObservers:{keydown(t){this.set(t.keyCode==e||i(t))},keyup(t){t.keyCode!=e&&i(t)||this.set(false)},mousemove(t){this.set(i(t))}}});return[s,EditorView.contentAttributes.of((t=>{var e;return((e=t.plugin(s))===null||e===void 0?void 0:e.isDown)?Ve:null}))]}const Be="-10000px";class TooltipViewManager{constructor(t,e,i,s){this.facet=e;this.createTooltipView=i;this.removeTooltipView=s;this.input=t.state.facet(e);this.tooltips=this.input.filter((t=>t));let o=null;this.tooltipViews=this.tooltips.map((t=>o=i(t,o)))}update(t,e){var i;let s=t.state.facet(this.facet);let o=s.filter((t=>t));if(s===this.input){for(let e of this.tooltipViews)e.update&&e.update(t);return false}let n=[],r=e?[]:null;for(let i=0;i<o.length;i++){let s=o[i],l=-1;if(s){for(let t=0;t<this.tooltips.length;t++){let e=this.tooltips[t];e&&e.create==s.create&&(l=t)}if(l<0){n[i]=this.createTooltipView(s,i?n[i-1]:null);r&&(r[i]=!!s.above)}else{let s=n[i]=this.tooltipViews[l];r&&(r[i]=e[l]);s.update&&s.update(t)}}}for(let t of this.tooltipViews)if(n.indexOf(t)<0){this.removeTooltipView(t);(i=t.destroy)===null||i===void 0?void 0:i.call(t)}if(e){r.forEach(((t,i)=>e[i]=t));e.length=r.length}this.input=s;this.tooltips=o;this.tooltipViews=n;return true}}function tooltips(t={}){return Pe.of(t)}function windowSpace(t){let{win:e}=t;return{top:0,left:0,bottom:e.innerHeight,right:e.innerWidth}}const Pe=r.define({combine:t=>{var e,i,s;return{position:F.ios?"absolute":((e=t.find((t=>t.position)))===null||e===void 0?void 0:e.position)||"fixed",parent:((i=t.find((t=>t.parent)))===null||i===void 0?void 0:i.parent)||null,tooltipSpace:((s=t.find((t=>t.tooltipSpace)))===null||s===void 0?void 0:s.tooltipSpace)||windowSpace}}});const Le=new WeakMap;const He=ViewPlugin.fromClass(class{constructor(t){this.view=t;this.above=[];this.inView=true;this.madeAbsolute=false;this.lastTransaction=0;this.measureTimeout=-1;let e=t.state.facet(Pe);this.position=e.position;this.parent=e.parent;this.classes=t.themeClasses;this.createContainer();this.measureReq={read:this.readMeasure.bind(this),write:this.writeMeasure.bind(this),key:this};this.resizeObserver=typeof ResizeObserver=="function"?new ResizeObserver((()=>this.measureSoon())):null;this.manager=new TooltipViewManager(t,Fe,((t,e)=>this.createTooltip(t,e)),(t=>{this.resizeObserver&&this.resizeObserver.unobserve(t.dom);t.dom.remove()}));this.above=this.manager.tooltips.map((t=>!!t.above));this.intersectionObserver=typeof IntersectionObserver=="function"?new IntersectionObserver((t=>{Date.now()>this.lastTransaction-50&&t.length>0&&t[t.length-1].intersectionRatio<1&&this.measureSoon()}),{threshold:[1]}):null;this.observeIntersection();t.win.addEventListener("resize",this.measureSoon=this.measureSoon.bind(this));this.maybeMeasure()}createContainer(){if(this.parent){this.container=document.createElement("div");this.container.style.position="relative";this.container.className=this.view.themeClasses;this.parent.appendChild(this.container)}else this.container=this.view.dom}observeIntersection(){if(this.intersectionObserver){this.intersectionObserver.disconnect();for(let t of this.manager.tooltipViews)this.intersectionObserver.observe(t.dom)}}measureSoon(){this.measureTimeout<0&&(this.measureTimeout=setTimeout((()=>{this.measureTimeout=-1;this.maybeMeasure()}),50))}update(t){t.transactions.length&&(this.lastTransaction=Date.now());let e=this.manager.update(t,this.above);e&&this.observeIntersection();let i=e||t.geometryChanged;let s=t.state.facet(Pe);if(s.position!=this.position&&!this.madeAbsolute){this.position=s.position;for(let t of this.manager.tooltipViews)t.dom.style.position=this.position;i=true}if(s.parent!=this.parent){this.parent&&this.container.remove();this.parent=s.parent;this.createContainer();for(let t of this.manager.tooltipViews)this.container.appendChild(t.dom);i=true}else this.parent&&this.view.themeClasses!=this.classes&&(this.classes=this.container.className=this.view.themeClasses);i&&this.maybeMeasure()}createTooltip(t,e){let i=t.create(this.view);let s=e?e.dom:null;i.dom.classList.add("cm-tooltip");if(t.arrow&&!i.dom.querySelector(".cm-tooltip > .cm-tooltip-arrow")){let t=document.createElement("div");t.className="cm-tooltip-arrow";i.dom.appendChild(t)}i.dom.style.position=this.position;i.dom.style.top=Be;i.dom.style.left="0px";this.container.insertBefore(i.dom,s);i.mount&&i.mount(this.view);this.resizeObserver&&this.resizeObserver.observe(i.dom);return i}destroy(){var t,e,i;this.view.win.removeEventListener("resize",this.measureSoon);for(let e of this.manager.tooltipViews){e.dom.remove();(t=e.destroy)===null||t===void 0?void 0:t.call(e)}this.parent&&this.container.remove();(e=this.resizeObserver)===null||e===void 0?void 0:e.disconnect();(i=this.intersectionObserver)===null||i===void 0?void 0:i.disconnect();clearTimeout(this.measureTimeout)}readMeasure(){let t=1,e=1,i=false;if(this.position=="fixed"&&this.manager.tooltipViews.length){let{dom:t}=this.manager.tooltipViews[0];if(F.gecko)i=t.offsetParent!=this.container.ownerDocument.body;else if(t.style.top==Be&&t.style.left=="0px"){let e=t.getBoundingClientRect();i=Math.abs(e.top+1e4)>1||Math.abs(e.left)>1}}if(i||this.position=="absolute")if(this.parent){let i=this.parent.getBoundingClientRect();if(i.width&&i.height){t=i.width/this.parent.offsetWidth;e=i.height/this.parent.offsetHeight}}else({scaleX:t,scaleY:e}=this.view.viewState);let s=this.view.scrollDOM.getBoundingClientRect(),o=getScrollMargins(this.view);return{visible:{left:s.left+o.left,top:s.top+o.top,right:s.right-o.right,bottom:s.bottom-o.bottom},parent:this.parent?this.container.getBoundingClientRect():this.view.dom.getBoundingClientRect(),pos:this.manager.tooltips.map(((t,e)=>{let i=this.manager.tooltipViews[e];return i.getCoords?i.getCoords(t.pos):this.view.coordsAtPos(t.pos)})),size:this.manager.tooltipViews.map((({dom:t})=>t.getBoundingClientRect())),space:this.view.state.facet(Pe).tooltipSpace(this.view),scaleX:t,scaleY:e,makeAbsolute:i}}writeMeasure(t){var e;if(t.makeAbsolute){this.madeAbsolute=true;this.position="absolute";for(let t of this.manager.tooltipViews)t.dom.style.position="absolute"}let{visible:i,space:s,scaleX:o,scaleY:n}=t;let r=[];for(let l=0;l<this.manager.tooltips.length;l++){let a=this.manager.tooltips[l],h=this.manager.tooltipViews[l],{dom:c}=h;let d=t.pos[l],u=t.size[l];if(!d||a.clip!==false&&(d.bottom<=Math.max(i.top,s.top)||d.top>=Math.min(i.bottom,s.bottom)||d.right<Math.max(i.left,s.left)-.1||d.left>Math.min(i.right,s.right)+.1)){c.style.top=Be;continue}let f=a.arrow?h.dom.querySelector(".cm-tooltip-arrow"):null;let p=f?7:0;let g=u.right-u.left,m=(e=Le.get(h))!==null&&e!==void 0?e:u.bottom-u.top;let w=h.offset||We,v=this.view.textDirection==K.LTR;let b=u.width>s.right-s.left?v?s.left:s.right-u.width:v?Math.max(s.left,Math.min(d.left-(f?14:0)+w.x,s.right-g)):Math.min(Math.max(s.left,d.left-g+(f?14:0)-w.x),s.right-g);let y=this.above[l];!a.strictSide&&(y?d.top-m-p-w.y<s.top:d.bottom+m+p+w.y>s.bottom)&&y==s.bottom-d.bottom>d.top-s.top&&(y=this.above[l]=!y);let x=(y?d.top-s.top:s.bottom-d.bottom)-p;if(x<m&&h.resize!==false){if(x<this.view.defaultLineHeight){c.style.top=Be;continue}Le.set(h,m);c.style.height=(m=x)/n+"px"}else c.style.height&&(c.style.height="");let S=y?d.top-m-p-w.y:d.bottom+p+w.y;let M=b+g;if(h.overlap!==true)for(let t of r)t.left<M&&t.right>b&&t.top<S+m&&t.bottom>S&&(S=y?t.top-m-2-p:t.bottom+p+2);if(this.position=="absolute"){c.style.top=(S-t.parent.top)/n+"px";c.style.left=(b-t.parent.left)/o+"px"}else{c.style.top=S/n+"px";c.style.left=b/o+"px"}if(f){let t=d.left+(v?w.x:-w.x)-(b+14-7);f.style.left=t/o+"px"}h.overlap!==true&&r.push({left:b,top:S,right:M,bottom:S+m});c.classList.toggle("cm-tooltip-above",y);c.classList.toggle("cm-tooltip-below",!y);h.positioned&&h.positioned(t.space)}}maybeMeasure(){if(this.manager.tooltips.length){this.view.inView&&this.view.requestMeasure(this.measureReq);if(this.inView!=this.view.inView){this.inView=this.view.inView;if(!this.inView)for(let t of this.manager.tooltipViews)t.dom.style.top=Be}}}},{eventObservers:{scroll(){this.maybeMeasure()}}});const Ne=EditorView.baseTheme({".cm-tooltip":{zIndex:500,boxSizing:"border-box"},"&light .cm-tooltip":{border:"1px solid #bbb",backgroundColor:"#f5f5f5"},"&light .cm-tooltip-section:not(:first-child)":{borderTop:"1px solid #bbb"},"&dark .cm-tooltip":{backgroundColor:"#333338",color:"white"},".cm-tooltip-arrow":{height:"7px",width:"14px",position:"absolute",zIndex:-1,overflow:"hidden","&:before, &:after":{content:"''",position:"absolute",width:0,height:0,borderLeft:"7px solid transparent",borderRight:"7px solid transparent"},".cm-tooltip-above &":{bottom:"-7px","&:before":{borderTop:"7px solid #bbb"},"&:after":{borderTop:"7px solid #f5f5f5",bottom:"1px"}},".cm-tooltip-below &":{top:"-7px","&:before":{borderBottom:"7px solid #bbb"},"&:after":{borderBottom:"7px solid #f5f5f5",top:"1px"}}},"&dark .cm-tooltip .cm-tooltip-arrow":{"&:before":{borderTopColor:"#333338",borderBottomColor:"#333338"},"&:after":{borderTopColor:"transparent",borderBottomColor:"transparent"}}});const We={x:0,y:0};const Fe=r.define({enables:[He,Ne]});const Ie=r.define({combine:t=>t.reduce(((t,e)=>t.concat(e)),[])});class HoverTooltipHost{static create(t){return new HoverTooltipHost(t)}constructor(t){this.view=t;this.mounted=false;this.dom=document.createElement("div");this.dom.classList.add("cm-tooltip-hover");this.manager=new TooltipViewManager(t,Ie,((t,e)=>this.createHostedView(t,e)),(t=>t.dom.remove()))}createHostedView(t,e){let i=t.create(this.view);i.dom.classList.add("cm-tooltip-section");this.dom.insertBefore(i.dom,e?e.dom.nextSibling:this.dom.firstChild);this.mounted&&i.mount&&i.mount(this.view);return i}mount(t){for(let e of this.manager.tooltipViews)e.mount&&e.mount(t);this.mounted=true}positioned(t){for(let e of this.manager.tooltipViews)e.positioned&&e.positioned(t)}update(t){this.manager.update(t)}destroy(){var t;for(let e of this.manager.tooltipViews)(t=e.destroy)===null||t===void 0?void 0:t.call(e)}passProp(t){let e;for(let i of this.manager.tooltipViews){let s=i[t];if(s!==void 0)if(e===void 0)e=s;else if(e!==s)return}return e}get offset(){return this.passProp("offset")}get getCoords(){return this.passProp("getCoords")}get overlap(){return this.passProp("overlap")}get resize(){return this.passProp("resize")}}const ze=Fe.compute([Ie],(t=>{let e=t.facet(Ie);return e.length===0?null:{pos:Math.min(...e.map((t=>t.pos))),end:Math.max(...e.map((t=>{var e;return(e=t.end)!==null&&e!==void 0?e:t.pos}))),create:HoverTooltipHost.create,above:e[0].above,arrow:e.some((t=>t.arrow))}}));class HoverPlugin{constructor(t,e,i,s,o){this.view=t;this.source=e;this.field=i;this.setHover=s;this.hoverTime=o;this.hoverTimeout=-1;this.restartTimeout=-1;this.pending=null;this.lastMove={x:0,y:0,target:t.dom,time:0};this.checkHover=this.checkHover.bind(this);t.dom.addEventListener("mouseleave",this.mouseleave=this.mouseleave.bind(this));t.dom.addEventListener("mousemove",this.mousemove=this.mousemove.bind(this))}update(){if(this.pending){this.pending=null;clearTimeout(this.restartTimeout);this.restartTimeout=setTimeout((()=>this.startHover()),20)}}get active(){return this.view.state.field(this.field)}checkHover(){this.hoverTimeout=-1;if(this.active.length)return;let t=Date.now()-this.lastMove.time;t<this.hoverTime?this.hoverTimeout=setTimeout(this.checkHover,this.hoverTime-t):this.startHover()}startHover(){clearTimeout(this.restartTimeout);let{view:t,lastMove:e}=this;let i=t.docView.nearest(e.target);if(!i)return;let s,o=1;if(i instanceof WidgetView)s=i.posAtStart;else{s=t.posAtCoords(e);if(s==null)return;let i=t.coordsAtPos(s);if(!i||e.y<i.top||e.y>i.bottom||e.x<i.left-t.defaultCharacterWidth||e.x>i.right+t.defaultCharacterWidth)return;let n=t.bidiSpans(t.state.doc.lineAt(s)).find((t=>t.from<=s&&t.to>=s));let r=n&&n.dir==K.RTL?-1:1;o=e.x<i.left?-r:r}let n=this.source(t,s,o);if(n===null||n===void 0?void 0:n.then){let e=this.pending={pos:s};n.then((i=>{if(this.pending==e){this.pending=null;!i||Array.isArray(i)&&!i.length||t.dispatch({effects:this.setHover.of(Array.isArray(i)?i:[i])})}}),(e=>logException(t.state,e,"hover tooltip")))}else!n||Array.isArray(n)&&!n.length||t.dispatch({effects:this.setHover.of(Array.isArray(n)?n:[n])})}get tooltip(){let t=this.view.plugin(He);let e=t?t.manager.tooltips.findIndex((t=>t.create==HoverTooltipHost.create)):-1;return e>-1?t.manager.tooltipViews[e]:null}mousemove(t){var e,i;this.lastMove={x:t.clientX,y:t.clientY,target:t.target,time:Date.now()};this.hoverTimeout<0&&(this.hoverTimeout=setTimeout(this.checkHover,this.hoverTime));let{active:s,tooltip:o}=this;if(s.length&&o&&!isInTooltip(o.dom,t)||this.pending){let{pos:o}=s[0]||this.pending,n=(i=(e=s[0])===null||e===void 0?void 0:e.end)!==null&&i!==void 0?i:o;if(o==n?this.view.posAtCoords(this.lastMove)!=o:!isOverRange(this.view,o,n,t.clientX,t.clientY)){this.view.dispatch({effects:this.setHover.of([])});this.pending=null}}}mouseleave(t){clearTimeout(this.hoverTimeout);this.hoverTimeout=-1;let{active:e}=this;if(e.length){let{tooltip:e}=this;let i=e&&e.dom.contains(t.relatedTarget);i?this.watchTooltipLeave(e.dom):this.view.dispatch({effects:this.setHover.of([])})}}watchTooltipLeave(t){let watch=e=>{t.removeEventListener("mouseleave",watch);this.active.length&&!this.view.dom.contains(e.relatedTarget)&&this.view.dispatch({effects:this.setHover.of([])})};t.addEventListener("mouseleave",watch)}destroy(){clearTimeout(this.hoverTimeout);this.view.dom.removeEventListener("mouseleave",this.mouseleave);this.view.dom.removeEventListener("mousemove",this.mousemove)}}const qe=4;function isInTooltip(t,e){let i,{left:s,right:o,top:n,bottom:r}=t.getBoundingClientRect();if(i=t.querySelector(".cm-tooltip-arrow")){let t=i.getBoundingClientRect();n=Math.min(t.top,n);r=Math.max(t.bottom,r)}return e.clientX>=s-qe&&e.clientX<=o+qe&&e.clientY>=n-qe&&e.clientY<=r+qe}function isOverRange(t,e,i,s,o,n){let r=t.scrollDOM.getBoundingClientRect();let l=t.documentTop+t.documentPadding.top+t.contentHeight;if(r.left>s||r.right<s||r.top>o||Math.min(r.bottom,l)<o)return false;let a=t.posAtCoords({x:s,y:o},false);return a>=e&&a<=i}function hoverTooltip(t,e={}){let i=l.define();let o=v.define({create(){return[]},update(t,o){if(t.length){e.hideOnChange&&(o.docChanged||o.selection)?t=[]:e.hideOn&&(t=t.filter((t=>!e.hideOn(o,t))));if(o.docChanged){let e=[];for(let i of t){let t=o.changes.mapPos(i.pos,-1,s.TrackDel);if(t!=null){let s=Object.assign(Object.create(null),i);s.pos=t;s.end!=null&&(s.end=o.changes.mapPos(s.end));e.push(s)}}t=e}}for(let e of o.effects){e.is(i)&&(t=e.value);e.is(Ke)&&(t=[])}return t},provide:t=>Ie.from(t)});return{active:o,extension:[o,ViewPlugin.define((s=>new HoverPlugin(s,t,o,i,e.hoverTime||300))),ze]}}function getTooltip(t,e){let i=t.plugin(He);if(!i)return null;let s=i.manager.tooltips.indexOf(e);return s<0?null:i.manager.tooltipViews[s]}function hasHoverTooltips(t){return t.facet(Ie).some((t=>t))}const Ke=l.define();const Ge=Ke.of(null);function repositionTooltips(t){let e=t.plugin(He);e&&e.maybeMeasure()}const Ye=r.define({combine(t){let e,i;for(let s of t){e=e||s.topContainer;i=i||s.bottomContainer}return{topContainer:e,bottomContainer:i}}});function panels(t){return t?[Ye.of(t)]:[]}function getPanel(t,e){let i=t.plugin(Xe);let s=i?i.specs.indexOf(e):-1;return s>-1?i.panels[s]:null}const Xe=ViewPlugin.fromClass(class{constructor(t){this.input=t.state.facet(je);this.specs=this.input.filter((t=>t));this.panels=this.specs.map((e=>e(t)));let e=t.state.facet(Ye);this.top=new PanelGroup(t,true,e.topContainer);this.bottom=new PanelGroup(t,false,e.bottomContainer);this.top.sync(this.panels.filter((t=>t.top)));this.bottom.sync(this.panels.filter((t=>!t.top)));for(let t of this.panels){t.dom.classList.add("cm-panel");t.mount&&t.mount()}}update(t){let e=t.state.facet(Ye);if(this.top.container!=e.topContainer){this.top.sync([]);this.top=new PanelGroup(t.view,true,e.topContainer)}if(this.bottom.container!=e.bottomContainer){this.bottom.sync([]);this.bottom=new PanelGroup(t.view,false,e.bottomContainer)}this.top.syncClasses();this.bottom.syncClasses();let i=t.state.facet(je);if(i!=this.input){let e=i.filter((t=>t));let s=[],o=[],n=[],r=[];for(let i of e){let e,l=this.specs.indexOf(i);if(l<0){e=i(t.view);r.push(e)}else{e=this.panels[l];e.update&&e.update(t)}s.push(e);(e.top?o:n).push(e)}this.specs=e;this.panels=s;this.top.sync(o);this.bottom.sync(n);for(let t of r){t.dom.classList.add("cm-panel");t.mount&&t.mount()}}else for(let e of this.panels)e.update&&e.update(t)}destroy(){this.top.sync([]);this.bottom.sync([])}},{provide:t=>EditorView.scrollMargins.of((e=>{let i=e.plugin(t);return i&&{top:i.top.scrollMargin(),bottom:i.bottom.scrollMargin()}}))});class PanelGroup{constructor(t,e,i){this.view=t;this.top=e;this.container=i;this.dom=void 0;this.classes="";this.panels=[];this.syncClasses()}sync(t){for(let e of this.panels)e.destroy&&t.indexOf(e)<0&&e.destroy();this.panels=t;this.syncDOM()}syncDOM(){if(this.panels.length==0){if(this.dom){this.dom.remove();this.dom=void 0}return}if(!this.dom){this.dom=document.createElement("div");this.dom.className=this.top?"cm-panels cm-panels-top":"cm-panels cm-panels-bottom";this.dom.style[this.top?"top":"bottom"]="0";let t=this.container||this.view.dom;t.insertBefore(this.dom,this.top?t.firstChild:null)}let t=this.dom.firstChild;for(let e of this.panels)if(e.dom.parentNode==this.dom){while(t!=e.dom)t=rm(t);t=t.nextSibling}else this.dom.insertBefore(e.dom,t);while(t)t=rm(t)}scrollMargin(){return!this.dom||this.container?0:Math.max(0,this.top?this.dom.getBoundingClientRect().bottom-Math.max(0,this.view.scrollDOM.getBoundingClientRect().top):Math.min(innerHeight,this.view.scrollDOM.getBoundingClientRect().bottom)-this.dom.getBoundingClientRect().top)}syncClasses(){if(this.container&&this.classes!=this.view.themeClasses){for(let t of this.classes.split(" "))t&&this.container.classList.remove(t);for(let t of(this.classes=this.view.themeClasses).split(" "))t&&this.container.classList.add(t)}}}function rm(t){let e=t.nextSibling;t.remove();return e}const je=r.define({enables:Xe});class GutterMarker extends e{compare(t){return this==t||this.constructor==t.constructor&&this.eq(t)}eq(t){return false}destroy(t){}}GutterMarker.prototype.elementClass="";GutterMarker.prototype.toDOM=void 0;GutterMarker.prototype.mapMode=s.TrackBefore;GutterMarker.prototype.startSide=GutterMarker.prototype.endSide=-1;GutterMarker.prototype.point=true;const Ue=r.define();const _e=r.define();const $e={class:"",renderEmptyElements:false,elementStyle:"",markers:()=>i.empty,lineMarker:()=>null,widgetMarker:()=>null,lineMarkerChange:null,initialSpacer:null,updateSpacer:null,domEventHandlers:{}};const Qe=r.define();function gutter(t){return[gutters(),Qe.of(Object.assign(Object.assign({},$e),t))]}const Je=r.define({combine:t=>t.some((t=>t))});function gutters(t){let e=[Ze];t&&t.fixed===false&&e.push(Je.of(true));return e}const Ze=ViewPlugin.fromClass(class{constructor(t){this.view=t;this.prevViewport=t.viewport;this.dom=document.createElement("div");this.dom.className="cm-gutters";this.dom.setAttribute("aria-hidden","true");this.dom.style.minHeight=this.view.contentHeight/this.view.scaleY+"px";this.gutters=t.state.facet(Qe).map((e=>new SingleGutterView(t,e)));for(let t of this.gutters)this.dom.appendChild(t.dom);this.fixed=!t.state.facet(Je);this.fixed&&(this.dom.style.position="sticky");this.syncGutters(false);t.scrollDOM.insertBefore(this.dom,t.contentDOM)}update(t){if(this.updateGutters(t)){let e=this.prevViewport,i=t.view.viewport;let s=Math.min(e.to,i.to)-Math.max(e.from,i.from);this.syncGutters(s<.8*(i.to-i.from))}t.geometryChanged&&(this.dom.style.minHeight=this.view.contentHeight/this.view.scaleY+"px");if(this.view.state.facet(Je)!=!this.fixed){this.fixed=!this.fixed;this.dom.style.position=this.fixed?"sticky":""}this.prevViewport=t.view.viewport}syncGutters(t){let e=this.dom.nextSibling;t&&this.dom.remove();let s=i.iter(this.view.state.facet(Ue),this.view.viewport.from);let o=[];let n=this.gutters.map((t=>new UpdateContext(t,this.view.viewport,-this.view.documentPadding.top)));for(let t of this.view.viewportLineBlocks){o.length&&(o=[]);if(Array.isArray(t.type)){let e=true;for(let i of t.type)if(i.type==q.Text&&e){advanceCursor(s,o,i.from);for(let t of n)t.line(this.view,i,o);e=false}else if(i.widget)for(let t of n)t.widget(this.view,i)}else if(t.type==q.Text){advanceCursor(s,o,t.from);for(let e of n)e.line(this.view,t,o)}else if(t.widget)for(let e of n)e.widget(this.view,t)}for(let t of n)t.finish();t&&this.view.scrollDOM.insertBefore(this.dom,e)}updateGutters(t){let e=t.startState.facet(Qe),s=t.state.facet(Qe);let o=t.docChanged||t.heightChanged||t.viewportChanged||!i.eq(t.startState.facet(Ue),t.state.facet(Ue),t.view.viewport.from,t.view.viewport.to);if(e==s)for(let e of this.gutters)e.update(t)&&(o=true);else{o=true;let i=[];for(let o of s){let s=e.indexOf(o);if(s<0)i.push(new SingleGutterView(this.view,o));else{this.gutters[s].update(t);i.push(this.gutters[s])}}for(let t of this.gutters){t.dom.remove();i.indexOf(t)<0&&t.destroy()}for(let t of i)this.dom.appendChild(t.dom);this.gutters=i}return o}destroy(){for(let t of this.gutters)t.destroy();this.dom.remove()}},{provide:t=>EditorView.scrollMargins.of((e=>{let i=e.plugin(t);return i&&i.gutters.length!=0&&i.fixed?e.textDirection==K.LTR?{left:i.dom.offsetWidth*e.scaleX}:{right:i.dom.offsetWidth*e.scaleX}:null}))});function asArray(t){return Array.isArray(t)?t:[t]}function advanceCursor(t,e,i){while(t.value&&t.from<=i){t.from==i&&e.push(t.value);t.next()}}class UpdateContext{constructor(t,e,s){this.gutter=t;this.height=s;this.i=0;this.cursor=i.iter(t.markers,e.from)}addElement(t,e,i){let{gutter:s}=this,o=(e.top-this.height)/t.scaleY,n=e.height/t.scaleY;if(this.i==s.elements.length){let e=new GutterElement(t,n,o,i);s.elements.push(e);s.dom.appendChild(e.dom)}else s.elements[this.i].update(t,n,o,i);this.height=e.bottom;this.i++}line(t,e,i){let s=[];advanceCursor(this.cursor,s,e.from);i.length&&(s=s.concat(i));let o=this.gutter.config.lineMarker(t,e,s);o&&s.unshift(o);let n=this.gutter;(s.length!=0||n.config.renderEmptyElements)&&this.addElement(t,e,s)}widget(t,e){let i=this.gutter.config.widgetMarker(t,e.widget,e),s=i?[i]:null;for(let i of t.state.facet(_e)){let o=i(t,e.widget,e);o&&(s||(s=[])).push(o)}s&&this.addElement(t,e,s)}finish(){let t=this.gutter;while(t.elements.length>this.i){let e=t.elements.pop();t.dom.removeChild(e.dom);e.destroy()}}}class SingleGutterView{constructor(t,e){this.view=t;this.config=e;this.elements=[];this.spacer=null;this.dom=document.createElement("div");this.dom.className="cm-gutter"+(this.config.class?" "+this.config.class:"");for(let i in e.domEventHandlers)this.dom.addEventListener(i,(s=>{let o,n=s.target;if(n!=this.dom&&this.dom.contains(n)){while(n.parentNode!=this.dom)n=n.parentNode;let t=n.getBoundingClientRect();o=(t.top+t.bottom)/2}else o=s.clientY;let r=t.lineBlockAtHeight(o-t.documentTop);e.domEventHandlers[i](t,r,s)&&s.preventDefault()}));this.markers=asArray(e.markers(t));if(e.initialSpacer){this.spacer=new GutterElement(t,0,0,[e.initialSpacer(t)]);this.dom.appendChild(this.spacer.dom);this.spacer.dom.style.cssText+="visibility: hidden; pointer-events: none"}}update(t){let e=this.markers;this.markers=asArray(this.config.markers(t.view));if(this.spacer&&this.config.updateSpacer){let e=this.config.updateSpacer(this.spacer.markers[0],t);e!=this.spacer.markers[0]&&this.spacer.update(t.view,0,0,[e])}let s=t.view.viewport;return!i.eq(this.markers,e,s.from,s.to)||!!this.config.lineMarkerChange&&this.config.lineMarkerChange(t)}destroy(){for(let t of this.elements)t.destroy()}}class GutterElement{constructor(t,e,i,s){this.height=-1;this.above=0;this.markers=[];this.dom=document.createElement("div");this.dom.className="cm-gutterElement";this.update(t,e,i,s)}update(t,e,i,s){if(this.height!=e){this.height=e;this.dom.style.height=e+"px"}this.above!=i&&(this.dom.style.marginTop=(this.above=i)?i+"px":"");sameMarkers(this.markers,s)||this.setMarkers(t,s)}setMarkers(t,e){let i="cm-gutterElement",s=this.dom.firstChild;for(let o=0,n=0;;){let r=n,l=o<e.length?e[o++]:null,a=false;if(l){let t=l.elementClass;t&&(i+=" "+t);for(let t=n;t<this.markers.length;t++)if(this.markers[t].compare(l)){r=t;a=true;break}}else r=this.markers.length;while(n<r){let t=this.markers[n++];if(t.toDOM){t.destroy(s);let e=s.nextSibling;s.remove();s=e}}if(!l)break;l.toDOM&&(a?s=s.nextSibling:this.dom.insertBefore(l.toDOM(t),s));a&&n++}this.dom.className=i;this.markers=e}destroy(){this.setMarkers(null,[])}}function sameMarkers(t,e){if(t.length!=e.length)return false;for(let i=0;i<t.length;i++)if(!t[i].compare(e[i]))return false;return true}const ti=r.define();const ei=r.define();const ii=r.define({combine(t){return w(t,{formatNumber:String,domEventHandlers:{}},{domEventHandlers(t,e){let i=Object.assign({},t);for(let t in e){let s=i[t],o=e[t];i[t]=s?(t,e,i)=>s(t,e,i)||o(t,e,i):o}return i}})}});class NumberMarker extends GutterMarker{constructor(t){super();this.number=t}eq(t){return this.number==t.number}toDOM(){return document.createTextNode(this.number)}}function formatNumber(t,e){return t.state.facet(ii).formatNumber(e,t.state)}const si=Qe.compute([ii],(t=>({class:"cm-lineNumbers",renderEmptyElements:false,markers(t){return t.state.facet(ti)},lineMarker(t,e,i){return i.some((t=>t.toDOM))?null:new NumberMarker(formatNumber(t,t.state.doc.lineAt(e.from).number))},widgetMarker:(t,e,i)=>{for(let s of t.state.facet(ei)){let o=s(t,e,i);if(o)return o}return null},lineMarkerChange:t=>t.startState.facet(ii)!=t.state.facet(ii),initialSpacer(t){return new NumberMarker(formatNumber(t,maxLineNumber(t.state.doc.lines)))},updateSpacer(t,e){let i=formatNumber(e.view,maxLineNumber(e.view.state.doc.lines));return i==t.number?t:new NumberMarker(i)},domEventHandlers:t.facet(ii).domEventHandlers})));function lineNumbers(t={}){return[ii.of(t),gutters(),si]}function maxLineNumber(t){let e=9;while(e<t)e=e*10+9;return e}const oi=new class extends GutterMarker{constructor(){super(...arguments);this.elementClass="cm-activeLineGutter"}};const ni=Ue.compute(["selection"],(t=>{let e=[],s=-1;for(let i of t.selection.ranges){let o=t.doc.lineAt(i.head).from;if(o>s){s=o;e.push(oi.range(o))}}return i.of(e)}));function highlightActiveLineGutter(){return ni}function matcher(t){return ViewPlugin.define((e=>({decorations:t.createDeco(e),update(e){this.decorations=t.updateDeco(e,this.decorations)}})),{decorations:t=>t.decorations})}const ri=Decoration.mark({class:"cm-highlightTab"});const li=Decoration.mark({class:"cm-highlightSpace"});const ai=matcher(new MatchDecorator({regexp:/\t| /g,decoration:t=>t[0]=="\t"?ri:li,boundary:/\S/}));function highlightWhitespace(){return ai}const hi=matcher(new MatchDecorator({regexp:/\s+$/g,decoration:Decoration.mark({class:"cm-trailingSpace"}),boundary:/\S/}));function highlightTrailingWhitespace(){return hi}const ci={HeightMap:HeightMap,HeightOracle:HeightOracle,MeasuredHeights:MeasuredHeights,QueryType:qt,ChangedRange:ChangedRange,computeOrder:computeOrder,moveVisually:moveVisually,clearHeightChangeFlag:clearHeightChangeFlag,getHeightChangeFlag:()=>zt};export{BidiSpan,BlockInfo,q as BlockType,Decoration,K as Direction,EditorView,GutterMarker,MatchDecorator,RectangleMarker,ViewPlugin,ViewUpdate,WidgetType,ci as __test,Ge as closeHoverTooltips,crosshairCursor,drawSelection,dropCursor,getDrawSelectionConfig,getPanel,getTooltip,gutter,Ue as gutterLineClass,_e as gutterWidgetClass,gutters,hasHoverTooltips,highlightActiveLine,highlightActiveLineGutter,highlightSpecialChars,highlightTrailingWhitespace,highlightWhitespace,hoverTooltip,ne as keymap,layer,ti as lineNumberMarkers,ei as lineNumberWidgetMarker,lineNumbers,logException,panels,placeholder,rectangularSelection,repositionTooltips,runScopeHandlers,scrollPastEnd,je as showPanel,Fe as showTooltip,tooltips};

