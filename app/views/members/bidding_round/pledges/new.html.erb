<h1><%= @bidding_round.title %></h1>

<section>
  <p class="mt-2"><%= @bidding_round.information_text %></p>

  <%= turbo_frame_tag "membership-pricing", type: "morph" do %>
    <% membership = @pledge.membership %>

    <div
      class="
        mt-8 flex-col rounded-sm border border-gray-200 p-2 px-4
        dark:border-gray-700
      "
      data-controller="hover"
      data-action="mouseenter->hover#show mouseleave->hover#hide"
      data-hover-id-value="<%= dom_id(membership) %>"
    >
      <div class="text-center text-xl whitespace-nowrap">
        <%= "#{Membership.model_name.human} #{membership.fiscal_year}" %>
      </div>

      <ul class="mt-4 w-full space-y-1">
        <li class="flex w-full flex-row flex-wrap items-center justify-between">
          <span class="font-light">
            <%= Basket.model_name.human(count: membership.baskets_count) %>
          </span>

          <span class="grow text-right tabular-nums">
            <%= display_price_description(@pledge.total_membership_baskets_price, "#{membership.baskets_count}x <span class=\"animate-highlight px-0.5 -mx-0.5 rounded\">#{precise_cur(@pledge.basket_size_price)}</span>".html_safe) %>
          </span>
        </li>

        <%= render "members/shared/membership_price_lines", membership: membership %>

        <li class="pt-1 text-right">
          <span class="w-full border-t border-gray-500 pt-1 tabular-nums">
            <%= cur(@pledge.total_membership_price, format: "%u %n") %>
          </span>
        </li>

        <% unless membership.billing_year_division == 1 %>
          <li class="pt-1.5 text-right">
            <span class="w-full text-sm text-gray-500 tabular-nums">
              <span class="mr-1">
                <%= t("billing.year_division.x#{membership.billing_year_division}") %>:
              </span>

              <%= cur(@pledge.total_membership_price / membership.billing_year_division.to_f, format: "%u %n") %>
            </span>
          </li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <%= form_for @pledge,
    url: members_bidding_round_pledge_path,
    method: :post,
    html: {
      class: "mt-8 flex flex-col",
      data: {
        controller: "price-range",
        price_range_default_price_value: @pledge.default_price
      }
    } do |f| %>
    <div class="input mb-2"><%= f.label :basket_size_price %></div>

    <div class="mb-4">
      <!-- Price range display (only over slider) -->
      <div class="mb-2 flex items-center justify-between text-sm text-gray-600">
        <span><%= cur(@pledge.min_allowed_price) %></span>
        <span><%= cur(@pledge.max_allowed_price) %></span>
      </div>

      <div class="flex items-center">
        <%= range_field_tag :basket_size_price_range, @pledge.basket_size_price,
          min: @pledge.min_allowed_price,
          max: @pledge.max_allowed_price,
          step: 0.05,
          class: "flex-1",
          data: {
            action: "price-range#syncFromRange",
            price_range_target: "range"
          } %>
      </div>
    </div>

    <div class="flex flex-wrap items-start justify-between gap-2">
      <%= button_tag t(".recommended_price", price: cur(@pledge.default_price)),
        type: "reset",
        disabled: @pledge.default_price == @pledge.basket_size_price,
        class: "btn btn-light btn-sm",
        data: {
          action: "price-range#setDefaultPrice",
          price_range_target: "reset"
        } %>

      <div class="ml-auto flex items-center gap-2">
        <span><%= currency_symbol %></span>

        <%= f.number_field :basket_size_price,
          value: precise_cur(@pledge.basket_size_price),
          min: @pledge.min_allowed_price,
          max: @pledge.max_allowed_price,
          step: 0.01,
          class: "w-24",
          required: true,
          data: {
            action: "price-range#syncFromInput",
            price_range_target: "input"
          } %>
      </div>
    </div>

    <div class="actions"><%= f.submit t(".submit") %></div>
  <% end %>
</section>
